# ğŸ” è®¾å¤‡éªŒè¯åŠŸèƒ½æµ‹è¯•æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å°ç¨‹åºç°åœ¨æ”¯æŒè®¾å¤‡ç»‘å®šéªŒè¯ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½åœ¨ç»‘å®šçš„è®¾å¤‡ä¸Šä½¿ç”¨ã€‚æ‰€æœ‰å°ç¨‹åºæ¥å£éƒ½éœ€è¦è®¾å¤‡æ ‡è¯†éªŒè¯ã€‚

## ğŸ”’ éªŒè¯æœºåˆ¶

### 1. ç™»å½•æ—¶è®¾å¤‡ç»‘å®š
- ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ï¼Œå¦‚æœæä¾›äº†`deviceId`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»‘å®šè¯¥è®¾å¤‡
- å¦‚æœç”¨æˆ·å·²æœ‰ç»‘å®šè®¾å¤‡ï¼Œä¼šéªŒè¯è®¾å¤‡æ ‡è¯†æ˜¯å¦åŒ¹é…
- è®¾å¤‡æ ‡è¯†ä¸åŒ¹é…æ—¶ï¼Œç™»å½•å¤±è´¥

### 2. æ¥å£è°ƒç”¨æ—¶è®¾å¤‡éªŒè¯
- æ‰€æœ‰éœ€è¦è®¤è¯çš„å°ç¨‹åºæ¥å£éƒ½ä¼šéªŒè¯è®¾å¤‡æ ‡è¯†
- å¿…é¡»åœ¨è¯·æ±‚å¤´ä¸­æä¾›`X-Device-Id`
- è®¾å¤‡æ ‡è¯†å¿…é¡»ä¸tokenä¸­çš„è®¾å¤‡ä¿¡æ¯ä¸€è‡´
- è®¾å¤‡æ ‡è¯†å¿…é¡»ä¸æ•°æ®åº“ä¸­ç»‘å®šçš„è®¾å¤‡ä¸€è‡´

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1ï¼šé¦–æ¬¡ç™»å½•ï¼ˆè®¾å¤‡ç»‘å®šï¼‰

**æ¥å£**: `POST /api/miniprogram/login`

**è¯·æ±‚å‚æ•°**:
```json
{
  "code": "test_phone_code_456",
  "deviceId": "device_test_12345"
}
```

**é¢„æœŸç»“æœ**:
- ç™»å½•æˆåŠŸ
- è¿”å›åŒ…å«è®¾å¤‡ä¿¡æ¯çš„token
- ç”¨æˆ·è®¾å¤‡è¢«ç»‘å®šä¸º`device_test_12345`

### æ­¥éª¤2ï¼šä½¿ç”¨æ­£ç¡®è®¾å¤‡è°ƒç”¨æ¥å£

**æ¥å£**: `GET /api/miniprogram/customers/search?customerNumber=C001`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <ä»ç™»å½•è·å¾—çš„accessToken>
X-Device-Id: device_test_12345
```

**é¢„æœŸç»“æœ**:
- æ¥å£è°ƒç”¨æˆåŠŸ
- è¿”å›å®¢æˆ·ä¿¡æ¯

### æ­¥éª¤3ï¼šä½¿ç”¨é”™è¯¯è®¾å¤‡è°ƒç”¨æ¥å£

**æ¥å£**: `GET /api/miniprogram/customers/search?customerNumber=C001`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <ä»ç™»å½•è·å¾—çš„accessToken>
X-Device-Id: device_wrong_67890
```

**é¢„æœŸç»“æœ**:
- æ¥å£è°ƒç”¨å¤±è´¥
- è¿”å›401é”™è¯¯ï¼š`è®¾å¤‡æ ‡è¯†ä¸åŒ¹é…ï¼Œè¯·é‡æ–°ç™»å½•`

### æ­¥éª¤4ï¼šç¼ºå°‘è®¾å¤‡æ ‡è¯†

**æ¥å£**: `GET /api/miniprogram/customers/search?customerNumber=C001`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <ä»ç™»å½•è·å¾—çš„accessToken>
```

**é¢„æœŸç»“æœ**:
- æ¥å£è°ƒç”¨å¤±è´¥
- è¿”å›401é”™è¯¯ï¼š`è¯·æ±‚å¤´ä¸­ç¼ºå°‘è®¾å¤‡æ ‡è¯†ï¼Œè¯·é‡æ–°ç™»å½•`

### æ­¥éª¤5ï¼šä½¿ç”¨å…¶ä»–è®¾å¤‡ç™»å½•

**æ¥å£**: `POST /api/miniprogram/login`

**è¯·æ±‚å‚æ•°**:
```json
{
  "code": "test_phone_code_456",
  "deviceId": "device_other_99999"
}
```

**é¢„æœŸç»“æœ**:
- ç™»å½•å¤±è´¥
- è¿”å›403é”™è¯¯ï¼š`è®¾å¤‡éªŒè¯å¤±è´¥ï¼Œè¯¥è´¦å·å·²ç»‘å®šå…¶ä»–è®¾å¤‡ï¼Œè¯·è”ç³»ç®¡ç†å‘˜`

## ğŸ“± å‰ç«¯é›†æˆç¤ºä¾‹

### 1. ç™»å½•æ—¶ä¿å­˜è®¾å¤‡ID

```javascript
// ç”Ÿæˆæˆ–è·å–è®¾å¤‡ID
const deviceId = wx.getStorageSync('deviceId') || 
                 wx.getSystemInfoSync().deviceId || 
                 'device_' + Date.now();

// ç™»å½•
wx.getPhoneNumber({
  success: function(res) {
    wx.request({
      url: '/api/miniprogram/login',
      method: 'POST',
      data: {
        code: res.code,
        deviceId: deviceId
      },
      success: (loginRes) => {
        if (loginRes.data.code === 200) {
          // ä¿å­˜tokenå’Œè®¾å¤‡ID
          wx.setStorageSync('accessToken', loginRes.data.data.accessToken);
          wx.setStorageSync('refreshToken', loginRes.data.data.refreshToken);
          wx.setStorageSync('deviceId', deviceId);
        }
      }
    });
  }
});
```

### 2. æ¥å£è°ƒç”¨æ—¶æºå¸¦è®¾å¤‡ID

```javascript
// å°è£…è¯·æ±‚å‡½æ•°
function apiRequest(options) {
  const accessToken = wx.getStorageSync('accessToken');
  const deviceId = wx.getStorageSync('deviceId');
  
  return wx.request({
    ...options,
    header: {
      'Authorization': 'Bearer ' + accessToken,
      'X-Device-Id': deviceId,
      ...options.header
    }
  });
}

// ä½¿ç”¨ç¤ºä¾‹
apiRequest({
  url: '/api/miniprogram/customers/search',
  method: 'GET',
  data: {
    customerNumber: 'C001'
  }
});
```

## ğŸ”§ Postman/Apifox æµ‹è¯•

### 1. è®¾ç½®ç¯å¢ƒå˜é‡
- `baseUrl`: `http://localhost:3000`
- `accessToken`: ä»ç™»å½•æ¥å£è·å¾—
- `deviceId`: `device_test_12345`

### 2. ç™»å½•è¯·æ±‚
```
POST {{baseUrl}}/api/miniprogram/login
Content-Type: application/json

{
  "code": "test_phone_code_456",
  "deviceId": "{{deviceId}}"
}
```

### 3. ä¸šåŠ¡æ¥å£è¯·æ±‚
```
GET {{baseUrl}}/api/miniprogram/customers/search?customerNumber=C001
Authorization: Bearer {{accessToken}}
X-Device-Id: {{deviceId}}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è®¾å¤‡IDæ ¼å¼**ï¼šå»ºè®®ä½¿ç”¨æœ‰æ„ä¹‰çš„å‰ç¼€ï¼Œå¦‚`device_`ã€`mac_`ç­‰
2. **è®¾å¤‡ç»‘å®š**ï¼šä¸€ä¸ªç”¨æˆ·åªèƒ½ç»‘å®šä¸€ä¸ªè®¾å¤‡ï¼Œå¦‚éœ€æ›´æ¢è®¾å¤‡è¯·è”ç³»ç®¡ç†å‘˜
3. **Tokenåˆ·æ–°**ï¼šåˆ·æ–°tokenæ—¶ä¹Ÿä¼šä¿æŒè®¾å¤‡ç»‘å®šä¿¡æ¯
4. **é”™è¯¯å¤„ç†**ï¼šå‰ç«¯éœ€è¦å¤„ç†è®¾å¤‡éªŒè¯å¤±è´¥çš„æƒ…å†µï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•

## ğŸ› å¸¸è§é—®é¢˜

### Q: è®¾å¤‡éªŒè¯å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„`X-Device-Id`æ˜¯å¦ä¸ç™»å½•æ—¶ä½¿ç”¨çš„ä¸€è‡´

### Q: å¦‚ä½•æ›´æ¢ç»‘å®šè®¾å¤‡ï¼Ÿ
A: ç›®å‰éœ€è¦ç®¡ç†å‘˜åœ¨åå°æ¸…é™¤ç”¨æˆ·çš„è®¾å¤‡ç»‘å®šï¼Œç„¶åç”¨æˆ·é‡æ–°ç™»å½•

### Q: è®¾å¤‡IDä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿ
A: éœ€è¦é‡æ–°ç™»å½•ï¼Œç³»ç»Ÿä¼šé‡æ–°ç»‘å®šå½“å‰è®¾å¤‡
