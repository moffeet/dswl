<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç¨‹åºæ¥å£æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .response {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .response pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .get { background: #61affe; color: white; }
        .post { background: #49cc90; color: white; }
        .patch { background: #fca130; color: white; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .signature-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .signature-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± å°ç¨‹åºæ¥å£æµ‹è¯•å·¥å…·</h1>
            <p>ç‰©æµé…é€ç®¡ç†ç³»ç»Ÿ - å°ç¨‹åºæ¥å£ç­¾åéªŒè¯æµ‹è¯•</p>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 14px;">
                <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
                1. é€‰æ‹©æµ‹è¯•ç”¨æˆ· â†’ 2. ç”Ÿæˆæ—¶é—´æˆ³å’Œéšæœºæ•° â†’ 3. ä¸ºæ¯ä¸ªæ¥å£ç”Ÿæˆç­¾å â†’ 4. æµ‹è¯•æ¥å£
                <br>
                <strong>æ³¨æ„ï¼š</strong>ç­¾åæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼Œnonceä¸èƒ½é‡å¤ä½¿ç”¨
            </div>
        </div>

        <!-- ç­¾åé…ç½®åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ” ç­¾åé…ç½®</h3>
            <div class="signature-section">
                <h4>ç­¾åå‚æ•°é…ç½®</h4>
                <div class="grid">
                    <div class="form-group">
                        <label>é€‰æ‹©æµ‹è¯•ç”¨æˆ·:</label>
                        <select id="userSelect" onchange="selectUser()">
                            <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                            <option value="1">å¼ ä¸‰ (ID: 1, å¸æœº)</option>
                            <option value="2">æå›› (ID: 2, é”€å”®)</option>
                            <option value="3">ç‹äº” (ID: 3, å¸æœº)</option>
                            <option value="4">èµµå…­ (ID: 4, é”€å”®)</option>
                            <option value="5">é’±ä¸ƒ (ID: 5, å¸æœº)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å°ç¨‹åºç”¨æˆ·ID (wxUserId) <span style="color: red;">*</span>:</label>
                        <input type="number" id="wxUserId" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·ç­¾åå¯†é’¥ (secretKey) <span style="color: red;">*</span>:</label>
                        <input type="text" id="secretKey" placeholder="è¯·è¾“å…¥ç”¨æˆ·çš„ç­¾åå¯†é’¥">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´æˆ³ (timestamp):</label>
                        <input type="text" id="timestamp" class="readonly" readonly>
                    </div>
                    <div class="form-group">
                        <label>éšæœºæ•° (nonce):</label>
                        <input type="text" id="nonce" class="readonly" readonly>
                    </div>
                </div>
                <button onclick="generateTimestampAndNonce()">ç”Ÿæˆæ—¶é—´æˆ³å’Œéšæœºæ•°</button>
                <button onclick="getUserSecretKey()" style="background: #28a745;">è·å–ç”¨æˆ·å¯†é’¥</button>
                <button onclick="loadPresetKeys()" style="background: #17a2b8;">åŠ è½½é¢„è®¾å¯†é’¥</button>
            </div>
        </div>

        <div class="grid">
            <!-- å®¢æˆ·æœç´¢æ¥å£ -->
            <div class="test-section">
                <h3><span class="method-badge get">GET</span>å¸æœºæŸ¥è¯¢å®¢æˆ·ä¿¡æ¯</h3>
                <div class="form-group">
                    <label>å®¢æˆ·ç¼–å· <span style="color: red;">*</span>:</label>
                    <input type="text" id="customerNumber" placeholder="å¦‚: C001" value="C001">
                    <small style="color: #666; font-size: 12px;">å¯ç”¨æµ‹è¯•æ•°æ®: C001(æ·±åœ³ç§‘æŠ€), C002(å¹¿å·è´¸æ˜“), C003(ä¸œèåˆ¶é€ ), C004(ä½›å±±ç‰©æµ), C005(æƒ å·ç”µå­)</small>
                </div>
                <div class="signature-section">
                    <h4>è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åå‚æ•°</h4>
                    <div class="form-group">
                        <label>ç­¾å (signature):</label>
                        <input type="text" id="customerSearchSignature" class="readonly" readonly>
                    </div>
                </div>
                <button onclick="generateCustomerSearchSignature()">ç”Ÿæˆç­¾å</button>
                <button onclick="testCustomerSearch()">æµ‹è¯•æ¥å£</button>
                <div id="customerSearchResponse" class="response" style="display: none;"></div>
            </div>

            <!-- ç­¾æ”¶å•ä¸Šä¼ æ¥å£ -->
            <div class="test-section">
                <h3><span class="method-badge post">POST</span>ä¸Šä¼ ç­¾æ”¶å•</h3>
                <div class="form-group">
                    <label>ä¸Šä¼ äººå§“å <span style="color: red;">*</span>:</label>
                    <input type="text" id="wxUserName" placeholder="å¦‚: å¼ ä¸‰" value="å¼ ä¸‰">
                </div>
                <div class="form-group">
                    <label>å®¢æˆ·åç§° <span style="color: red;">*</span>:</label>
                    <input type="text" id="receiptCustomerName" placeholder="å¦‚: æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸" value="æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸">
                </div>
                <div class="form-group">
                    <label>å®¢æˆ·åœ°å€:</label>
                    <input type="text" id="customerAddress" placeholder="å¦‚: æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºAåº§" value="æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºAåº§">
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ <span style="color: red;">*</span>:</label>
                    <input type="file" id="receiptFile" accept="image/*">
                </div>
                <div class="signature-section">
                    <h4>è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åå‚æ•°</h4>
                    <div class="form-group">
                        <label>ç­¾å (signature):</label>
                        <input type="text" id="receiptUploadSignature" class="readonly" readonly>
                    </div>
                </div>
                <button onclick="generateReceiptUploadSignature()">ç”Ÿæˆç­¾å</button>
                <button onclick="testReceiptUpload()">æµ‹è¯•æ¥å£</button>
                <div id="receiptUploadResponse" class="response" style="display: none;"></div>
            </div>
        </div>

        <div class="grid">
            <!-- æ‰“å¡ä¸Šä¼ æ¥å£ -->
            <div class="test-section">
                <h3><span class="method-badge post">POST</span>ä¸Šä¼ æ‰“å¡</h3>
                <div class="form-group">
                    <label>ä¸Šä¼ äººå§“å <span style="color: red;">*</span>:</label>
                    <input type="text" id="checkinUserName" placeholder="å¦‚: å¼ ä¸‰" value="å¼ ä¸‰">
                </div>
                <div class="form-group">
                    <label>å®¢æˆ·åç§° <span style="color: red;">*</span>:</label>
                    <input type="text" id="checkinCustomerName" placeholder="å¦‚: æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸" value="æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸">
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ <span style="color: red;">*</span>:</label>
                    <input type="file" id="checkinFile" accept="image/*">
                </div>
                <div class="signature-section">
                    <h4>è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åå‚æ•°</h4>
                    <div class="form-group">
                        <label>ç­¾å (signature):</label>
                        <input type="text" id="checkinUploadSignature" class="readonly" readonly>
                    </div>
                </div>
                <button onclick="generateCheckinUploadSignature()">ç”Ÿæˆç­¾å</button>
                <button onclick="testCheckinUpload()">æµ‹è¯•æ¥å£</button>
                <div id="checkinUploadResponse" class="response" style="display: none;"></div>
            </div>

            <!-- å®¢æˆ·ä¿¡æ¯æ›´æ–°æ¥å£ -->
            <div class="test-section">
                <h3><span class="method-badge patch">PATCH</span>ä¿®æ”¹å®¢æˆ·åœ°å€</h3>
                <div class="form-group">
                    <label>æ“ä½œäººå§“å <span style="color: red;">*</span>:</label>
                    <input type="text" id="operatorName" placeholder="å¦‚: å¼ ä¸‰" value="å¼ ä¸‰">
                </div>
                <div class="form-group">
                    <label>å®¢æˆ·ç¼–å· <span style="color: red;">*</span>:</label>
                    <input type="text" id="updateCustomerNumber" placeholder="å¦‚: C001" value="C001">
                </div>
                <div class="form-group">
                    <label>é—¨åº—åœ°å€:</label>
                    <input type="text" id="storeAddress" placeholder="å¦‚: æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºAåº§" value="æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºAåº§">
                </div>
                <div class="form-group">
                    <label>ä»“åº“åœ°å€:</label>
                    <input type="text" id="warehouseAddress" placeholder="å¦‚: æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºBåº§" value="æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºBåº§">
                </div>
                <div class="signature-section">
                    <h4>è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åå‚æ•°</h4>
                    <div class="form-group">
                        <label>ç­¾å (signature):</label>
                        <input type="text" id="customerUpdateSignature" class="readonly" readonly>
                    </div>
                </div>
                <button onclick="generateCustomerUpdateSignature()">ç”Ÿæˆç­¾å</button>
                <button onclick="testCustomerUpdate()">æµ‹è¯•æ¥å£</button>
                <div id="customerUpdateResponse" class="response" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ å¿«é€Ÿæ“ä½œ</h3>
            <button onclick="clearAllResponses()" style="background: #6c757d;">æ¸…ç©ºæ‰€æœ‰å“åº”</button>
            <button onclick="window.open('http://localhost:3000/api', '_blank')" style="background: #28a745;">æ‰“å¼€ Swagger æ–‡æ¡£</button>
            <button onclick="copySignatureExample()" style="background: #17a2b8;">å¤åˆ¶ç­¾åç¤ºä¾‹ä»£ç </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const baseURL = 'http://localhost:3000';

        // æ˜¾ç¤ºå“åº”ç»“æœ
        function showResponse(elementId, response) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
        }

        // ç”Ÿæˆéšæœºnonce
        function generateNonce(length = 16) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // ç”Ÿæˆæ—¶é—´æˆ³å’Œéšæœºæ•°
        function generateTimestampAndNonce() {
            document.getElementById('timestamp').value = Date.now().toString();
            document.getElementById('nonce').value = generateNonce();
        }

        // ç”Ÿæˆç­¾å
        function generateSignature(params, secretKey) {
            // 1. è¿‡æ»¤æ‰signatureå‚æ•°
            const filteredParams = { ...params };
            delete filteredParams.signature;

            // 2. æŒ‰å‚æ•°åå­—å…¸åºæ’åº
            const sortedKeys = Object.keys(filteredParams).sort();
            
            // 3. æ‹¼æ¥å‚æ•°å­—ç¬¦ä¸²
            const paramString = sortedKeys
                .map(key => {
                    const value = filteredParams[key];
                    if (value === null || value === undefined || value === '') {
                        return `${key}=`;
                    }
                    if (typeof value === 'object') {
                        return `${key}=${JSON.stringify(value)}`;
                    }
                    return `${key}=${value}`;
                })
                .join('&');

            console.log('å‚æ•°å­—ç¬¦ä¸²:', paramString);

            // 4. ç”Ÿæˆç­¾å
            return CryptoJS.HmacSHA256(paramString, secretKey).toString();
        }

        // é¢„è®¾çš„ç”¨æˆ·ç­¾åå¯†é’¥ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
        const presetKeys = {
            1: '3f6de2a6666ac0cb652a59c3e1a9eddc81a4e0526b3cce46e759140df13e2820', // å¼ ä¸‰
            2: '592c675f7e2b4c7ec0dbb923d18102ec2333e28a695987ccd8f1c710717f0abf', // æå››
            3: 'ddc66772dae3e3b7360de8125fffa8485f728311122df784a2298126eef64450', // ç‹äº”
            4: '969236360ddc46ed579c296ace70dd4a016c28ea621f99eba537bbbc20d799d3', // èµµå…­
            5: '1aaadc341721a34009a606b46e7ef95acf830cebb1aada7afebc163c84ebf58d'  // é’±ä¸ƒ
        };

        // é€‰æ‹©ç”¨æˆ·
        function selectUser() {
            const userSelect = document.getElementById('userSelect');
            const selectedUserId = userSelect.value;

            if (selectedUserId) {
                document.getElementById('wxUserId').value = selectedUserId;
                // è‡ªåŠ¨åŠ è½½é¢„è®¾å¯†é’¥
                if (presetKeys[selectedUserId]) {
                    document.getElementById('secretKey').value = presetKeys[selectedUserId];
                }
            }
        }

        // åŠ è½½é¢„è®¾å¯†é’¥
        function loadPresetKeys() {
            const wxUserId = document.getElementById('wxUserId').value;
            if (!wxUserId) {
                alert('è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©ç”¨æˆ·ID');
                return;
            }

            if (presetKeys[wxUserId]) {
                document.getElementById('secretKey').value = presetKeys[wxUserId];
                alert('é¢„è®¾å¯†é’¥åŠ è½½æˆåŠŸï¼');
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°è¯¥ç”¨æˆ·çš„é¢„è®¾å¯†é’¥ï¼Œè¯·ä½¿ç”¨"è·å–ç”¨æˆ·å¯†é’¥"åŠŸèƒ½');
            }
        }

        // è·å–ç”¨æˆ·ç­¾åå¯†é’¥
        async function getUserSecretKey() {
            const wxUserId = document.getElementById('wxUserId').value;
            if (!wxUserId) {
                alert('è¯·å…ˆè¾“å…¥å°ç¨‹åºç”¨æˆ·ID');
                return;
            }

            try {
                const response = await fetch(`${baseURL}/api/auth/user-signature-key/${wxUserId}`);
                const data = await response.json();

                if (data.code === 200) {
                    document.getElementById('secretKey').value = data.data.secretKey;
                    alert('è·å–ç”¨æˆ·å¯†é’¥æˆåŠŸï¼');
                } else {
                    alert(`è·å–ç”¨æˆ·å¯†é’¥å¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                alert(`è·å–ç”¨æˆ·å¯†é’¥å¤±è´¥: ${error.message}`);
            }
        }

        // ç”Ÿæˆå®¢æˆ·æœç´¢ç­¾å
        function generateCustomerSearchSignature() {
            const wxUserId = document.getElementById('wxUserId').value;
            const customerNumber = document.getElementById('customerNumber').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const secretKey = document.getElementById('secretKey').value;

            if (!wxUserId || !customerNumber || !timestamp || !nonce || !secretKey) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å‚æ•°');
                return;
            }

            const params = {
                wxUserId: parseInt(wxUserId),
                customerNumber,
                timestamp,
                nonce
            };

            const signature = generateSignature(params, secretKey);
            document.getElementById('customerSearchSignature').value = signature;
        }

        // æµ‹è¯•å®¢æˆ·æœç´¢æ¥å£
        async function testCustomerSearch() {
            const wxUserId = document.getElementById('wxUserId').value;
            const customerNumber = document.getElementById('customerNumber').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const signature = document.getElementById('customerSearchSignature').value;

            if (!signature) {
                alert('è¯·å…ˆç”Ÿæˆç­¾å');
                return;
            }

            const params = new URLSearchParams({
                wxUserId,
                customerNumber,
                timestamp,
                nonce,
                signature
            });

            try {
                const response = await fetch(`${baseURL}/api/miniprogram/customers/search?${params}`);
                const data = await response.json();
                showResponse('customerSearchResponse', data);
            } catch (error) {
                showResponse('customerSearchResponse', { error: error.message });
            }
        }

        // ç”Ÿæˆç­¾æ”¶å•ä¸Šä¼ ç­¾å
        function generateReceiptUploadSignature() {
            const wxUserId = document.getElementById('wxUserId').value;
            const wxUserName = document.getElementById('wxUserName').value;
            const customerName = document.getElementById('receiptCustomerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const secretKey = document.getElementById('secretKey').value;

            if (!wxUserId || !wxUserName || !customerName || !timestamp || !nonce || !secretKey) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å‚æ•°');
                return;
            }

            const params = {
                wxUserId: parseInt(wxUserId),
                wxUserName,
                customerName,
                customerAddress: customerAddress || '',
                timestamp,
                nonce
            };

            const signature = generateSignature(params, secretKey);
            document.getElementById('receiptUploadSignature').value = signature;
        }

        // æµ‹è¯•ç­¾æ”¶å•ä¸Šä¼ æ¥å£
        async function testReceiptUpload() {
            const wxUserId = document.getElementById('wxUserId').value;
            const wxUserName = document.getElementById('wxUserName').value;
            const customerName = document.getElementById('receiptCustomerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const signature = document.getElementById('receiptUploadSignature').value;
            const fileInput = document.getElementById('receiptFile');

            if (!signature) {
                alert('è¯·å…ˆç”Ÿæˆç­¾å');
                return;
            }

            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('wxUserId', wxUserId);
            formData.append('wxUserName', wxUserName);
            formData.append('customerName', customerName);
            if (customerAddress) formData.append('customerAddress', customerAddress);
            formData.append('timestamp', timestamp);
            formData.append('nonce', nonce);
            formData.append('signature', signature);
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${baseURL}/api/miniprogram/receipts/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResponse('receiptUploadResponse', data);
            } catch (error) {
                showResponse('receiptUploadResponse', { error: error.message });
            }
        }

        // ç”Ÿæˆæ‰“å¡ä¸Šä¼ ç­¾å
        function generateCheckinUploadSignature() {
            const wxUserId = document.getElementById('wxUserId').value;
            const wxUserName = document.getElementById('checkinUserName').value;
            const customerName = document.getElementById('checkinCustomerName').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const secretKey = document.getElementById('secretKey').value;

            if (!wxUserId || !wxUserName || !customerName || !timestamp || !nonce || !secretKey) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å‚æ•°');
                return;
            }

            const params = {
                wxUserId: parseInt(wxUserId),
                wxUserName,
                customerName,
                timestamp,
                nonce
            };

            const signature = generateSignature(params, secretKey);
            document.getElementById('checkinUploadSignature').value = signature;
        }

        // æµ‹è¯•æ‰“å¡ä¸Šä¼ æ¥å£
        async function testCheckinUpload() {
            const wxUserId = document.getElementById('wxUserId').value;
            const wxUserName = document.getElementById('checkinUserName').value;
            const customerName = document.getElementById('checkinCustomerName').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const signature = document.getElementById('checkinUploadSignature').value;
            const fileInput = document.getElementById('checkinFile');

            if (!signature) {
                alert('è¯·å…ˆç”Ÿæˆç­¾å');
                return;
            }

            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('wxUserId', wxUserId);
            formData.append('wxUserName', wxUserName);
            formData.append('customerName', customerName);
            formData.append('timestamp', timestamp);
            formData.append('nonce', nonce);
            formData.append('signature', signature);
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${baseURL}/api/miniprogram/checkins/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResponse('checkinUploadResponse', data);
            } catch (error) {
                showResponse('checkinUploadResponse', { error: error.message });
            }
        }

        // ç”Ÿæˆå®¢æˆ·ä¿¡æ¯æ›´æ–°ç­¾å
        function generateCustomerUpdateSignature() {
            const wxUserId = document.getElementById('wxUserId').value;
            const operatorName = document.getElementById('operatorName').value;
            const customerNumber = document.getElementById('updateCustomerNumber').value;
            const storeAddress = document.getElementById('storeAddress').value;
            const warehouseAddress = document.getElementById('warehouseAddress').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const secretKey = document.getElementById('secretKey').value;

            if (!wxUserId || !operatorName || !customerNumber || !timestamp || !nonce || !secretKey) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å‚æ•°');
                return;
            }

            const params = {
                wxUserId: parseInt(wxUserId),
                operatorName,
                customerNumber,
                timestamp,
                nonce
            };

            // åªæœ‰éç©ºçš„åœ°å€æ‰åŠ å…¥ç­¾åå‚æ•°
            if (storeAddress) params.storeAddress = storeAddress;
            if (warehouseAddress) params.warehouseAddress = warehouseAddress;

            const signature = generateSignature(params, secretKey);
            document.getElementById('customerUpdateSignature').value = signature;
        }

        // æµ‹è¯•å®¢æˆ·ä¿¡æ¯æ›´æ–°æ¥å£
        async function testCustomerUpdate() {
            const wxUserId = document.getElementById('wxUserId').value;
            const operatorName = document.getElementById('operatorName').value;
            const customerNumber = document.getElementById('updateCustomerNumber').value;
            const storeAddress = document.getElementById('storeAddress').value;
            const warehouseAddress = document.getElementById('warehouseAddress').value;
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const signature = document.getElementById('customerUpdateSignature').value;

            if (!signature) {
                alert('è¯·å…ˆç”Ÿæˆç­¾å');
                return;
            }

            const requestBody = {
                wxUserId: parseInt(wxUserId),
                operatorName,
                customerNumber,
                timestamp,
                nonce,
                signature
            };

            // åªæœ‰éç©ºçš„åœ°å€æ‰åŠ å…¥è¯·æ±‚ä½“
            if (storeAddress) requestBody.storeAddress = storeAddress;
            if (warehouseAddress) requestBody.warehouseAddress = warehouseAddress;

            try {
                const response = await fetch(`${baseURL}/api/miniprogram/customers/update`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                showResponse('customerUpdateResponse', data);
            } catch (error) {
                showResponse('customerUpdateResponse', { error: error.message });
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å“åº”
        function clearAllResponses() {
            const responses = document.querySelectorAll('.response');
            responses.forEach(response => {
                response.style.display = 'none';
            });
        }

        // å¤åˆ¶ç­¾åç¤ºä¾‹ä»£ç 
        function copySignatureExample() {
            const exampleCode = `
// å°ç¨‹åºç­¾åç”Ÿæˆç¤ºä¾‹ä»£ç  (JavaScript)
const crypto = require('crypto');

function generateSignature(params, secretKey) {
    // 1. è¿‡æ»¤æ‰signatureå‚æ•°
    const filteredParams = { ...params };
    delete filteredParams.signature;

    // 2. æŒ‰å‚æ•°åå­—å…¸åºæ’åº
    const sortedKeys = Object.keys(filteredParams).sort();

    // 3. æ‹¼æ¥å‚æ•°å­—ç¬¦ä¸²
    const paramString = sortedKeys
        .map(key => {
            const value = filteredParams[key];
            if (value === null || value === undefined || value === '') {
                return \`\${key}=\`;
            }
            if (typeof value === 'object') {
                return \`\${key}=\${JSON.stringify(value)}\`;
            }
            return \`\${key}=\${value}\`;
        })
        .join('&');

    // 4. ç”Ÿæˆç­¾å
    return crypto
        .createHmac('sha256', secretKey)
        .update(paramString)
        .digest('hex');
}

function generateNonce(length = 16) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// ä½¿ç”¨ç¤ºä¾‹
const params = {
    wxUserId: 1,
    customerNumber: 'C001',
    timestamp: Date.now().toString(),
    nonce: generateNonce()
};

const secretKey = 'your_user_secret_key_here';
params.signature = generateSignature(params, secretKey);

console.log('ç­¾åå‚æ•°:', params);
            `;

            navigator.clipboard.writeText(exampleCode).then(() => {
                alert('ç­¾åç¤ºä¾‹ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºä»£ç 
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`<pre>${exampleCode}</pre>`);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³å’Œéšæœºæ•°
        window.onload = function() {
            generateTimestampAndNonce();
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªç”¨æˆ·
            document.getElementById('userSelect').value = '1';
            selectUser();
            console.log('å°ç¨‹åºæ¥å£æµ‹è¯•å·¥å…·å·²åŠ è½½');
            console.log('åŸºç¡€URL:', baseURL);
        };
    </script>
</body>
</html>
