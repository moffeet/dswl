# 文件存储配置说明

## 📁 存储路径配置

本系统支持跨平台部署，文件存储路径可通过环境变量灵活配置。

### 🔧 默认路径规则

系统会自动根据操作系统选择合适的默认路径：

#### Windows 系统
```
C:\receipts\uploads\
```
- 使用项目所在盘符的根目录
- 如果项目在 D 盘，则为 `D:\receipts\uploads\`

#### Linux/macOS 系统
```
/receipts/uploads/
```
- 使用系统根目录

### 🎛️ 自定义配置

可以通过环境变量 `UPLOAD_ROOT_PATH` 自定义存储路径：

#### 在 .env 文件中配置
```env
# Windows 示例
UPLOAD_ROOT_PATH=D:\custom\path\receipts\uploads

# Linux 示例
UPLOAD_ROOT_PATH=/var/uploads/receipts

# macOS 示例
UPLOAD_ROOT_PATH=/Users/shared/receipts/uploads
```

## 📂 目录结构

文件按照年/月/日分层存储：

```
receipts/uploads/
├── receipts/
│   ├── 2025/
│   │   ├── 01/
│   │   │   ├── 09/
│   │   │   │   ├── receipt_1704758400000_abc123.jpg
│   │   │   │   └── receipt_1704758500000_def456.png
│   │   │   └── 10/
│   │   └── 02/
│   └── 2024/
└── other_files/
```

## 🌐 访问URL

所有文件通过统一的URL路径访问：
```
http://localhost:3000/receipts/uploads/receipts/2025/01/09/receipt_xxx.jpg
```

## 🚀 部署配置

### Windows 部署

1. **创建目录**（以管理员身份运行）：
```cmd
mkdir C:\receipts\uploads
```

2. **设置权限**：
确保应用程序有读写权限

3. **环境变量**（可选）：
```env
UPLOAD_ROOT_PATH=C:\receipts\uploads
```

### Linux 部署

1. **创建目录**：
```bash
sudo mkdir -p /receipts/uploads
sudo chown -R www-data:www-data /receipts/uploads
sudo chmod -R 755 /receipts/uploads
```

2. **环境变量**（可选）：
```env
UPLOAD_ROOT_PATH=/receipts/uploads
```

### macOS 部署

1. **创建目录**：
```bash
sudo mkdir -p /receipts/uploads
sudo chown -R $(whoami):staff /receipts/uploads
sudo chmod -R 755 /receipts/uploads
```

2. **环境变量**（可选）：
```env
UPLOAD_ROOT_PATH=/receipts/uploads
```

### Docker 部署

在 docker-compose.yml 中配置卷映射：

```yaml
version: '3.8'
services:
  backend:
    image: logistics-backend
    volumes:
      - /host/path/receipts/uploads:/receipts/uploads
    environment:
      - UPLOAD_ROOT_PATH=/receipts/uploads
```

## ⚠️ 注意事项

### 权限要求
- 应用程序需要对存储目录有读写权限
- Linux/macOS 系统可能需要 sudo 权限创建根目录

### 磁盘空间
- 定期监控磁盘使用情况
- 建议设置磁盘空间告警

### 备份策略
- 定期备份 uploads 目录
- 考虑使用网络存储或云存储

### 安全考虑
- 限制文件类型和大小
- 定期清理过期文件
- 防止目录遍历攻击

## 🔍 故障排查

### 常见问题

1. **权限不足**
```
Error: EACCES: permission denied, mkdir '/receipts/uploads'
```
解决：检查目录权限，使用 sudo 创建目录

2. **磁盘空间不足**
```
Error: ENOSPC: no space left on device
```
解决：清理磁盘空间或扩容

3. **路径不存在**
```
Error: ENOENT: no such file or directory
```
解决：检查环境变量配置，确保路径存在

### 调试命令

检查当前配置：
```bash
# 查看环境变量
echo $UPLOAD_ROOT_PATH

# 检查目录权限
ls -la /receipts/uploads

# 检查磁盘空间
df -h /receipts/uploads
```

## 📊 监控建议

### 磁盘使用监控
```bash
# 检查目录大小
du -sh /receipts/uploads

# 监控磁盘使用率
df -h | grep receipts
```

### 文件数量统计
```bash
# 统计文件总数
find /receipts/uploads -type f | wc -l

# 按日期统计
find /receipts/uploads -type f -newermt "2025-01-01" | wc -l
```
