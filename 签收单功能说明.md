# 📋 签收单管理系统

## 📖 功能概述

签收单管理系统是物流配送管理系统的核心功能之一，主要用于管理司机上传的签收单据，支持图片上传、查询检索、数据统计和自动清理等功能。

## 🏗️ 系统架构

### 数据库设计

#### 签收单表 (t_receipts)
```sql
CREATE TABLE t_receipts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '签收单ID',
    wx_user_id BIGINT NOT NULL COMMENT '小程序用户ID',
    wx_user_name VARCHAR(100) NOT NULL COMMENT '上传人姓名',
    customer_id BIGINT DEFAULT NULL COMMENT '客户ID（可能为空，如果客户被删除）',
    customer_name VARCHAR(100) NOT NULL COMMENT '客户名称',
    customer_address VARCHAR(500) DEFAULT NULL COMMENT '客户地址',
    upload_location VARCHAR(500) DEFAULT NULL COMMENT '上传地点',
    upload_longitude DECIMAL(10, 7) DEFAULT NULL COMMENT '上传经度',
    upload_latitude DECIMAL(10, 7) DEFAULT NULL COMMENT '上传纬度',
    image_path VARCHAR(500) NOT NULL COMMENT '图片路径',
    image_url VARCHAR(500) NOT NULL COMMENT '图片访问URL',
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    
    is_deleted TINYINT(1) DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT = '签收单表';
```

### 文件存储结构
```
uploads/
└── receipts/
    └── 2025/
        └── 01/
            └── 09/
                ├── receipt_1704758400000_abc123def.jpg
                ├── receipt_1704762000000_xyz789ghi.jpg
                └── ...
```

## 🔧 后端API接口

### 1. 小程序上传签收单
**接口地址：** `POST /receipts/upload`  
**权限要求：** 无需认证（通过微信ID和MAC地址验证）  
**请求方式：** `multipart/form-data`

**请求参数：**
```typescript
{
  wechatId: string;        // 微信ID
  macAddress: string;      // MAC地址
  customerId?: number;     // 客户ID（可选）
  customerName: string;    // 客户名称
  customerAddress?: string; // 客户地址（可选）
  uploadLocation?: string; // 上传地点（可选）
  uploadLongitude?: number; // 上传经度（可选）
  uploadLatitude?: number; // 上传纬度（可选）
  file: File;             // 图片文件
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "签收单上传成功",
  "data": {
    "id": 1,
    "imageUrl": "http://localhost:3000/uploads/receipts/2025/01/09/receipt_1704758400000.jpg",
    "uploadTime": "2025-01-09T10:30:00.000Z",
    "wxUserName": "张三",
    "customerName": "深圳科技有限公司"
  }
}
```

### 2. 获取签收单列表
**接口地址：** `GET /receipts`  
**权限要求：** 需要JWT认证

**查询参数：**
```typescript
{
  page?: number;          // 页码，默认1
  limit?: number;         // 每页数量，默认10
  search?: string;        // 搜索上传人姓名
  customerName?: string;  // 搜索客户名称
  startTime?: string;     // 开始时间
  endTime?: string;       // 结束时间
  sortBy?: string;        // 排序字段，默认uploadTime
  sortOrder?: 'ASC' | 'DESC'; // 排序方向，默认DESC
}
```

### 3. 删除签收单
**接口地址：** `DELETE /receipts/:id`  
**权限要求：** 需要JWT认证

### 4. 批量删除签收单
**接口地址：** `DELETE /receipts/batch/remove`  
**权限要求：** 需要JWT认证

**请求体：**
```json
{
  "ids": [1, 2, 3]
}
```

### 5. 清理旧数据
**接口地址：** `POST /receipts/cleanup/old`  
**权限要求：** 需要JWT认证  
**功能：** 删除3个月前的签收单数据和图片文件

## 🎨 前端功能

### 管理后台页面 (`/receipts`)

#### 功能特性
- ✅ **数据统计**：显示总签收单数和今日上传数量
- ✅ **多条件搜索**：支持按上传人、客户名称、时间范围搜索
- ✅ **表格展示**：分页显示签收单列表
- ✅ **图片预览**：点击查看按钮预览签收单图片
- ✅ **批量操作**：支持批量删除选中的签收单
- ✅ **数据清理**：一键清理3个月前的历史数据

#### 界面布局
```
┌─────────────────────────────────────────┐
│ 统计卡片区域                              │
│ [总签收单数: 100] [今日上传: 5]            │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 搜索和操作区域                            │
│ [搜索上传人] [搜索客户] [时间范围] [搜索]   │
│ [重置] [批量删除] [清理旧数据]             │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 数据表格区域                              │
│ 上传人 | 客户名称 | 客户地址 | 上传地点 |   │
│ 图片预览 | 上传时间 | 操作                │
└─────────────────────────────────────────┘
```

## 📱 小程序集成

### 使用流程
1. **用户验证**：通过微信ID和MAC地址验证司机身份
2. **角色检查**：只有司机角色可以上传签收单
3. **拍照上传**：选择或拍摄签收单图片
4. **信息填写**：填写客户信息和位置信息
5. **提交上传**：调用上传接口提交数据

### 示例代码
```javascript
// 小程序端上传签收单
const uploadReceipt = async (formData) => {
  const response = await wx.uploadFile({
    url: 'http://localhost:3000/receipts/upload',
    filePath: formData.imagePath,
    name: 'file',
    formData: {
      wechatId: formData.wechatId,
      macAddress: formData.macAddress,
      customerName: formData.customerName,
      customerAddress: formData.customerAddress,
      uploadLocation: formData.uploadLocation,
      uploadLongitude: formData.uploadLongitude,
      uploadLatitude: formData.uploadLatitude
    }
  });
  
  return JSON.parse(response.data);
};
```

## 🔐 权限控制

### 小程序端
- **身份验证**：微信ID + MAC地址双重验证
- **角色限制**：仅司机角色可上传签收单
- **设备绑定**：MAC地址用于设备绑定验证

### 管理后台
- **JWT认证**：所有管理接口需要有效的JWT令牌
- **权限检查**：基于用户角色和权限系统控制访问
- **操作日志**：记录重要操作的日志信息

## 📊 数据管理

### 软删除机制
- **日常删除**：使用软删除，设置 `is_deleted = 1`
- **数据保留**：保留历史记录，便于数据恢复和审计
- **查询过滤**：所有查询自动过滤已删除数据

### 定时清理
- **清理周期**：3个月
- **清理内容**：数据库记录 + 图片文件
- **触发方式**：手动触发或定时任务
- **安全确认**：需要管理员确认才能执行

## 🗂️ 文件管理

### 存储策略
- **本地存储**：图片文件存储在服务器本地
- **目录结构**：按年/月/日分层存储，便于管理
- **文件命名**：时间戳 + 随机字符串，确保唯一性
- **访问控制**：通过静态文件服务提供访问

### 文件限制
- **大小限制**：单个文件最大10MB
- **格式限制**：支持 jpg, jpeg, png, gif
- **安全检查**：文件类型验证和恶意文件检测

## 🚀 部署说明

### 环境要求
- Node.js 18+
- MySQL 8.0+
- 磁盘空间：根据图片数量预估

### 配置项
```env
# 文件上传配置
UPLOAD_MAX_SIZE=10485760  # 10MB
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif

# 清理配置
CLEANUP_MONTHS=3  # 保留3个月数据
```

### 注意事项
1. **磁盘监控**：定期监控磁盘使用情况
2. **备份策略**：定期备份 uploads 目录
3. **性能优化**：大量图片时考虑CDN加速
4. **安全防护**：防止恶意文件上传

## 📈 监控指标

### 业务指标
- 每日上传签收单数量
- 存储空间使用情况
- 用户活跃度统计

### 技术指标
- 接口响应时间
- 文件上传成功率
- 错误日志监控

## 🔧 故障排查

### 常见问题
1. **上传失败**：检查文件大小和格式
2. **图片无法显示**：检查文件路径和权限
3. **清理失败**：检查磁盘权限和空间

### 日志位置
- 应用日志：`logs/application.log`
- 错误日志：`logs/error.log`
- 上传日志：`logs/upload.log`
