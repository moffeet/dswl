# 🔓 开发环境认证绕过功能

## 📋 功能说明

为了方便开发和调试，我们在开发环境下提供了认证绕过功能。通过在请求头中添加特定参数，可以跳过JWT认证和设备验证，直接测试业务逻辑。

## ⚠️ 安全说明

- **仅在开发环境生效**：此功能只在 `NODE_ENV !== 'production'` 时生效
- **生产环境无效**：在生产环境下，即使添加了绕过参数也不会生效
- **仅限标记接口**：只有使用了 `@DevBypass()` 装饰器的接口才支持此功能

## 🚀 使用方法

### 1. 请求头参数

在请求头中添加以下参数：

```
X-Dev-Skip-Auth: false
```

- `false` = 跳过认证验证
- `true` 或不传 = 正常进行认证验证

### 2. 支持的接口

目前支持认证绕过的小程序接口：

- `GET /api/miniprogram/customers` - 司机获取客户列表
- `GET /api/miniprogram/customers/search` - 司机查询客户信息  
- `POST /api/miniprogram/receipts/upload` - 上传签收单
- `PATCH /api/miniprogram/customers/update` - 修改客户地址

### 3. 前端调用示例

#### 使用 fetch

```javascript
// 跳过认证的请求
fetch('/api/miniprogram/customers', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'X-Dev-Skip-Auth': 'false'  // 跳过认证
  }
});

// 正常认证的请求
fetch('/api/miniprogram/customers', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer your-jwt-token',
    'X-Device-Id': 'your-device-id',
    'X-Dev-Skip-Auth': 'true'   // 或者不传这个参数
  }
});
```

#### 使用 axios

```javascript
// 跳过认证的请求
axios.get('/api/miniprogram/customers', {
  headers: {
    'X-Dev-Skip-Auth': 'false'
  }
});

// 正常认证的请求
axios.get('/api/miniprogram/customers', {
  headers: {
    'Authorization': 'Bearer your-jwt-token',
    'X-Device-Id': 'your-device-id'
  }
});
```

#### 微信小程序

```javascript
// 跳过认证的请求
wx.request({
  url: '/api/miniprogram/customers',
  method: 'GET',
  header: {
    'X-Dev-Skip-Auth': 'false'
  },
  success: (res) => {
    console.log(res.data);
  }
});
```

### 4. Postman 测试

在 Postman 中测试时：

1. 在 Headers 标签页添加：
   - Key: `X-Dev-Skip-Auth`
   - Value: `false`

2. 不需要添加 Authorization 和 X-Device-Id 头

## 🔧 技术实现

### 装饰器

```typescript
@DevBypass() // 标记接口支持开发环境认证绕过
@Get('some-endpoint')
async someMethod() { ... }
```

### 守卫逻辑

```typescript
// 在 JwtAuthGuard 中的实现
if (canDevBypass && process.env.NODE_ENV !== 'production') {
  const skipAuth = request.headers['x-dev-skip-auth'];
  if (skipAuth === 'false') {
    console.log('🔓 [开发模式] 跳过JWT认证验证');
    return true;
  }
}
```

## 📝 注意事项

1. **环境检查**：确保在开发环境下使用（NODE_ENV !== 'production'）
2. **参数值**：必须传递字符串 `'false'` 才能跳过认证
3. **业务逻辑**：跳过认证后，业务逻辑中的用户信息可能为空，需要做好兼容处理
4. **调试日志**：跳过认证时会在控制台输出 `🔓 [开发模式] 跳过JWT认证验证` 日志

## 🎯 使用场景

- **接口调试**：快速测试接口的业务逻辑
- **前端开发**：在没有完整认证流程时测试前端功能
- **自动化测试**：编写测试用例时跳过认证步骤
- **API文档测试**：在Swagger等工具中快速测试接口
