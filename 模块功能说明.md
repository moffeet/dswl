# 物流配送管理系统 - 模块功能说明

本文档详细描述了物流配送管理系统各个功能模块的具体功能、技术架构和使用方法。

## 📋 目录

- [技术架构](#技术架构)
- [系统概览](#系统概览)
- [客户管理模块](#客户管理模块)
- [用户权限管理模块](#用户权限管理模块)
- [角色权限管理模块](#角色权限管理模块)
- [司机管理模块](#司机管理模块)
- [打卡记录模块](#打卡记录模块)
- [小程序端功能](#小程序端功能)

---

## 技术架构

### 🏗️ 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   小程序前端     │    │   管理后台       │    │   后端API       │
│  (Next.js 15)   │    │  (Next.js 15)   │    │   (NestJS 10)   │
│   端口: 3002     │    │   端口: 3001     │    │   端口: 3000     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                │
                    ┌─────────────────┐
                    │   MySQL 8.0     │
                    │   (数据存储)     │
                    └─────────────────┘
```

### 💻 前端技术栈

#### 管理后台 (admin-frontend)
- **框架**: Next.js 15.3.4
- **构建工具**: Turbopack
- **语言**: TypeScript 5.x
- **样式**: TailwindCSS 3.x
- **UI组件**: Arco Design
- **状态管理**: React Hooks
- **HTTP客户端**: Axios
- **表单处理**: React Hook Form
- **数据表格**: Arco Design Table
- **文件上传**: 内置Upload组件
- **图标**: Arco Design Icons

#### 小程序前端 (frontend)  
- **框架**: Next.js 15.3.4
- **构建工具**: Turbopack
- **语言**: TypeScript 5.x
- **样式**: TailwindCSS 3.x
- **移动端适配**: 响应式设计
- **地图集成**: 高德地图 Web API
- **相机调用**: Web API (getUserMedia)
- **地理位置**: Geolocation API

### 🔧 后端技术栈

#### 核心框架 (backend-node)
- **框架**: NestJS 10.x
- **语言**: TypeScript 5.x
- **运行时**: Node.js 18+
- **构建工具**: TypeScript Compiler
- **包管理**: npm

#### 数据层
- **数据库**: MySQL 8.0
- **ORM**: TypeORM 0.3.x
- **连接池**: 默认连接池配置
- **数据迁移**: TypeORM Migrations
- **数据验证**: class-validator + class-transformer

#### 认证与安全
- **认证方式**: JWT (JSON Web Token)
- **密码加密**: bcrypt
- **权限控制**: CASL (细粒度权限)
- **API安全**: CORS配置
- **参数验证**: ValidationPipe

#### API文档
- **文档工具**: Swagger/OpenAPI 3.0
- **访问地址**: http://localhost:3000/api
- **自动生成**: 基于装饰器和DTO

#### 文件处理
- **文件上传**: Multer
- **图片处理**: Sharp (可选)
- **存储位置**: 本地文件系统 + 数据库路径
- **支持格式**: JPG, PNG, GIF

#### 外部集成
- **地图服务**: 高德地图 API
- **微信集成**: 微信小程序 API
- **第三方服务**: HTTP客户端 Axios

### 📊 数据库设计

#### 核心数据表
```sql
-- 用户表
users (id, username, real_name, phone, email, gender, role, status, created_at, updated_at)

-- 客户表  
customers (id, customer_code, name, contact_person, phone, address, region, created_at, updated_at, created_by)

-- 司机表
drivers (id, name, phone, license_plate, status, created_at, updated_at)

-- 签到记录表
checkin_records (id, driver_id, customer_id, location, image_path, created_at)

-- 角色权限表
roles (id, name, description, permissions, created_at, updated_at)
```

### 🔄 部署架构

#### 开发环境
- **前端**: 开发服务器 (npm run dev)
- **后端**: 热重载 (nodemon + ts-node)
- **数据库**: 本地 MySQL
- **服务管理**: ser.sh 脚本

#### 生产环境
- **前端**: 静态构建 (npm run build + npm start)
- **后端**: 编译部署 (npm run build + node dist/main.js)
- **进程管理**: PM2 (可选)
- **反向代理**: Nginx (推荐)
- **数据库**: MySQL 服务器

### 📦 依赖版本

#### 后端核心依赖
```json
{
  "@nestjs/core": "^10.0.0",
  "@nestjs/common": "^10.0.0", 
  "@nestjs/platform-express": "^10.0.0",
  "@nestjs/swagger": "^7.0.0",
  "@nestjs/typeorm": "^10.0.0",
  "@nestjs/jwt": "^10.0.0",
  "@nestjs/passport": "^10.0.0",
  "typeorm": "^0.3.0",
  "mysql2": "^3.6.0",
  "passport-jwt": "^4.0.0",
  "bcrypt": "^5.1.0",
  "class-validator": "^0.14.0",
  "class-transformer": "^0.5.0"
}
```

#### 前端核心依赖
```json
{
  "next": "15.3.4",
  "react": "^18.0.0",
  "react-dom": "^18.0.0",
  "typescript": "^5.0.0",
  "tailwindcss": "^3.4.0",
  "@arco-design/web-react": "^2.62.0",
  "axios": "^1.6.0",
  "react-hook-form": "^7.48.0"
}
```

### 🚀 性能优化

#### 前端优化
- **代码分割**: Next.js 自动代码分割
- **图片优化**: Next.js Image组件
- **构建优化**: Turbopack 快速构建
- **缓存策略**: 浏览器缓存 + CDN

#### 后端优化
- **数据库连接池**: 复用数据库连接
- **查询优化**: TypeORM关系查询优化
- **缓存机制**: 内存缓存 (可扩展Redis)
- **API响应**: 数据压缩 + 分页

### 🛡️ 安全措施

#### 认证安全
- **JWT过期**: 访问令牌短期有效
- **密码策略**: 强密码要求
- **会话管理**: 安全的会话控制

#### 数据安全
- **SQL注入防护**: TypeORM参数化查询
- **XSS防护**: 输入验证和输出编码
- **CSRF防护**: CORS策略配置
- **文件上传**: 文件类型和大小限制

### 📱 兼容性

#### 浏览器支持
- **现代浏览器**: Chrome 90+, Firefox 88+, Safari 14+
- **移动端**: iOS Safari 14+, Chrome Mobile 90+
- **响应式**: 支持各种屏幕尺寸

#### Node.js版本
- **最低要求**: Node.js 18.18.0
- **推荐版本**: Node.js 20.x LTS
- **包管理器**: npm 8.0+ 或 yarn 1.22+

---

## 系统概览

物流配送管理系统是一个基于现代化技术栈的综合性管理平台，包含管理后台和小程序前端，提供完整的物流配送业务管理解决方案。

### 🎯 核心功能

- **客户管理**: 管理客户信息、联系方式和配送地址
- **用户管理**: 管理系统用户和权限分配
- **角色权限**: 灵活的权限控制和角色配置
- **司机管理**: 配送司机信息和车辆管理
- **打卡记录**: 配送打卡记录和轨迹追踪
- **数据统计**: 业务数据分析和报表

### 🏗️ 业务功能架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   小程序前端     │    │   管理后台       │    │   后端API       │
│   (司机端)      │    │   (管理员)      │    │   (业务逻辑)     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 客户搜索      │    │ • 客户管理      │    │ • 用户认证      │
│ • 导航路线      │    │ • 用户管理      │    │ • 权限控制      │
│ • 拍照打卡      │    │ • 角色权限      │    │ • 数据管理      │
│ • 新增客户      │    │ • 司机管理      │    │ • API接口       │
│                │    │ • 打卡记录      │    │ • 文件上传      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                │
                    ┌─────────────────┐
                    │   MySQL 数据库   │
                    │   (数据存储)     │
                    └─────────────────┘
```

---

## 客户管理模块

### 📝 功能概述

客户管理模块是系统的核心业务模块，提供完整的客户信息管理功能，支持客户信息的增删改查、搜索筛选和批量操作。

### 🔧 主要功能

#### 1. 客户信息管理

**功能特性:**
- ✅ 客户基本信息录入和维护
- ✅ 客户编号自动生成和手动指定
- ✅ 联系人信息管理
- ✅ 多地址支持
- ✅ 客户状态管理

**数据字段:**
- 客户编号（自动生成或手动输入）
- 客户名称
- 联系人姓名
- 联系电话
- 详细地址
- 客户地区（支持颜色标记）
- 创建时间
- 更新时间
- 更新人员

#### 2. 搜索和筛选

**搜索功能:**
- 🔍 客户编号模糊搜索
- 🔍 客户名称模糊搜索
- 🔍 客户地址筛选
- 🔍 实时搜索建议

**筛选条件:**
- 按客户地区筛选
- 按创建时间范围筛选
- 按更新状态筛选

#### 3. 批量操作

**支持操作:**
- 📤 批量导出客户数据
- 📥 批量导入客户信息
- 🗑️ 批量删除客户
- ✏️ 批量编辑客户信息

#### 4. 数据导入导出

**导出功能:**
- Excel格式导出
- 自定义字段选择
- 按条件筛选导出

**导入功能:**
- Excel模板下载
- 数据格式验证
- 导入结果反馈

### 💻 界面功能

#### 客户列表页面
- **表格展示**: 分页显示客户列表
- **快速操作**: 查看、编辑、删除按钮
- **批量选择**: 支持多选进行批量操作
- **状态显示**: 地区标签颜色区分

#### 客户编辑弹窗
- **表单验证**: 必填字段验证和格式校验
- **实时预览**: 地址信息实时显示
- **保存状态**: 保存进度提示

### 🎯 使用场景

1. **日常客户维护**: 录入新客户信息，更新现有客户资料
2. **配送路线规划**: 通过地址筛选规划配送路线
3. **客户数据分析**: 导出客户数据进行业务分析
4. **系统数据迁移**: 批量导入历史客户数据

---

## 用户权限管理模块

### 📝 功能概述

用户权限管理模块负责系统用户的统一管理，提供用户创建、权限分配、状态管理等功能，支持细粒度的权限控制。

### 🔧 主要功能

#### 1. 用户信息管理

**用户基本信息:**
- ✅ 用户名（唯一标识）
- ✅ 真实姓名
- ✅ 手机号码（唯一）
- ✅ 邮箱地址（可选）
- ✅ 性别信息
- ✅ 用户昵称
- ✅ 头像上传
- ✅ 最后登录时间

**用户类型:**
- 👨‍💼 **管理员**: 系统最高权限，可管理所有功能
- 🚛 **司机**: 配送司机，可查看客户信息和提交打卡
- 💼 **销售**: 销售人员，可管理客户信息

#### 2. 权限管理

**权限分配:**
- 🔐 基于角色的权限控制（RBAC）
- 🔐 细粒度权限设置
- 🔐 权限继承和覆盖
- 🔐 动态权限校验

**权限类别:**
- **系统管理**: 用户管理、角色管理、系统配置
- **业务管理**: 客户管理、司机管理、打卡记录
- **基础权限**: 个人信息查看和编辑

#### 3. 用户状态管理

**状态类型:**
- 🟢 **正常**: 用户可正常使用系统
- 🔴 **禁用**: 用户被禁止登录
- 🟡 **暂停**: 临时暂停使用权限

#### 4. 搜索和筛选

**搜索功能:**
- 🔍 用户名搜索
- 🔍 真实姓名搜索
- 🔍 手机号搜索
- 🔍 邮箱搜索

**筛选条件:**
- 按用户类型筛选
- 按用户状态筛选
- 按创建时间筛选

#### 5. 批量操作

**支持操作:**
- 👥 批量创建用户
- 🗑️ 批量删除用户
- 🔄 批量修改状态
- 📋 批量导出用户信息

### 💻 界面功能

#### 用户管理首页
- **统计面板**: 显示总用户数、各类型用户数量
- **用户列表**: 分页表格显示用户信息
- **快速操作**: 编辑、删除、状态切换

#### 用户编辑表单
- **基本信息**: 用户名、姓名、联系方式
- **权限设置**: 用户类型选择和状态设置
- **安全设置**: 密码设置（新建用户必填）

### 🎯 权限矩阵

| 功能模块 | 管理员 | 司机 | 销售 |
|---------|-------|------|------|
| 用户管理 | ✅ | ❌ | ❌ |
| 客户管理 | ✅ | 👁️ | ✅ |
| 司机管理 | ✅ | 👁️ | 👁️ |
| 打卡记录 | ✅ | ✏️ | 👁️ |
| 角色权限 | ✅ | ❌ | ❌ |
| 个人信息 | ✅ | ✅ | ✅ |

> 图例: ✅ 完全权限 | 👁️ 只读权限 | ✏️ 创建权限 | ❌ 无权限

---

## 角色权限管理模块

### 📝 功能概述

角色权限管理模块提供灵活的权限配置功能，支持自定义角色创建、权限分组管理和细粒度权限控制。

### 🔧 主要功能

#### 1. 角色管理

**角色信息:**
- ✅ 角色名称
- ✅ 角色ID（唯一标识）
- ✅ 角色描述
- ✅ 角色状态（启用/禁用）
- ✅ 关联用户数量
- ✅ 创建和修改时间

**预设角色:**
- 👨‍💼 **管理员**: 拥有所有系统权限
- 🚛 **司机**: 配送相关权限
- 💼 **销售**: 客户管理权限

#### 2. 权限配置

**权限分组:**

**🔧 系统管理**
- `user_manage`: 用户管理
- `statistics_view`: 数据统计

**📋 业务管理**
- `customer_manage`: 客户管理
- `customer_view`: 客户查看
- `driver_manage`: 司机管理
- `driver_view`: 司机查看
- `checkin_manage`: 打卡记录管理
- `checkin_view`: 打卡查看
- `checkin_submit`: 打卡提交

**👤 基础权限**
- `profile_view`: 个人信息查看
- `profile_edit`: 个人信息编辑

#### 3. 权限矩阵

**权限配置示例:**

| 权限代码 | 管理员 | 司机 | 销售 | 描述 |
|---------|-------|------|------|------|
| user_manage | ✅ | ❌ | ❌ | 用户管理权限 |
| customer_manage | ✅ | ❌ | ✅ | 客户完整管理 |
| customer_view | ✅ | ✅ | ✅ | 客户信息查看 |
| checkin_submit | ✅ | ✅ | ❌ | 打卡记录提交 |
| statistics_view | ✅ | ❌ | ❌ | 数据统计查看 |

#### 4. 角色分配

**分配功能:**
- 👥 用户角色分配
- 🔄 角色切换记录
- 📊 角色使用统计
- ⚠️ 权限变更通知

### 💻 界面功能

#### 角色列表页面
- **角色卡片**: 显示角色信息和权限数量
- **用户统计**: 每个角色的用户数量
- **状态管理**: 角色启用/禁用控制

#### 角色编辑页面
- **基本信息**: 角色名称、ID、描述
- **权限选择**: 分组权限多选
- **预览功能**: 权限配置预览

### 🔐 权限验证机制

#### 后端权限验证
```typescript
// CASL权限验证示例
@UseGuards(JwtAuthGuard, PoliciesGuard)
@CheckPolicies((ability: AppAbility) => ability.can(Action.Read, Customer))
@Get()
async findAll() {
  // 权限验证通过后执行
}
```

#### 前端权限控制
```typescript
// 权限组件示例
<PermissionWrapper permission="customer_manage">
  <Button>编辑客户</Button>
</PermissionWrapper>
```

---

## 司机管理模块

### 📝 功能概述

司机管理模块专门管理配送司机的信息，包括司机档案、车辆信息、配送区域等，与用户管理模块联动。

### 🔧 主要功能

#### 1. 司机档案管理

**基本信息:**
- ✅ 司机编号（自动生成）
- ✅ 司机姓名
- ✅ 身份证号
- ✅ 手机号码
- ✅ 紧急联系人
- ✅ 入职时间
- ✅ 司机状态

#### 2. 车辆信息管理

**车辆档案:**
- 🚛 车牌号码
- 🚛 车辆类型
- 🚛 载重吨位
- 🚛 车辆状态
- 🚛 保险信息
- 🚛 年检记录

#### 3. 配送区域分配

**区域管理:**
- 📍 负责区域设置
- 📍 配送路线规划
- 📍 区域权限控制

---

## 打卡记录模块

### 📝 功能概述

打卡记录模块记录司机的配送打卡信息，包括位置信息、打卡照片、时间记录等，提供配送轨迹追踪。

### 🔧 主要功能

#### 1. 打卡记录管理

**记录信息:**
- ✅ 打卡时间
- ✅ 打卡位置（GPS坐标）
- ✅ 打卡照片
- ✅ 客户信息
- ✅ 司机信息
- ✅ 备注说明

#### 2. 地图轨迹

**轨迹功能:**
- 🗺️ 配送路线显示
- 🗺️ 打卡点标记
- 🗺️ 实时位置追踪

#### 3. 数据统计

**统计报表:**
- 📊 日/周/月打卡统计
- 📊 司机配送效率
- 📊 区域配送分析

---

## 小程序端功能

### 📝 功能概述

小程序端主要为配送司机提供移动端操作界面，支持客户搜索、导航、打卡等核心配送功能。

### 🔧 主要功能

#### 1. 客户搜索与导航

**搜索功能:**
- 🔍 客户编号搜索
- 🔍 客户姓名搜索
- 🔍 地址模糊搜索
- 🔍 历史记录

**导航功能:**
- 🧭 高德地图导航
- 🧭 多目的地路线规划
- 🧭 实时路况信息

#### 2. 拍照打卡

**打卡功能:**
- 📸 现场拍照
- 📍 GPS定位
- ⏰ 自动时间记录
- 📝 备注信息

#### 3. 新增客户

**客户录入:**
- ✏️ 客户基本信息
- 📍 地址信息录入
- 📞 联系方式
- 🎯 GPS定位辅助

### 📱 界面设计

#### 主界面
- **快捷功能**: 搜索、打卡、新增客户
- **工作统计**: 今日打卡数、配送完成数
- **消息通知**: 系统通知、任务提醒

#### 客户搜索页
- **搜索框**: 支持多种搜索方式
- **筛选器**: 按区域、状态筛选
- **结果列表**: 客户信息列表显示

#### 打卡页面
- **相机界面**: 拍照功能
- **位置信息**: 当前GPS位置
- **客户确认**: 确认配送客户
- **提交按钮**: 一键提交打卡

---

## 🚀 技术实现

### 后端技术栈
- **框架**: NestJS + TypeScript
- **数据库**: MySQL + TypeORM
- **认证**: JWT + Passport
- **权限**: CASL
- **文档**: Swagger

### 前端技术栈
- **框架**: Next.js + React + TypeScript
- **UI组件**: Arco Design
- **样式**: TailwindCSS
- **状态管理**: React Hooks
- **HTTP客户端**: Axios

### 数据库设计
- **用户表**: 存储用户基本信息
- **角色表**: 角色定义和权限配置
- **客户表**: 客户信息和地址
- **打卡表**: 打卡记录和轨迹
- **司机表**: 司机档案和车辆信息

---

## 📞 技术支持

如需了解更多技术细节或遇到使用问题，请参考：

- [项目报价方案](./项目报价方案.md) - 详细的开发规划
- [部署启动指南](./部署启动指南.md) - 完整的部署说明
- [README.md](./README.md) - 快速启动指南

---

**更新时间**: 2024年6月20日  
**文档版本**: v1.0.0 