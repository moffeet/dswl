# å¯†ç ä¿®æ”¹æ¥å£è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

ä¸ºäº†æé«˜ç³»ç»Ÿå®‰å…¨æ€§ï¼Œæˆ‘ä»¬å°†å¯†ç ä¿®æ”¹åŠŸèƒ½æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æ¥å£ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼š

1. **é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç ** - `/auth/change-password`
2. **ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç ** - `/auth/update-password`

## ğŸ”— æ¥å£è¯¦æƒ…

### 1. é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /api/auth/change-password`

**ä½¿ç”¨åœºæ™¯ï¼š**
- æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•
- ç®¡ç†å‘˜é‡ç½®å¯†ç åçš„é¦–æ¬¡ç™»å½•
- ç³»ç»Ÿå¼ºåˆ¶è¦æ±‚ä¿®æ”¹å¯†ç çš„åœºæ™¯

**å®‰å…¨ç‰¹æ€§ï¼š**
- âŒ **ä¸éœ€è¦**éªŒè¯åŸå¯†ç ï¼ˆå› ä¸ºæ˜¯å¼ºåˆ¶ä¿®æ”¹ï¼‰
- âœ… æ”¯æŒåŠ å¯†ä¼ è¾“
- âœ… å¯†ç æ ¼å¼éªŒè¯
- âœ… é˜²æ­¢ä¸ç”¨æˆ·åç›¸åŒ

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
{
  userId: number;           // ç”¨æˆ·ID
  newPassword: string;      // æ–°å¯†ç ï¼ˆå¯èƒ½æ˜¯åŠ å¯†çš„ï¼‰
  timestamp?: number;       // æ—¶é—´æˆ³ï¼ˆåŠ å¯†ä¼ è¾“æ—¶ä½¿ç”¨ï¼‰
  signature?: string;       // æ•°å­—ç­¾åï¼ˆåŠ å¯†ä¼ è¾“æ—¶ä½¿ç”¨ï¼‰
  _encrypted?: boolean;     // æ˜¯å¦ä¸ºåŠ å¯†æ•°æ®
}
```

**å‰ç«¯é¡µé¢ï¼š** `/change-password`

---

### 2. ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /api/auth/update-password`

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç”¨æˆ·åœ¨ä¸ªäººè®¾ç½®ä¸­ä¿®æ”¹å¯†ç 
- å®šæœŸæ›´æ¢å¯†ç çš„å®‰å…¨éœ€æ±‚
- æ€€ç–‘å¯†ç æ³„éœ²æ—¶çš„ä¸»åŠ¨æ›´æ¢

**å®‰å…¨ç‰¹æ€§ï¼š**
- âœ… **å¿…é¡»**éªŒè¯åŸå¯†ç 
- âœ… éœ€è¦JWT tokenè®¤è¯
- âœ… æ”¯æŒåŠ å¯†ä¼ è¾“
- âœ… å¯†ç æ ¼å¼éªŒè¯
- âœ… é˜²æ­¢æ–°æ—§å¯†ç ç›¸åŒ

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
{
  oldPassword: string;      // åŸå¯†ç ï¼ˆå¯èƒ½æ˜¯åŠ å¯†çš„ï¼‰
  newPassword: string;      // æ–°å¯†ç ï¼ˆå¯èƒ½æ˜¯åŠ å¯†çš„ï¼‰
  timestamp?: number;       // æ—¶é—´æˆ³ï¼ˆåŠ å¯†ä¼ è¾“æ—¶ä½¿ç”¨ï¼‰
  signature?: string;       // æ•°å­—ç­¾åï¼ˆåŠ å¯†ä¼ è¾“æ—¶ä½¿ç”¨ï¼‰
  _encrypted?: boolean;     // æ˜¯å¦ä¸ºåŠ å¯†æ•°æ®
}
```

**å‰ç«¯é¡µé¢ï¼š** `/update-password`

## ğŸ›¡ï¸ å®‰å…¨å¯¹æ¯”

| ç‰¹æ€§ | é¦–æ¬¡ç™»å½•ä¿®æ”¹ | ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹ |
|------|-------------|-------------|
| éªŒè¯åŸå¯†ç  | âŒ ä¸éœ€è¦ | âœ… å¿…é¡»éªŒè¯ |
| JWTè®¤è¯ | âŒ ä¸éœ€è¦ | âœ… å¿…é¡»è®¤è¯ |
| åŠ å¯†ä¼ è¾“ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å¯†ç æ ¼å¼éªŒè¯ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| é˜²é‡å¤å¯†ç  | âœ… ä¸ç”¨æˆ·å | âœ… ä¸åŸå¯†ç  |

## ğŸ¯ ä½¿ç”¨æµç¨‹

### é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç æµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·ç™»å½•] --> B{æ˜¯å¦é¦–æ¬¡ç™»å½•?}
    B -->|æ˜¯| C[è·³è½¬åˆ°ä¿®æ”¹å¯†ç é¡µé¢]
    C --> D[è¾“å…¥æ–°å¯†ç ]
    D --> E[è°ƒç”¨ /auth/change-password]
    E --> F[ä¿®æ”¹æˆåŠŸï¼Œè·³è½¬ç™»å½•é¡µ]
    B -->|å¦| G[æ­£å¸¸ç™»å½•æˆåŠŸ]
```

### ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç æµç¨‹
```mermaid
graph TD
    A[å·²ç™»å½•ç”¨æˆ·] --> B[ç‚¹å‡»ä¿®æ”¹å¯†ç ]
    B --> C[è·³è½¬åˆ°ä¿®æ”¹å¯†ç é¡µé¢]
    C --> D[è¾“å…¥åŸå¯†ç å’Œæ–°å¯†ç ]
    D --> E[è°ƒç”¨ /auth/update-password]
    E --> F{éªŒè¯åŸå¯†ç }
    F -->|æˆåŠŸ| G[ä¿®æ”¹æˆåŠŸï¼Œé‡æ–°ç™»å½•]
    F -->|å¤±è´¥| H[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
```

## ğŸ“ æ–‡ä»¶ç»“æ„

### åç«¯æ–‡ä»¶
```
backend-node/src/auth/
â”œâ”€â”€ auth.controller.ts     # ä¸¤ä¸ªå¯†ç ä¿®æ”¹æ¥å£
â”œâ”€â”€ auth.service.ts        # å¯†ç ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
â””â”€â”€ utils/crypto.util.ts   # å¯†ç åŠ å¯†è§£å¯†å·¥å…·
```

### å‰ç«¯æ–‡ä»¶
```
admin-frontend/src/app/
â”œâ”€â”€ change-password/       # é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç é¡µé¢
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ update-password/       # ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç é¡µé¢
â”‚   â””â”€â”€ page.tsx
â””â”€â”€ page.tsx              # ä¸»é¡µï¼ˆæ·»åŠ äº†ä¿®æ”¹å¯†ç å…¥å£ï¼‰
```

## ğŸ”§ æŠ€æœ¯å®ç°

### å¯†ç éªŒè¯é€»è¾‘
```typescript
// é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç ï¼ˆAuthService.changePasswordï¼‰
async changePassword(userId: number, newPassword: string): Promise<void> {
  // ä¸éªŒè¯åŸå¯†ç ï¼Œç›´æ¥æ›´æ–°
  await this.usersService.changePassword(userId, newPassword);
}

// ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç ï¼ˆAuthService.updatePasswordï¼‰
async updatePassword(userId: number, oldPassword: string, newPassword: string): Promise<void> {
  // 1. éªŒè¯åŸå¯†ç 
  const isOldPasswordValid = await bcrypt.compare(oldPassword, user.password);
  
  // 2. éªŒè¯æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ç›¸åŒ
  const isSamePassword = await bcrypt.compare(newPassword, user.password);
  
  // 3. æ›´æ–°å¯†ç 
  await this.usersService.changePassword(userId, newPassword);
}
```

### å‰ç«¯åŠ å¯†ä¼ è¾“
```typescript
// ä¸¤ä¸ªæ¥å£éƒ½æ”¯æŒç›¸åŒçš„åŠ å¯†æ–¹å¼
const secureData = createSecureLoginData('', password);
const requestData = {
  password: secureData.password,    // åŠ å¯†åçš„å¯†ç 
  timestamp: secureData.timestamp,
  signature: secureData.signature,
  _encrypted: true
};
```

## ğŸ“ APIå“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "code": 200,
  "message": "å¯†ç ä¿®æ”¹æˆåŠŸ",
  "data": null
}
```

### é”™è¯¯å“åº”
```json
{
  "code": 401,
  "message": "åŸå¯†ç é”™è¯¯",
  "data": null
}
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **åç«¯éƒ¨ç½²**ï¼šæ— éœ€é¢å¤–é…ç½®ï¼Œæ¥å£å·²é›†æˆåˆ°ç°æœ‰è®¤è¯æ¨¡å—
2. **å‰ç«¯éƒ¨ç½²**ï¼šæ–°å¢é¡µé¢ä¼šè‡ªåŠ¨åŒ…å«åœ¨æ„å»ºä¸­
3. **æ•°æ®åº“**ï¼šæ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„
4. **å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

## âœ… æµ‹è¯•å»ºè®®

### é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç æµ‹è¯•
1. åˆ›å»ºæ–°ç”¨æˆ·
2. ä½¿ç”¨é»˜è®¤å¯†ç ç™»å½•
3. éªŒè¯æ˜¯å¦è·³è½¬åˆ°ä¿®æ”¹å¯†ç é¡µé¢
4. æµ‹è¯•å¯†ç æ ¼å¼éªŒè¯
5. æµ‹è¯•ä¿®æ”¹æˆåŠŸåçš„ç™»å½•

### ç”¨æˆ·ä¸»åŠ¨ä¿®æ”¹å¯†ç æµ‹è¯•
1. æ­£å¸¸ç™»å½•ç”¨æˆ·
2. è®¿é—®ä¿®æ”¹å¯†ç é¡µé¢
3. æµ‹è¯•åŸå¯†ç éªŒè¯
4. æµ‹è¯•æ–°å¯†ç æ ¼å¼éªŒè¯
5. æµ‹è¯•ä¿®æ”¹æˆåŠŸåéœ€è¦é‡æ–°ç™»å½•

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **å¯†ç å¼ºåº¦æ£€æµ‹**ï¼šå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„å¯†ç å¼ºåº¦è¦æ±‚
2. **å¯†ç å†å²è®°å½•**ï¼šé˜²æ­¢ä½¿ç”¨æœ€è¿‘ä½¿ç”¨è¿‡çš„å¯†ç 
3. **ä¿®æ”¹é¢‘ç‡é™åˆ¶**ï¼šé˜²æ­¢é¢‘ç¹ä¿®æ”¹å¯†ç 
4. **é‚®ä»¶é€šçŸ¥**ï¼šå¯†ç ä¿®æ”¹åå‘é€é‚®ä»¶é€šçŸ¥
5. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•å¯†ç ä¿®æ”¹æ“ä½œçš„è¯¦ç»†æ—¥å¿—
