# ç™»å½•æ¥å£å®‰å…¨æœºåˆ¶è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ç‰©æµé…é€ç®¡ç†ç³»ç»Ÿçš„ç™»å½•æ¥å£å®ç°ï¼ŒåŒ…æ‹¬å¯†ç åŠ å¯†ä¼ è¾“ã€é˜²é‡æ”¾æ”»å‡»ã€æ•°æ®å®Œæ•´æ€§éªŒè¯ç­‰å®‰å…¨æœºåˆ¶ã€‚

## ğŸ” å®‰å…¨æ¶æ„

### æ ¸å¿ƒå®‰å…¨ç‰¹æ€§
- âœ… **å¯†ç åŠ å¯†ä¼ è¾“**ï¼šå‰ç«¯åŠ å¯†ï¼Œåç«¯è§£å¯†
- âœ… **é˜²é‡æ”¾æ”»å‡»**ï¼šæ—¶é—´æˆ³éªŒè¯æœºåˆ¶
- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šæ•°å­—ç­¾åéªŒè¯
- âœ… **å‘åå…¼å®¹**ï¼šæ”¯æŒæ˜æ–‡å’ŒåŠ å¯†ä¸¤ç§æ¨¡å¼
- âœ… **JWTè®¤è¯**ï¼šå®‰å…¨çš„ä»¤ç‰Œç®¡ç†

## ğŸ“¡ æ¥å£è¯¦æƒ…

### ç™»å½•æ¥å£
- **æ¥å£åœ°å€**ï¼š`POST /api/auth/login`
- **å¼ºåˆ¶ç™»å½•**ï¼š`POST /api/auth/login/force`
- **ç”¨æˆ·ä¿¡æ¯**ï¼š`GET /api/auth/profile`
- **ç™»å‡ºæ¥å£**ï¼š`POST /api/auth/logout`

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹

### 1. å‰ç«¯åŠ å¯†æµç¨‹

```typescript
// 1. ç”¨æˆ·è¾“å…¥å¯†ç 
const loginForm = {
  username: 'admin',
  password: '123456'  // æ˜æ–‡å¯†ç 
};

// 2. åˆ›å»ºå®‰å…¨æ•°æ®åŒ…
const secureData = createSecureLoginData(username, password);
```

#### åŠ å¯†ç®—æ³•è¯¦è§£
```typescript
export function encryptPassword(password: string): string {
  // Step 1: åˆ›å»ºæ•°æ®åŒ…
  const data = {
    password: '123456',           // åŸå§‹å¯†ç 
    timestamp: 1704387123456,     // å½“å‰æ—¶é—´æˆ³
    nonce: 'abc123'              // éšæœºæ•°
  };
  
  // Step 2: JSONåºåˆ—åŒ–
  const jsonData = JSON.stringify(data);
  
  // Step 3: Base64ç¼–ç 
  const base64Data = btoa(jsonData);
  
  // Step 4: XORåŠ å¯†
  const encrypted = base64Data
    .split('')
    .map((char, index) => {
      const keyChar = ENCRYPTION_KEY.charCodeAt(index % ENCRYPTION_KEY.length);
      return String.fromCharCode(char.charCodeAt(0) ^ keyChar);
    })
    .join('');
  
  // Step 5: å†æ¬¡Base64ç¼–ç 
  return btoa(encrypted);
}
```

#### æ•°å­—ç­¾åç”Ÿæˆ
```typescript
export function generateSignature(data: string): string {
  let hash = 0;
  for (let i = 0; i < data.length; i++) {
    const char = data.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32-bit integer
  }
  return Math.abs(hash).toString(36);
}

// ç­¾åè®¡ç®—
const signature = generateSignature(`${username}${encryptedPassword}${timestamp}`);
```

### 2. ä¼ è¾“æ•°æ®æ ¼å¼

#### åŠ å¯†ä¼ è¾“æ ¼å¼
```json
{
  "username": "admin",
  "password": "U2FsdGVkX1/8K7gWn5W2...", 
  "timestamp": 1704387123456,
  "signature": "a7b8c9d",
  "_encrypted": true
}
```

#### å…¼å®¹æ˜æ–‡æ ¼å¼
```json
{
  "username": "admin",
  "password": "123456"
}
```

### 3. åç«¯è§£å¯†æµç¨‹

```typescript
async login(loginDto: LoginDto, req?: any): Promise<LoginResponseDto> {
  let actualPassword: string;
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºåŠ å¯†æ•°æ®
  if (loginDto._encrypted && loginDto.timestamp && loginDto.signature) {
    console.log('æ£€æµ‹åˆ°åŠ å¯†ç™»å½•æ•°æ®ï¼Œå¼€å§‹è§£å¯†å¤„ç†');
    
    // Step 1: éªŒè¯æ•°å­—ç­¾å
    if (!validateSignature(loginDto.username, loginDto.password, 
                          loginDto.timestamp, loginDto.signature)) {
      throw new UnauthorizedException('æ•°æ®ç­¾åéªŒè¯å¤±è´¥');
    }
    
    // Step 2: éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
    if (!validateTimestamp(loginDto.timestamp)) {
      throw new UnauthorizedException('è¯·æ±‚å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
    }
    
    // Step 3: è§£å¯†å¯†ç 
    const decryptedData = decryptPassword(loginDto.password);
    actualPassword = decryptedData.password;
    
  } else {
    // å…¼å®¹æ˜æ–‡å¯†ç 
    actualPassword = loginDto.password;
  }
  
  // Step 4: æ­£å¸¸ç™»å½•éªŒè¯æµç¨‹
  const user = await this.validateUser(loginDto.username, actualPassword);
  // ...
}
```

#### è§£å¯†ç®—æ³•è¯¦è§£
```typescript
export function decryptPassword(encryptedData: string): {
  password: string;
  timestamp: number;
  nonce: string;
} {
  // Step 1: ç¬¬ä¸€æ¬¡Base64è§£ç 
  const firstDecoded = Buffer.from(encryptedData, 'base64').toString();
  
  // Step 2: XORè§£å¯†ï¼ˆé€†å‘åŠ å¯†è¿‡ç¨‹ï¼‰
  const decrypted = firstDecoded
    .split('')
    .map((char, index) => {
      const keyChar = ENCRYPTION_KEY.charCodeAt(index % ENCRYPTION_KEY.length);
      return String.fromCharCode(char.charCodeAt(0) ^ keyChar);
    })
    .join('');
  
  // Step 3: ç¬¬äºŒæ¬¡Base64è§£ç 
  const jsonData = Buffer.from(decrypted, 'base64').toString();
  
  // Step 4: JSONè§£æ
  return JSON.parse(jsonData);
}
```

### 4. å®‰å…¨éªŒè¯æœºåˆ¶

#### æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
```typescript
export function validateTimestamp(timestamp: number, maxAgeMs: number = 5 * 60 * 1000): boolean {
  const now = Date.now();
  const age = now - timestamp;
  
  // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨5åˆ†é’Ÿå†…
  return age >= 0 && age <= maxAgeMs;
}
```

#### æ•°å­—ç­¾åéªŒè¯
```typescript
export function validateSignature(
  username: string,
  encryptedPassword: string, 
  timestamp: number,
  signature: string
): boolean {
  const expectedSignature = generateSignature(`${username}${encryptedPassword}${timestamp}`);
  return expectedSignature === signature;
}
```

### 5. JWT Tokenç”Ÿæˆ

```typescript
// ç”ŸæˆJWTè½½è·
const payload = {
  sub: user.id,
  username: user.username,
  nickname: user.nickname,
  roles: user.roles || [],
  userType: 'admin',
  exp: Math.floor(Date.now() / 1000) + (60 * 60), // 1å°æ—¶è¿‡æœŸ
  iat: Math.floor(Date.now() / 1000)
};

const accessToken = this.jwtService.sign(payload);
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§è¯¦è§£

### 1. å¤šå±‚åŠ å¯†ä¿æŠ¤

| å±‚çº§ | ç®—æ³• | ä½œç”¨ |
|------|------|------|
| 1 | JSONåºåˆ—åŒ– | æ•°æ®ç»“æ„åŒ– |
| 2 | Base64ç¼–ç  | äºŒè¿›åˆ¶å®‰å…¨ |
| 3 | XORåŠ å¯† | å†…å®¹æ··æ·† |
| 4 | å†æ¬¡Base64 | ä¼ è¾“å®‰å…¨ |

### 2. é˜²é‡æ”¾æ”»å‡»æœºåˆ¶

```typescript
// å‰ç«¯ï¼šæ·»åŠ æ—¶é—´æˆ³
const timestamp = Date.now();

// åç«¯ï¼šéªŒè¯æ—¶é—´çª—å£
const maxAge = 5 * 60 * 1000; // 5åˆ†é’Ÿ
if (now - timestamp > maxAge) {
  throw new Error('è¯·æ±‚å·²è¿‡æœŸ');
}
```

### 3. æ•°æ®å®Œæ•´æ€§ä¿æŠ¤

```typescript
// ç­¾åæ•°æ®åŒ…å«ï¼šç”¨æˆ·å + åŠ å¯†å¯†ç  + æ—¶é—´æˆ³
const dataToSign = `${username}${encryptedPassword}${timestamp}`;
const signature = generateSignature(dataToSign);
```

## ğŸš¨ é”™è¯¯å¤„ç†æœºåˆ¶

### å®¢æˆ·ç«¯é”™è¯¯
- **å¯†ç åŠ å¯†å¤±è´¥**ï¼šæç¤ºç”¨æˆ·é‡è¯•
- **ç½‘ç»œé”™è¯¯**ï¼šæ˜¾ç¤ºç½‘ç»œè¿æ¥å¤±è´¥
- **æœåŠ¡å™¨é”™è¯¯**ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

### æœåŠ¡ç«¯é”™è¯¯
- **ç­¾åéªŒè¯å¤±è´¥**ï¼š`æ•°æ®ç­¾åéªŒè¯å¤±è´¥`
- **æ—¶é—´æˆ³è¿‡æœŸ**ï¼š`è¯·æ±‚å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•`
- **è§£å¯†å¤±è´¥**ï¼š`å¯†ç è§£å¯†å¤±è´¥`
- **ç”¨æˆ·éªŒè¯å¤±è´¥**ï¼š`ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯`

## ğŸ“Š æ•°æ®æµè½¬å›¾

```mermaid
sequenceDiagram
    participant F as å‰ç«¯
    participant B as åç«¯
    participant D as æ•°æ®åº“
    
    F->>F: 1. ç”¨æˆ·è¾“å…¥å¯†ç 
    F->>F: 2. åŠ å¯†å¯†ç +æ—¶é—´æˆ³+ç­¾å
    F->>B: 3. å‘é€åŠ å¯†æ•°æ®
    B->>B: 4. éªŒè¯ç­¾å
    B->>B: 5. éªŒè¯æ—¶é—´æˆ³
    B->>B: 6. è§£å¯†å¯†ç 
    B->>D: 7. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    D->>B: 8. è¿”å›ç”¨æˆ·æ•°æ®
    B->>B: 9. bcryptéªŒè¯å¯†ç 
    B->>B: 10. ç”ŸæˆJWT token
    B->>F: 11. è¿”å›tokenå’Œç”¨æˆ·ä¿¡æ¯
    F->>F: 12. å­˜å‚¨tokenï¼Œè·³è½¬é¡µé¢
```

## ğŸ”§ é…ç½®è¯´æ˜

### å‰ç«¯é…ç½®
```typescript
// crypto.ts
const ENCRYPTION_KEY = 'logistics-frontend-2024-secure-key-v1';
```

### åç«¯é…ç½®  
```typescript
// crypto.util.ts
const ENCRYPTION_KEY = 'logistics-frontend-2024-secure-key-v1'; // å¿…é¡»ä¸å‰ç«¯ä¸€è‡´

// JWTé…ç½®
const JWT_SECRET = process.env.JWT_SECRET || 'logistics-system-jwt-secret-2024';
```

### ç¯å¢ƒå˜é‡
```bash
# .env
JWT_SECRET=your-super-secret-jwt-key-2024
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=123456
DB_DATABASE=logistics_db
```

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. HTTPSéƒ¨ç½²
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 2. å®‰å…¨å¢å¼ºé…ç½®
```typescript
// ç”Ÿäº§ç¯å¢ƒé…ç½®
const PRODUCTION_CONFIG = {
  // æ›´çŸ­çš„æ—¶é—´çª—å£
  maxTimestampAge: 2 * 60 * 1000, // 2åˆ†é’Ÿ
  
  // æ›´å¼ºçš„åŠ å¯†
  encryptionAlgorithm: 'AES-256-GCM',
  
  // åŠ¨æ€å¯†é’¥
  keyRotationInterval: 24 * 60 * 60 * 1000, // 24å°æ—¶
  
  // JWTçŸ­æœŸåŒ–
  jwtExpiration: '15m',
  refreshTokenExpiration: '7d'
};
```

### 3. ç›‘æ§å’Œæ—¥å¿—
```typescript
// å®‰å…¨äº‹ä»¶ç›‘æ§
const securityLogger = {
  loginAttempt: (username, ip, success) => {
    console.log(`Login attempt: ${username} from ${ip} - ${success ? 'SUCCESS' : 'FAILED'}`);
  },
  
  encryptionError: (error, ip) => {
    console.error(`Encryption error from ${ip}:`, error);
  },
  
  timestampError: (timestamp, ip) => {
    console.warn(`Timestamp validation failed from ${ip}: ${timestamp}`);
  }
};
```

## ğŸ” è°ƒè¯•å’Œæµ‹è¯•

### å‰ç«¯è°ƒè¯•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹åŠ å¯†è¿‡ç¨‹
console.log('=== å¯†ç åŠ å¯†ä¼ è¾“ ===');
console.log('åŸå§‹å¯†ç é•¿åº¦:', password.length);
console.log('åŠ å¯†åæ•°æ®:', secureData);
```

### åç«¯è°ƒè¯•
```typescript
// åœ¨æœåŠ¡å™¨æ—¥å¿—æŸ¥çœ‹è§£å¯†è¿‡ç¨‹
console.log('æ£€æµ‹åˆ°åŠ å¯†ç™»å½•æ•°æ®ï¼Œå¼€å§‹è§£å¯†å¤„ç†');
console.log('å¯†ç è§£å¯†æˆåŠŸ');
console.log('âœ… ç™»å½•æˆåŠŸ - å¯†ç åŠ å¯†ä¼ è¾“æœ‰æ•ˆ');
```

### APIæµ‹è¯•
```bash
# æµ‹è¯•åŠ å¯†ç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "SGVhZGVyIERhdGE6...",
    "timestamp": 1704387123456,
    "signature": "a7b8c9d",
    "_encrypted": true
  }'

# æµ‹è¯•å…¼å®¹æ€§ç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin", 
    "password": "123456"
  }'
```

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### åŠ å¯†æ€§èƒ½
- **å‰ç«¯åŠ å¯†**ï¼š~1-2msï¼ˆå®¢æˆ·ç«¯CPUï¼‰
- **åç«¯è§£å¯†**ï¼š~1-3msï¼ˆæœåŠ¡å™¨CPUï¼‰  
- **æ€»ä½“å½±å“**ï¼šå¯å¿½ç•¥ä¸è®¡

### ç½‘ç»œä¼ è¾“
- **æ˜æ–‡å¤§å°**ï¼š~50 bytes
- **åŠ å¯†å¤§å°**ï¼š~200-300 bytes
- **å¢åŠ é‡**ï¼š4-6å€ï¼ˆå¯æ¥å—ï¼‰

## ğŸ”„ å‡çº§è·¯å¾„

### Phase 1 - å½“å‰å®ç°
- âœ… Base64 + XORåŠ å¯†
- âœ… æ—¶é—´æˆ³é˜²é‡æ”¾
- âœ… æ•°å­—ç­¾åéªŒè¯

### Phase 2 - å¢å¼ºç‰ˆæœ¬  
- ğŸ”„ RSA/AESå¼ºåŠ å¯†
- ğŸ”„ åŠ¨æ€å¯†é’¥äº¤æ¢
- ğŸ”„ è¯ä¹¦ç»‘å®šéªŒè¯

### Phase 3 - ä¼ä¸šçº§
- ğŸ”„ ç¡¬ä»¶å®‰å…¨æ¨¡å—
- ğŸ”„ å¤šå› å­è®¤è¯
- ğŸ”„ ç”Ÿç‰©è¯†åˆ«é›†æˆ

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-20)
- âœ¨ å®ç°å¯†ç åŠ å¯†ä¼ è¾“
- âœ¨ æ·»åŠ é˜²é‡æ”¾æ”»å‡»æœºåˆ¶  
- âœ¨ é›†æˆæ•°å­—ç­¾åéªŒè¯
- âœ¨ ä¿æŒå‘åå…¼å®¹æ€§
- ğŸ“š å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

---

**æ³¨æ„**ï¼šæœ¬æ–‡æ¡£åŒ…å«æ•æ„Ÿçš„å®‰å…¨å®ç°ç»†èŠ‚ï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ç»™æœªæˆæƒäººå‘˜ã€‚ 