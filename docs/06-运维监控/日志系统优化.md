# æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š
1. âœ… æ•°æ®åº“æ—¥å¿—ç›´æ¥ç”¨consoleè¾“å‡º â†’ ä½¿ç”¨Winstonç»Ÿä¸€ç®¡ç†
2. âœ… ç¼ºå°‘è¯·æ±‚IDè¿½è¸ª â†’ æ·»åŠ TraceIdè‡ªåŠ¨è¿½è¸ª
3. âœ… æ—¥å¿—å½’æ¡£å¤„ç† â†’ æŒ‰å‘¨è‡ªåŠ¨å½’æ¡£å’Œæ¸…ç†
4. âœ… æ—¥å¿—ç®¡ç†æ¥å£ â†’ æä¾›APIæŸ¥çœ‹å’Œæœç´¢æ—¥å¿—

## ğŸ”§ ç³»ç»Ÿæ¶æ„

### æ—¥å¿—åˆ†ç±»
- **backend.log** - å½“å‰åº”ç”¨æ—¥å¿—
- **error.log** - å½“å‰é”™è¯¯æ—¥å¿—
- **database.log** - å½“å‰æ•°æ®åº“æ“ä½œæ—¥å¿—
- **security.log** - å½“å‰å®‰å…¨ç›¸å…³æ—¥å¿—
- **backend-YYYY-MM-DD.log** - å½’æ¡£çš„åº”ç”¨æ—¥å¿—
- **error-YYYY-MM-DD.log** - å½’æ¡£çš„é”™è¯¯æ—¥å¿—
- **database-YYYY-MM-DD.log** - å½’æ¡£çš„æ•°æ®åº“æ—¥å¿—
- **security-YYYY-MM-DD.log** - å½’æ¡£çš„å®‰å…¨æ—¥å¿—

### å½’æ¡£ç­–ç•¥
- **æŒ‰æ—¥å½’æ¡£**: æ¯å¤©ä¸€ä¸ªå½’æ¡£æ–‡ä»¶ (ä¾‹: backend-2025-01-09.log)
- **å½“å‰æ—¥å¿—**: æ­£åœ¨è®°å½•çš„æ—¥å¿—ä¿æŒåŸå (ä¾‹: backend.log)
- **è‡ªåŠ¨å‹ç¼©**: æ—§æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨å‹ç¼©ä¸º.gzæ ¼å¼
- **ä¿ç•™æœŸé™**: ä¿ç•™æœ€è¿‘90å¤©çš„æ—¥å¿—æ–‡ä»¶
- **è‡ªåŠ¨æ¸…ç†**: æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—

## ğŸš€ æ–°å¢åŠŸèƒ½

### 1. è¯·æ±‚è¿½è¸ªID (TraceId)
æ¯ä¸ªHTTPè¯·æ±‚è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„è¿½è¸ªIDï¼Œæ ¼å¼ï¼š`æ—¶é—´æˆ³-éšæœºå­—ç¬¦ä¸²`

```typescript
// ç¤ºä¾‹TraceId: 1704067200000-abc123def
// åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºä¸º: [1704067200000-abc123def]
```

### 2. è‡ªåŠ¨æ—¥å¿—è®°å½•
- **è¯·æ±‚å¼€å§‹**: è®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€IPç­‰ä¿¡æ¯
- **è¯·æ±‚å®Œæˆ**: è®°å½•å“åº”çŠ¶æ€ç ã€è€—æ—¶
- **è¯·æ±‚å¤±è´¥**: è®°å½•é”™è¯¯ä¿¡æ¯å’Œå †æ ˆ

### 3. æ•°æ®åº“æ—¥å¿—ä¼˜åŒ–
- ä½¿ç”¨Winstonæ›¿ä»£consoleè¾“å‡º
- è‡ªåŠ¨è¿‡æ»¤å’Œæ ¼å¼åŒ–SQLå‚æ•°
- æ…¢æŸ¥è¯¢è‡ªåŠ¨æ ‡è®°(>1ç§’)

### 4. æ—¥å¿—ç®¡ç†API

#### è·å–æ—¥å¿—çŠ¶æ€
```http
GET /api/logs/status
Authorization: Bearer <token>
```

#### æŸ¥çœ‹æ—¥å¿—å†…å®¹
```http
GET /api/logs/content?file=backend-2025-W01.log&lines=100
Authorization: Bearer <token>
```

#### æœç´¢æ—¥å¿—
```http
GET /api/logs/search?file=backend-2025-W01.log&keyword=ERROR&limit=50
Authorization: Bearer <token>
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
logs/
â”œâ”€â”€ backend.log                   # å½“å‰åº”ç”¨æ—¥å¿—
â”œâ”€â”€ error.log                     # å½“å‰é”™è¯¯æ—¥å¿—
â”œâ”€â”€ database.log                  # å½“å‰æ•°æ®åº“æ—¥å¿—
â”œâ”€â”€ security.log                  # å½“å‰å®‰å…¨æ—¥å¿—
â”œâ”€â”€ backend-2025-01-09.log        # å½’æ¡£çš„åº”ç”¨æ—¥å¿—
â”œâ”€â”€ backend-2025-01-08.log.gz     # å‹ç¼©çš„å†å²æ—¥å¿—
â”œâ”€â”€ error-2025-01-09.log          # å½’æ¡£çš„é”™è¯¯æ—¥å¿—
â”œâ”€â”€ database-2025-01-09.log       # å½’æ¡£çš„æ•°æ®åº“æ—¥å¿—
â”œâ”€â”€ security-2025-01-09.log       # å½’æ¡£çš„å®‰å…¨æ—¥å¿—
â”œâ”€â”€ .backend-audit.json           # æ—¥å¿—è½®è½¬å®¡è®¡æ–‡ä»¶
â””â”€â”€ ...
```

## ğŸ” æ—¥å¿—æ ¼å¼

### æ ‡å‡†æ ¼å¼
```
2025-01-09 10:30:45.123 [INFO] [1704067200000-abc123def] [HTTP] è¯·æ±‚å¼€å§‹ GET /api/customers
2025-01-09 10:30:45.456 [INFO] [1704067200000-abc123def] [Database] SQL Query: SELECT * FROM t_customers LIMIT 10
2025-01-09 10:30:45.789 [INFO] [1704067200000-abc123def] [HTTP] è¯·æ±‚å®Œæˆ GET /api/customers - 200 - 666ms
```

### å­—æ®µè¯´æ˜
- **æ—¶é—´æˆ³**: ç²¾ç¡®åˆ°æ¯«ç§’
- **çº§åˆ«**: DEBUG/INFO/WARN/ERROR
- **TraceId**: è¯·æ±‚è¿½è¸ªID
- **ä¸Šä¸‹æ–‡**: æ¨¡å—åç§°(HTTP/Database/Securityç­‰)
- **æ¶ˆæ¯**: å…·ä½“æ—¥å¿—å†…å®¹

## âš™ï¸ é…ç½®è¯´æ˜

### æ—¥å¿—çº§åˆ«
- **å¼€å‘ç¯å¢ƒ**: DEBUGçº§åˆ«ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
- **ç”Ÿäº§ç¯å¢ƒ**: INFOçº§åˆ«ï¼Œè¿‡æ»¤è°ƒè¯•ä¿¡æ¯

### æ–‡ä»¶å¤§å°é™åˆ¶
- **å•æ–‡ä»¶æœ€å¤§**: 50MB
- **è¾¾åˆ°é™åˆ¶**: è‡ªåŠ¨è½®è½¬åˆ°æ–°æ–‡ä»¶
- **å‹ç¼©ç­–ç•¥**: æ—§æ–‡ä»¶è‡ªåŠ¨å‹ç¼©

### æ¸…ç†ç­–ç•¥
- **æ£€æŸ¥é¢‘ç‡**: æ¯å¤©å‡Œæ™¨1ç‚¹æ£€æŸ¥çŠ¶æ€
- **æ¸…ç†é¢‘ç‡**: æ¯å¤©å‡Œæ™¨3ç‚¹æ¸…ç†è¿‡æœŸæ–‡ä»¶
- **ä¿ç•™æœŸé™**: 90å¤©(çº¦3ä¸ªæœˆ)

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### åœ¨ä»£ç ä¸­ä½¿ç”¨æ—¥å¿—

```typescript
import { CustomLogger } from '../config/logger.config';

export class SomeService {
  private readonly logger = new CustomLogger('SomeService');

  async someMethod(traceId?: string) {
    // æ™®é€šæ—¥å¿—
    this.logger.log('æ“ä½œå¼€å§‹', 'SomeService', traceId);
    
    // é”™è¯¯æ—¥å¿—
    this.logger.error('æ“ä½œå¤±è´¥', error.stack, 'SomeService', traceId);
    
    // æ•°æ®åº“æ—¥å¿—
    this.logger.logDatabase('æ•°æ®åº“æ“ä½œ', 'info', traceId);
    
    // å®‰å…¨æ—¥å¿—
    this.logger.logSecurity('å®‰å…¨äº‹ä»¶', 'warn', traceId);
  }
}
```

### åœ¨HTTPè¯·æ±‚ä¸­è·å–TraceId

```typescript
@Controller('api/example')
export class ExampleController {
  @Get()
  async getExample(@Req() request: Request) {
    const traceId = request.traceId; // è‡ªåŠ¨æ³¨å…¥çš„TraceId
    this.logger.log('å¤„ç†è¯·æ±‚', 'ExampleController', traceId);
  }
}
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—ç›‘æ§å‘½ä»¤
```bash
# å®æ—¶æŸ¥çœ‹å½“å‰åº”ç”¨æ—¥å¿—
tail -f logs/backend.log

# æŸ¥çœ‹å½“å‰é”™è¯¯æ—¥å¿—
tail -f logs/error.log

# æŸ¥çœ‹ç‰¹å®šæ—¥æœŸçš„å½’æ¡£æ—¥å¿—
tail -f logs/backend-2025-01-09.log

# æœç´¢ç‰¹å®šTraceIdçš„æ‰€æœ‰æ—¥å¿—
grep "1704067200000-abc123def" logs/*.log

# æŸ¥çœ‹æ—¥å¿—ç›®å½•å¤§å°
du -sh logs/
```

### æ€§èƒ½å½±å“
- **CPUå¼€é”€**: æä½ï¼Œå¼‚æ­¥å†™å…¥
- **å†…å­˜å¼€é”€**: çº¦10-20MBç¼“å†²åŒº
- **ç£ç›˜å¼€é”€**: è‡ªåŠ¨å‹ç¼©å’Œæ¸…ç†ï¼Œæ§åˆ¶åœ¨åˆç†èŒƒå›´

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æ—¥å¿—æ–‡ä»¶è¿‡å¤§**
   - æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å¤§é‡çš„æ—¥å¿—è¾“å‡º
   - è°ƒæ•´æ—¥å¿—çº§åˆ«æˆ–è¿‡æ»¤è§„åˆ™

2. **TraceIdç¼ºå¤±**
   - ç¡®è®¤ä¸­é—´ä»¶å·²æ­£ç¡®é…ç½®
   - æ£€æŸ¥è¯·æ±‚æ˜¯å¦ç»è¿‡æ­£ç¡®çš„è·¯ç”±

3. **æ—¥å¿—è½®è½¬å¤±è´¥**
   - æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
   - ç¡®è®¤æ—¥å¿—ç›®å½•æƒé™æ­£ç¡®

### è°ƒè¯•å‘½ä»¤
```bash
# æ£€æŸ¥æ—¥å¿—é…ç½®
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/logs/status

# æµ‹è¯•æ—¥å¿—å†™å…¥
curl -X GET http://localhost:3000/health

# æŸ¥çœ‹å½“å‰æ—¥å¿—
curl -H "Authorization: Bearer <token>" "http://localhost:3000/api/logs/content?file=backend.log&lines=10"

# æŸ¥çœ‹å½’æ¡£æ—¥å¿—
curl -H "Authorization: Bearer <token>" "http://localhost:3000/api/logs/content?file=backend-2025-01-09.log&lines=10"
```

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—åˆ†æ**: é›†æˆELK Stackè¿›è¡Œæ—¥å¿—åˆ†æ
2. **å‘Šè­¦æœºåˆ¶**: åŸºäºé”™è¯¯æ—¥å¿—é¢‘ç‡è®¾ç½®å‘Šè­¦
3. **æ€§èƒ½ç›‘æ§**: æ·»åŠ æ…¢è¯·æ±‚å’Œèµ„æºä½¿ç”¨ç›‘æ§
4. **æ—¥å¿—é‡‡æ ·**: é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ—¥å¿—é‡‡æ ·ç­–ç•¥

---

**æ›´æ–°æ—¶é—´**: 2025-01-09  
**ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: ç³»ç»Ÿç®¡ç†å‘˜
