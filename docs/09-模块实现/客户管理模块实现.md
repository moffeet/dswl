# 🏢 客户管理模块实现详解

## 📋 模块概述

客户管理模块是物流配送系统的核心业务模块，负责管理客户信息、地址信息、地理位置等数据。支持多条件搜索、批量操作、地理编码等功能。

## 🏗️ 模块架构

### 目录结构
```
backend-node/src/customers/
├── customers.controller.ts     # 客户控制器
├── customers.service.ts        # 客户服务
├── customers.module.ts         # 客户模块
├── entities/
│   └── customer.entity.ts      # 客户实体
├── dto/
│   ├── create-customer.dto.ts  # 创建客户DTO
│   ├── update-customer.dto.ts  # 更新客户DTO
│   ├── search-customer.dto.ts  # 搜索客户DTO
│   ├── sync-customer.dto.ts    # 同步客户DTO
│   └── wx-update-customer.dto.ts # 小程序更新DTO
└── interfaces/
    └── customer.interface.ts   # 客户接口定义
```

### 前端结构
```
admin-frontend/src/app/customer/
├── page.tsx                    # 客户管理页面
├── components/
│   ├── CustomerTable.tsx       # 客户表格组件
│   ├── CustomerForm.tsx        # 客户表单组件
│   ├── SearchForm.tsx          # 搜索表单组件
│   └── BatchOperations.tsx     # 批量操作组件
└── hooks/
    └── useCustomers.tsx        # 客户数据Hook
```

## 🗄️ 数据实体设计

### 客户实体 (Customer)
```typescript
@Entity('t_customers')
export class Customer {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ name: 'customerNumber', length: 50, unique: true })
  customerNumber: string;

  @Column({ name: 'customerName', length: 100 })
  customerName: string;

  @Column({ name: 'storeAddress', length: 255, nullable: true })
  storeAddress: string;

  @Column({ name: 'warehouseAddress', length: 255, nullable: true })
  warehouseAddress: string;

  @Column({ name: 'storeLongitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  storeLongitude: number;

  @Column({ name: 'storeLatitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  storeLatitude: number;

  @Column({ name: 'warehouseLongitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  warehouseLongitude: number;

  @Column({ name: 'warehouseLatitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  warehouseLatitude: number;

  @Column({ name: 'lastSyncTime', type: 'datetime', nullable: true })
  lastSyncTime: Date;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  @Column({ name: 'updateBy', length: 50, nullable: true })
  updateBy: string;

  @CreateDateColumn({ name: 'createdAt' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updatedAt' })
  updatedAt: Date;
}
```

## 🔍 核心服务实现

### 客户服务 (CustomersService)
```typescript
@Injectable()
export class CustomersService {
  private readonly logger = new CustomLogger('CustomersService');

  constructor(
    @InjectRepository(Customer)
    private customerRepository: Repository<Customer>,
  ) {}

  /**
   * 分页查询客户列表
   */
  async findAll(page: number = 1, limit: number = 10, user?: any): Promise<PaginatedResponse<Customer>> {
    const skip = (page - 1) * limit;

    const [customers, total] = await this.customerRepository.findAndCount({
      where: { isDeleted: 0 },
      skip,
      take: limit,
      order: { createdAt: 'DESC' },
    });

    this.logger.log(`查询客户列表 - 页码: ${page}, 每页: ${limit}, 总数: ${total}, 用户: ${user?.id || '未知'}`);

    return {
      data: customers,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * 多条件搜索客户
   */
  async search(searchDto: SearchCustomerDto, user?: any): Promise<PaginatedResponse<Customer>> {
    const { keyword, customerNumber, customerName, page = 1, limit = 10 } = searchDto;
    const skip = (page - 1) * limit;

    const queryBuilder = this.customerRepository.createQueryBuilder('customer')
      .where('customer.isDeleted = :isDeleted', { isDeleted: 0 });

    // 关键词搜索（客户编号、名称、地址）
    if (keyword) {
      queryBuilder.andWhere(
        '(customer.customerNumber LIKE :keyword OR customer.customerName LIKE :keyword OR customer.storeAddress LIKE :keyword OR customer.warehouseAddress LIKE :keyword)',
        { keyword: `%${keyword}%` }
      );
    }

    // 精确搜索客户编号
    if (customerNumber) {
      queryBuilder.andWhere('customer.customerNumber = :customerNumber', { customerNumber });
    }

    // 模糊搜索客户名称
    if (customerName) {
      queryBuilder.andWhere('customer.customerName LIKE :customerName', { customerName: `%${customerName}%` });
    }

    // 分页和排序
    queryBuilder
      .skip(skip)
      .take(limit)
      .orderBy('customer.createdAt', 'DESC');

    const [customers, total] = await queryBuilder.getManyAndCount();

    this.logger.log(`搜索客户 - 关键词: ${keyword}, 客户编号: ${customerNumber}, 客户名称: ${customerName}, 结果数: ${customers.length}, 用户: ${user?.id || '未知'}`);

    return {
      data: customers,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * 创建客户
   */
  async create(createCustomerDto: CreateCustomerDto, user?: any): Promise<Customer> {
    // 生成客户编号
    const customerNumber = await this.generateCustomerNumber();

    const customer = this.customerRepository.create({
      ...createCustomerDto,
      customerNumber,
      updateBy: user?.username || 'system',
    });

    const savedCustomer = await this.customerRepository.save(customer);
    
    this.logger.log(`创建客户成功 - ID: ${savedCustomer.id}, 编号: ${customerNumber}, 名称: ${createCustomerDto.customerName}, 操作人: ${user?.username || '系统'}`);

    return savedCustomer;
  }

  /**
   * 更新客户信息
   */
  async update(id: number, updateCustomerDto: UpdateCustomerDto, user?: any): Promise<Customer> {
    const customer = await this.findOne(id);

    // 更新客户信息
    Object.assign(customer, {
      ...updateCustomerDto,
      updateBy: user?.username || 'system',
    });

    const updatedCustomer = await this.customerRepository.save(customer);
    
    this.logger.log(`更新客户成功 - ID: ${id}, 编号: ${customer.customerNumber}, 操作人: ${user?.username || '系统'}`);

    return updatedCustomer;
  }

  /**
   * 删除客户（软删除）
   */
  async remove(id: number, user?: any): Promise<void> {
    const customer = await this.findOne(id);

    await this.customerRepository.update(id, {
      isDeleted: 1,
      updateBy: user?.username || 'system',
    });

    this.logger.log(`删除客户成功 - ID: ${id}, 编号: ${customer.customerNumber}, 操作人: ${user?.username || '系统'}`);
  }

  /**
   * 批量删除客户
   */
  async batchRemove(ids: number[], user?: any): Promise<void> {
    await this.customerRepository.update(
      { id: In(ids) },
      {
        isDeleted: 1,
        updateBy: user?.username || 'system',
      }
    );

    this.logger.log(`批量删除客户成功 - 数量: ${ids.length}, 操作人: ${user?.username || '系统'}`);
  }

  /**
   * 地理编码 - 地址转坐标
   */
  async geocodeAddress(geocodeDto: GeocodeRequestDto): Promise<GeocodeResponse> {
    const { address } = geocodeDto;
    
    try {
      // 调用高德地图API进行地理编码
      const response = await axios.get('https://restapi.amap.com/v3/geocode/geo', {
        params: {
          key: process.env.AMAP_API_KEY || 'your-amap-api-key',
          address: address,
          output: 'json',
        },
      });

      if (response.data.status === '1' && response.data.geocodes.length > 0) {
        const geocode = response.data.geocodes[0];
        const [longitude, latitude] = geocode.location.split(',').map(Number);

        this.logger.log(`地理编码成功 - 地址: ${address}, 坐标: ${longitude}, ${latitude}`);

        return {
          address,
          longitude,
          latitude,
          formattedAddress: geocode.formatted_address,
          province: geocode.province,
          city: geocode.city,
          district: geocode.district,
        };
      } else {
        throw new Error('地理编码失败：未找到对应坐标');
      }
    } catch (error) {
      this.logger.error(`地理编码失败 - 地址: ${address}, 错误: ${error.message}`);
      throw new Error(`地理编码失败: ${error.message}`);
    }
  }

  /**
   * 逆地理编码 - 坐标转地址
   */
  async reverseGeocode(reverseGeocodeDto: ReverseGeocodeRequestDto): Promise<ReverseGeocodeResponse> {
    const { longitude, latitude } = reverseGeocodeDto;
    
    try {
      const response = await axios.get('https://restapi.amap.com/v3/geocode/regeo', {
        params: {
          key: process.env.AMAP_API_KEY || 'your-amap-api-key',
          location: `${longitude},${latitude}`,
          output: 'json',
          radius: 1000,
          extensions: 'base',
        },
      });

      if (response.data.status === '1') {
        const regeocode = response.data.regeocode;
        
        this.logger.log(`逆地理编码成功 - 坐标: ${longitude}, ${latitude}, 地址: ${regeocode.formatted_address}`);

        return {
          longitude,
          latitude,
          formattedAddress: regeocode.formatted_address,
          province: regeocode.addressComponent.province,
          city: regeocode.addressComponent.city,
          district: regeocode.addressComponent.district,
          street: regeocode.addressComponent.streetNumber?.street || '',
          streetNumber: regeocode.addressComponent.streetNumber?.number || '',
        };
      } else {
        throw new Error('逆地理编码失败：未找到对应地址');
      }
    } catch (error) {
      this.logger.error(`逆地理编码失败 - 坐标: ${longitude}, ${latitude}, 错误: ${error.message}`);
      throw new Error(`逆地理编码失败: ${error.message}`);
    }
  }

  /**
   * 生成客户编号
   */
  private async generateCustomerNumber(): Promise<string> {
    const lastCustomer = await this.customerRepository.findOne({
      where: { isDeleted: 0 },
      order: { id: 'DESC' },
    });

    let nextNumber = 1;
    if (lastCustomer && lastCustomer.customerNumber) {
      const match = lastCustomer.customerNumber.match(/C(\d+)/);
      if (match) {
        nextNumber = parseInt(match[1]) + 1;
      }
    }

    return `C${nextNumber.toString().padStart(3, '0')}`;
  }

  /**
   * 根据ID查找客户
   */
  async findOne(id: number): Promise<Customer> {
    const customer = await this.customerRepository.findOne({
      where: { id, isDeleted: 0 },
    });

    if (!customer) {
      throw new NotFoundException(`客户不存在 (ID: ${id})`);
    }

    return customer;
  }
}
```

## 🎯 控制器实现

### 客户控制器 (CustomersController)
```typescript
@ApiTags('客户管理')
@Controller('customers')
@UseGuards(JwtAuthGuard)
export class CustomersController {
  private readonly logger = new CustomLogger('CustomersController');

  constructor(private readonly customersService: CustomersService) {}

  @Get()
  @ApiOperation({ summary: '获取客户列表' })
  async findAll(
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 10,
    @Req() req,
  ) {
    return this.customersService.findAll(page, limit, req.user);
  }

  @Get('search')
  @ApiOperation({ summary: '搜索客户' })
  async search(@Query() searchDto: SearchCustomerDto, @Req() req) {
    return this.customersService.search(searchDto, req.user);
  }

  @Get(':id')
  @ApiOperation({ summary: '获取客户详情' })
  async findOne(@Param('id') id: string) {
    return this.customersService.findOne(+id);
  }

  @Post()
  @ApiOperation({ summary: '创建客户' })
  async create(@Body() createCustomerDto: CreateCustomerDto, @Req() req) {
    return this.customersService.create(createCustomerDto, req.user);
  }

  @Put(':id')
  @ApiOperation({ summary: '更新客户' })
  async update(
    @Param('id') id: string,
    @Body() updateCustomerDto: UpdateCustomerDto,
    @Req() req,
  ) {
    return this.customersService.update(+id, updateCustomerDto, req.user);
  }

  @Delete(':id')
  @ApiOperation({ summary: '删除客户' })
  async remove(@Param('id') id: string, @Req() req) {
    return this.customersService.remove(+id, req.user);
  }

  @Delete('batch')
  @ApiOperation({ summary: '批量删除客户' })
  async batchRemove(@Body() { ids }: { ids: number[] }, @Req() req) {
    return this.customersService.batchRemove(ids, req.user);
  }

  @Post('geocode')
  @ApiOperation({ summary: '地理编码' })
  async geocode(@Body() geocodeDto: GeocodeRequestDto) {
    return this.customersService.geocodeAddress(geocodeDto);
  }

  @Post('reverse-geocode')
  @ApiOperation({ summary: '逆地理编码' })
  async reverseGeocode(@Body() reverseGeocodeDto: ReverseGeocodeRequestDto) {
    return this.customersService.reverseGeocode(reverseGeocodeDto);
  }
}
```

## 🎨 前端实现

### 客户管理页面
```typescript
export default function CustomerPage() {
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  });

  const fetchCustomers = async (page = 1, limit = 10, searchParams = {}) => {
    setLoading(true);
    try {
      const response = await api.get('/customers', {
        params: { page, limit, ...searchParams },
      });
      
      setCustomers(response.data.data);
      setPagination({
        current: response.data.page,
        pageSize: response.data.limit,
        total: response.data.total,
      });
    } catch (error) {
      console.error('获取客户列表失败:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchCustomers();
  }, []);

  return (
    <div className="customer-management">
      <div className="header">
        <h1>客户管理</h1>
        <Button type="primary" onClick={() => setShowCreateModal(true)}>
          新增客户
        </Button>
      </div>

      <SearchForm onSearch={fetchCustomers} />
      
      <CustomerTable
        customers={customers}
        loading={loading}
        pagination={pagination}
        onPageChange={fetchCustomers}
        onEdit={handleEdit}
        onDelete={handleDelete}
      />

      <CustomerForm
        visible={showCreateModal}
        onCancel={() => setShowCreateModal(false)}
        onSuccess={() => {
          setShowCreateModal(false);
          fetchCustomers();
        }}
      />
    </div>
  );
}
```

## 📊 数据传输对象 (DTO)

### 搜索客户DTO
```typescript
export class SearchCustomerDto {
  @ApiProperty({ description: '关键词搜索', required: false })
  @IsOptional()
  @IsString()
  keyword?: string;

  @ApiProperty({ description: '客户编号', required: false })
  @IsOptional()
  @IsString()
  customerNumber?: string;

  @ApiProperty({ description: '客户名称', required: false })
  @IsOptional()
  @IsString()
  customerName?: string;

  @ApiProperty({ description: '页码', required: false, default: 1 })
  @IsOptional()
  @IsInt()
  @Min(1)
  page?: number = 1;

  @ApiProperty({ description: '每页数量', required: false, default: 10 })
  @IsOptional()
  @IsInt()
  @Min(1)
  @Max(100)
  limit?: number = 10;
}
```

### 创建客户DTO
```typescript
export class CreateCustomerDto {
  @ApiProperty({ description: '客户名称' })
  @IsNotEmpty()
  @IsString()
  @MaxLength(100)
  customerName: string;

  @ApiProperty({ description: '门店地址', required: false })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  storeAddress?: string;

  @ApiProperty({ description: '仓库地址', required: false })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  warehouseAddress?: string;

  @ApiProperty({ description: '门店经度', required: false })
  @IsOptional()
  @IsNumber()
  storeLongitude?: number;

  @ApiProperty({ description: '门店纬度', required: false })
  @IsOptional()
  @IsNumber()
  storeLatitude?: number;

  @ApiProperty({ description: '仓库经度', required: false })
  @IsOptional()
  @IsNumber()
  warehouseLongitude?: number;

  @ApiProperty({ description: '仓库纬度', required: false })
  @IsOptional()
  @IsNumber()
  warehouseLatitude?: number;
}
```

---

**相关文档**:
- [小程序客户功能](./小程序客户模块实现.md)
- [地理编码服务](./地理编码模块实现.md)
- [数据库设计](../01-架构设计/数据库设计.md)
