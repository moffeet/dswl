# 📱 小程序认证模块实现详解

## 📋 模块概述

小程序认证模块专门为移动端小程序提供认证服务，支持微信授权登录、手机号验证、设备绑定等功能。采用双Token机制确保安全性，同时简化前端实现。

## 🏗️ 模块架构

### 目录结构
```
backend-node/src/
├── wx-users/                   # 小程序用户管理
│   ├── wx-users.controller.ts
│   ├── wx-users.service.ts
│   ├── wx-users.module.ts
│   ├── entities/wx-user.entity.ts
│   └── services/
│       └── wechat-api.service.ts
├── miniprogram/                # 小程序接口
│   ├── miniprogram.controller.ts
│   ├── miniprogram.module.ts
│   └── dto/
│       └── simple-login.dto.ts
└── auth/
    ├── token.service.ts        # Token管理服务
    └── signature.service.ts    # 签名服务
```

## 🗄️ 数据实体设计

### 小程序用户实体 (WxUser)
```typescript
@Entity('t_wx_users')
export class WxUser {
  @PrimaryGeneratedColumn({ comment: '用户ID' })
  id: number;

  @Column({ length: 100, comment: '姓名' })
  name: string;

  @Column({ length: 20, unique: true, comment: '手机号（唯一）' })
  phone: string;

  @Column({ type: 'enum', enum: WxUserRole, comment: '角色：司机/销售' })
  role: WxUserRole;

  @Column({ name: 'wechat_id', length: 100, nullable: true, comment: '微信ID' })
  wechatId?: string;

  @Column({ name: 'device_id', length: 100, nullable: true, comment: '设备唯一标识' })
  deviceId?: string;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  @CreateDateColumn({ name: 'create_time', comment: '创建时间' })
  createTime: Date;

  @UpdateDateColumn({ name: 'update_time', comment: '更新时间' })
  updateTime: Date;
}

export enum WxUserRole {
  DRIVER = 'driver',    // 司机
  SALES = 'sales'       // 销售
}
```

## 🔐 微信API服务实现

### 微信API服务 (WechatApiService)
```typescript
@Injectable()
export class WechatApiService {
  private readonly logger = new CustomLogger('WechatApiService');
  private readonly appId: string;
  private readonly appSecret: string;

  constructor() {
    this.appId = process.env.WECHAT_APPID || '';
    this.appSecret = process.env.WECHAT_APP_SECRET || '';
    
    if (!this.appId || !this.appSecret) {
      this.logger.warn('微信小程序配置未完整设置，部分功能可能无法使用');
    }
  }

  /**
   * 通过jsCode获取openid和session_key
   */
  async getSessionInfo(jsCode: string): Promise<WechatSessionResponse> {
    const url = 'https://api.weixin.qq.com/sns/jscode2session';
    const params = {
      appid: this.appId,
      secret: this.appSecret,
      js_code: jsCode,
      grant_type: 'authorization_code'
    };

    try {
      this.logger.log(`调用微信API获取session信息: ${url}`);
      const response = await axios.get<WechatSessionResponse>(url, { params });
      
      if (response.data.errcode) {
        this.logger.error(`微信API错误: ${response.data.errcode} - ${response.data.errmsg}`);
        throw new HttpException(
          `微信API调用失败: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      this.logger.log(`成功获取openid: ${response.data.openid}`);
      return response.data;
    } catch (error) {
      this.logger.error('调用微信API失败:', error.message);
      throw new HttpException(
        '获取微信用户信息失败',
        HttpStatus.INTERNAL_SERVER_ERROR
      );
    }
  }

  /**
   * 获取微信Access Token
   */
  async getAccessToken(): Promise<string> {
    const url = 'https://api.weixin.qq.com/cgi-bin/token';
    const params = {
      grant_type: 'client_credential',
      appid: this.appId,
      secret: this.appSecret
    };

    try {
      const response = await axios.get<WechatAccessTokenResponse>(url, { params });
      
      if (response.data.errcode) {
        throw new HttpException(
          `获取Access Token失败: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      return response.data.access_token;
    } catch (error) {
      this.logger.error('获取Access Token失败:', error.message);
      throw new HttpException(
        '获取微信Access Token失败',
        HttpStatus.INTERNAL_SERVER_ERROR
      );
    }
  }

  /**
   * 通过code获取用户手机号
   */
  async getPhoneNumber(code: string): Promise<string> {
    try {
      // 1. 先获取access_token
      const accessToken = await this.getAccessToken();

      // 2. 调用获取手机号接口
      const url = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${accessToken}`;
      const data = { code };

      this.logger.log(`调用微信获取手机号API: ${url}`);
      const response = await axios.post<WechatPhoneResponse>(url, data);

      if (response.data.errcode !== 0) {
        this.logger.error(`获取手机号失败: ${response.data.errcode} - ${response.data.errmsg}`);
        throw new HttpException(
          `获取手机号失败: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      const phoneNumber = response.data.phone_info?.purePhoneNumber;
      if (!phoneNumber) {
        throw new HttpException('未能获取到手机号信息', HttpStatus.BAD_REQUEST);
      }

      this.logger.log(`成功获取手机号: ${phoneNumber.substring(0, 3)}****${phoneNumber.substring(7)}`);
      return phoneNumber;
    } catch (error) {
      this.logger.error(`获取手机号失败: ${error.message}`);
      throw error;
    }
  }
}

// 微信API响应接口
interface WechatSessionResponse {
  openid?: string;
  session_key?: string;
  unionid?: string;
  errcode?: number;
  errmsg?: string;
}

interface WechatAccessTokenResponse {
  access_token?: string;
  expires_in?: number;
  errcode?: number;
  errmsg?: string;
}

interface WechatPhoneResponse {
  errcode: number;
  errmsg: string;
  phone_info?: {
    phoneNumber: string;
    purePhoneNumber: string;
    countryCode: string;
    watermark: {
      timestamp: number;
      appid: string;
    };
  };
}
```

## 🎯 小程序用户服务

### 小程序用户服务 (WxUsersService)
```typescript
@Injectable()
export class WxUsersService {
  private readonly logger = new CustomLogger('WxUsersService');

  constructor(
    @InjectRepository(WxUser)
    private wxUserRepository: Repository<WxUser>,
  ) {}

  /**
   * 根据手机号查找用户
   */
  async findByPhone(phone: string): Promise<WxUser | null> {
    return this.wxUserRepository.findOne({
      where: { phone, isDeleted: 0 }
    });
  }

  /**
   * 根据微信ID查找用户
   */
  async findByWechatId(wechatId: string): Promise<WxUser | null> {
    return this.wxUserRepository.findOne({
      where: { wechatId, isDeleted: 0 }
    });
  }

  /**
   * 创建或更新用户微信绑定
   */
  async createOrUpdateWechatBinding(
    phone: string,
    wechatId: string,
    deviceId?: string
  ): Promise<WxUser> {
    let user = await this.findByPhone(phone);

    if (user) {
      // 更新现有用户的微信ID和设备ID
      user.wechatId = wechatId;
      if (deviceId) {
        user.deviceId = deviceId;
      }
      user = await this.wxUserRepository.save(user);
      this.logger.log(`更新用户微信绑定 - 用户ID: ${user.id}, 手机号: ${phone.substring(0, 3)}****${phone.substring(7)}`);
    } else {
      // 检查是否已有该微信ID的用户
      const existingWechatUser = await this.findByWechatId(wechatId);
      if (existingWechatUser) {
        // 更新手机号
        existingWechatUser.phone = phone;
        if (deviceId) {
          existingWechatUser.deviceId = deviceId;
        }
        user = await this.wxUserRepository.save(existingWechatUser);
        this.logger.log(`更新微信用户手机号 - 用户ID: ${user.id}, 新手机号: ${phone.substring(0, 3)}****${phone.substring(7)}`);
      } else {
        // 创建新用户（需要管理员后续完善信息）
        user = this.wxUserRepository.create({
          phone,
          wechatId,
          deviceId,
          name: `用户${phone.substring(7)}`, // 临时名称
          role: WxUserRole.DRIVER, // 默认角色
        });
        user = await this.wxUserRepository.save(user);
        this.logger.log(`创建新微信用户 - 用户ID: ${user.id}, 手机号: ${phone.substring(0, 3)}****${phone.substring(7)}`);
      }
    }

    return user;
  }

  /**
   * 验证设备标识
   */
  async validateDeviceId(userId: number, deviceId: string): Promise<boolean> {
    this.logger.log(`🔒 验证设备标识 - 用户ID: ${userId}, 请求设备ID: ${deviceId}`);
    const user = await this.findOne(userId);

    // 如果数据库中没有设备标识，允许登录并更新
    if (!user.deviceId) {
      this.logger.log(`📝 用户无设备标识记录，更新并允许登录 - 用户ID: ${userId}, 设备ID: ${deviceId}`);
      await this.wxUserRepository.update(userId, { deviceId });
      return true;
    }

    // 如果设备标识不匹配，拒绝登录
    const isValid = user.deviceId === deviceId;
    if (isValid) {
      this.logger.log(`✅ 设备标识验证通过 - 用户ID: ${userId}`);
    } else {
      this.logger.error(`❌ 设备标识不匹配 - 用户ID: ${userId}, 数据库设备ID: ${user.deviceId}, 请求设备ID: ${deviceId}`);
    }

    return isValid;
  }

  /**
   * 根据ID查找用户
   */
  async findOne(id: number): Promise<WxUser> {
    const user = await this.wxUserRepository.findOne({
      where: { id, isDeleted: 0 }
    });

    if (!user) {
      throw new NotFoundException(`小程序用户不存在 (ID: ${id})`);
    }

    return user;
  }

  /**
   * 更新用户信息
   */
  async update(id: number, updateData: Partial<WxUser>): Promise<WxUser> {
    await this.wxUserRepository.update(id, updateData);
    return this.findOne(id);
  }
}
```

## 🔑 Token服务实现

### Token管理服务 (TokenService)
```typescript
@Injectable()
export class TokenService {
  private readonly logger = new CustomLogger('TokenService');

  constructor(private jwtService: JwtService) {}

  /**
   * 生成双Token（Access Token + Refresh Token）
   */
  generateTokens(user: WxUser): TokenPair {
    const payload = {
      sub: user.id,
      username: user.name,
      phone: user.phone,
      role: user.role,
      userType: 'wx-user'
    };

    // Access Token - 2小时有效期
    const accessToken = this.jwtService.sign(payload, {
      expiresIn: '2h'
    });

    // Refresh Token - 7天有效期
    const refreshToken = this.jwtService.sign(
      { ...payload, tokenType: 'refresh' },
      { expiresIn: '7d' }
    );

    this.logger.log(`生成Token成功 - 用户ID: ${user.id}, Access Token有效期: 2小时, Refresh Token有效期: 7天`);

    return {
      accessToken,
      refreshToken,
      expiresIn: 7200, // 2小时，单位：秒
      tokenType: 'Bearer'
    };
  }

  /**
   * 刷新Access Token
   */
  async refreshAccessToken(refreshToken: string): Promise<TokenPair> {
    try {
      const payload = this.jwtService.verify(refreshToken);
      
      if (payload.tokenType !== 'refresh') {
        throw new UnauthorizedException('无效的Refresh Token');
      }

      // 生成新的Token对
      const user = {
        id: payload.sub,
        name: payload.username,
        phone: payload.phone,
        role: payload.role
      } as WxUser;

      return this.generateTokens(user);
    } catch (error) {
      this.logger.error(`刷新Token失败: ${error.message}`);
      throw new UnauthorizedException('Refresh Token已过期或无效');
    }
  }

  /**
   * 验证Token
   */
  verifyToken(token: string): any {
    try {
      return this.jwtService.verify(token);
    } catch (error) {
      throw new UnauthorizedException('Token无效或已过期');
    }
  }
}

interface TokenPair {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
  tokenType: string;
}
```

## 🎯 小程序登录控制器

### 小程序登录实现
```typescript
@Controller('miniprogram')
@UseGuards(JwtAuthGuard)
export class MiniprogramController {
  private readonly logger = new CustomLogger('MiniprogramController');

  constructor(
    private readonly wxUsersService: WxUsersService,
    private readonly wechatApiService: WechatApiService,
    private readonly tokenService: TokenService,
  ) {}

  /**
   * 微信授权手机号登录（推荐方式）
   */
  @Public()
  @Post('login-with-phone')
  @ApiOperation({ summary: '微信授权手机号登录' })
  async loginWithPhone(@Body() loginDto: SimpleLoginDto) {
    const { code, jsCode, macAddress } = loginDto;

    try {
      // 1. 通过code获取手机号
      this.logger.log(`📞 获取微信手机号 - code: ${code}`);
      const phoneNumber = await this.wechatApiService.getPhoneNumber(code);
      this.logger.log(`✅ 获取手机号成功 - 手机号: ${phoneNumber?.substring(0, 3)}****${phoneNumber?.substring(7)}`);

      // 2. 根据手机号查找用户
      this.logger.log(`👤 查找手机号用户 - 手机号: ${phoneNumber}`);
      const user = await this.wxUsersService.findByPhone(phoneNumber);

      if (!user) {
        this.logger.warn(`❌ 用户不存在 - 手机号: ${phoneNumber?.substring(0, 3)}****${phoneNumber?.substring(7)}`);
        return {
          code: RESPONSE_CODES.USER_NOT_FOUND,
          message: RESPONSE_MESSAGES.USER_NOT_FOUND,
          data: null
        };
      }

      this.logger.log(`✅ 找到用户 - ID: ${user.id}, 姓名: ${user.name}, 角色: ${user.role}`);

      // 3. 获取微信openid（可选）
      let wechatId = user.wechatId;
      if (jsCode && !wechatId) {
        try {
          const sessionInfo = await this.wechatApiService.getSessionInfo(jsCode);
          wechatId = sessionInfo.openid;
          if (wechatId) {
            await this.wxUsersService.update(user.id, { wechatId });
            this.logger.log(`🔗 绑定微信ID成功 - 用户ID: ${user.id}`);
          }
        } catch (error) {
          this.logger.warn(`获取微信openid失败，但不影响登录: ${error.message}`);
        }
      }

      // 4. 验证设备标识
      if (macAddress) {
        const isValidDevice = await this.wxUsersService.validateDeviceId(user.id, macAddress);
        if (!isValidDevice) {
          this.logger.error(`❌ 设备验证失败 - 用户ID: ${user.id}, MAC: ${macAddress}`);
          return {
            code: RESPONSE_CODES.DEVICE_NOT_MATCH,
            message: RESPONSE_MESSAGES.DEVICE_NOT_MATCH,
            data: null
          };
        }
      }

      // 5. 生成双Token
      const tokens = this.tokenService.generateTokens(user);

      this.logger.log(`🎉 登录成功 - 用户ID: ${user.id}, 姓名: ${user.name}`);

      return {
        code: RESPONSE_CODES.SUCCESS,
        message: '登录成功',
        data: {
          ...tokens,
          user: {
            id: user.id,
            name: user.name,
            phone: user.phone,
            role: user.role,
            wechatId: user.wechatId
          }
        }
      };
    } catch (error) {
      this.logger.error(`小程序登录失败: ${error.message}`, error.stack);
      return {
        code: RESPONSE_CODES.SERVER_ERROR,
        message: error.message || '登录失败',
        data: null
      };
    }
  }

  /**
   * 刷新Token
   */
  @Public()
  @Post('refresh-token')
  @ApiOperation({ summary: '刷新Access Token' })
  async refreshToken(@Body() refreshTokenDto: RefreshTokenDto) {
    try {
      const tokens = await this.tokenService.refreshAccessToken(refreshTokenDto.refreshToken);
      
      return {
        code: RESPONSE_CODES.SUCCESS,
        message: 'Token刷新成功',
        data: tokens
      };
    } catch (error) {
      this.logger.error(`Token刷新失败: ${error.message}`);
      return {
        code: RESPONSE_CODES.UNAUTHORIZED,
        message: error.message,
        data: null
      };
    }
  }
}
```

## 📱 前端使用示例

### 小程序登录流程
```javascript
// 小程序登录示例
async function loginWithWechat() {
  try {
    // 1. 获取微信授权code
    const { code } = await wx.login();
    
    // 2. 获取手机号授权
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: async (res) => {
        // 3. 获取手机号code
        wx.getPhoneNumber({
          success: async (phoneRes) => {
            // 4. 获取设备信息
            const deviceInfo = wx.getSystemInfoSync();
            const macAddress = deviceInfo.deviceId || generateDeviceId();
            
            // 5. 调用登录接口
            const loginResult = await wx.request({
              url: '/api/miniprogram/login-with-phone',
              method: 'POST',
              data: {
                code: phoneRes.code,
                jsCode: code,
                macAddress: macAddress
              }
            });
            
            if (loginResult.data.code === 200) {
              // 6. 保存Token和用户信息
              wx.setStorageSync('accessToken', loginResult.data.data.accessToken);
              wx.setStorageSync('refreshToken', loginResult.data.data.refreshToken);
              wx.setStorageSync('userInfo', loginResult.data.data.user);
              wx.setStorageSync('deviceId', macAddress);
              
              console.log('登录成功');
            } else {
              console.error('登录失败:', loginResult.data.message);
            }
          }
        });
      }
    });
  } catch (error) {
    console.error('登录过程出错:', error);
  }
}

// Token自动刷新
async function refreshTokenIfNeeded() {
  const refreshToken = wx.getStorageSync('refreshToken');
  if (!refreshToken) return false;
  
  try {
    const result = await wx.request({
      url: '/api/miniprogram/refresh-token',
      method: 'POST',
      data: { refreshToken }
    });
    
    if (result.data.code === 200) {
      wx.setStorageSync('accessToken', result.data.data.accessToken);
      wx.setStorageSync('refreshToken', result.data.data.refreshToken);
      return true;
    }
  } catch (error) {
    console.error('Token刷新失败:', error);
  }
  
  return false;
}
```

## 🔧 配置说明

### 环境变量配置
```env
# 微信小程序配置
WECHAT_APPID=your_wechat_appid_here
WECHAT_APP_SECRET=your_wechat_app_secret_here

# JWT配置
JWT_SECRET=logistics-system-jwt-secret-2024
JWT_EXPIRES_IN=2h
```

---

**相关文档**:
- [用户认证模块实现](./用户认证模块实现.md)
- [小程序API文档](../07-API文档/小程序API.md)
- [微信小程序配置指南](../08-小程序开发/微信小程序配置指南.md)
