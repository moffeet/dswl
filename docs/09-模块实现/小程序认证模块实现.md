# ğŸ“± å°ç¨‹åºè®¤è¯æ¨¡å—å®ç°è¯¦è§£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

å°ç¨‹åºè®¤è¯æ¨¡å—ä¸“é—¨ä¸ºç§»åŠ¨ç«¯å°ç¨‹åºæä¾›è®¤è¯æœåŠ¡ï¼Œæ”¯æŒå¾®ä¿¡æˆæƒç™»å½•ã€æ‰‹æœºå·éªŒè¯ã€è®¾å¤‡ç»‘å®šç­‰åŠŸèƒ½ã€‚é‡‡ç”¨åŒTokenæœºåˆ¶ç¡®ä¿å®‰å…¨æ€§ï¼ŒåŒæ—¶ç®€åŒ–å‰ç«¯å®ç°ã€‚

## ğŸ—ï¸ æ¨¡å—æ¶æ„

### ç›®å½•ç»“æ„
```
backend-node/src/
â”œâ”€â”€ wx-users/                   # å°ç¨‹åºç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ wx-users.controller.ts
â”‚   â”œâ”€â”€ wx-users.service.ts
â”‚   â”œâ”€â”€ wx-users.module.ts
â”‚   â”œâ”€â”€ entities/wx-user.entity.ts
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ wechat-api.service.ts
â”œâ”€â”€ miniprogram/                # å°ç¨‹åºæ¥å£
â”‚   â”œâ”€â”€ miniprogram.controller.ts
â”‚   â”œâ”€â”€ miniprogram.module.ts
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ simple-login.dto.ts
â””â”€â”€ auth/
    â”œâ”€â”€ token.service.ts        # Tokenç®¡ç†æœåŠ¡
    â””â”€â”€ signature.service.ts    # ç­¾åæœåŠ¡
```

## ğŸ—„ï¸ æ•°æ®å®ä½“è®¾è®¡

### å°ç¨‹åºç”¨æˆ·å®ä½“ (WxUser)
```typescript
@Entity('t_wx_users')
export class WxUser {
  @PrimaryGeneratedColumn({ comment: 'ç”¨æˆ·ID' })
  id: number;

  @Column({ length: 100, comment: 'å§“å' })
  name: string;

  @Column({ length: 20, unique: true, comment: 'æ‰‹æœºå·ï¼ˆå”¯ä¸€ï¼‰' })
  phone: string;

  @Column({ type: 'enum', enum: WxUserRole, comment: 'è§’è‰²ï¼šå¸æœº/é”€å”®' })
  role: WxUserRole;

  @Column({ name: 'wechat_id', length: 100, nullable: true, comment: 'å¾®ä¿¡ID' })
  wechatId?: string;

  @Column({ name: 'device_id', length: 100, nullable: true, comment: 'è®¾å¤‡å”¯ä¸€æ ‡è¯†' })
  deviceId?: string;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  @CreateDateColumn({ name: 'create_time', comment: 'åˆ›å»ºæ—¶é—´' })
  createTime: Date;

  @UpdateDateColumn({ name: 'update_time', comment: 'æ›´æ–°æ—¶é—´' })
  updateTime: Date;
}

export enum WxUserRole {
  DRIVER = 'driver',    // å¸æœº
  SALES = 'sales'       // é”€å”®
}
```

## ğŸ” å¾®ä¿¡APIæœåŠ¡å®ç°

### å¾®ä¿¡APIæœåŠ¡ (WechatApiService)
```typescript
@Injectable()
export class WechatApiService {
  private readonly logger = new CustomLogger('WechatApiService');
  private readonly appId: string;
  private readonly appSecret: string;

  constructor() {
    this.appId = process.env.WECHAT_APPID || '';
    this.appSecret = process.env.WECHAT_APP_SECRET || '';
    
    if (!this.appId || !this.appSecret) {
      this.logger.warn('å¾®ä¿¡å°ç¨‹åºé…ç½®æœªå®Œæ•´è®¾ç½®ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨');
    }
  }

  /**
   * é€šè¿‡jsCodeè·å–openidå’Œsession_key
   */
  async getSessionInfo(jsCode: string): Promise<WechatSessionResponse> {
    const url = 'https://api.weixin.qq.com/sns/jscode2session';
    const params = {
      appid: this.appId,
      secret: this.appSecret,
      js_code: jsCode,
      grant_type: 'authorization_code'
    };

    try {
      this.logger.log(`è°ƒç”¨å¾®ä¿¡APIè·å–sessionä¿¡æ¯: ${url}`);
      const response = await axios.get<WechatSessionResponse>(url, { params });
      
      if (response.data.errcode) {
        this.logger.error(`å¾®ä¿¡APIé”™è¯¯: ${response.data.errcode} - ${response.data.errmsg}`);
        throw new HttpException(
          `å¾®ä¿¡APIè°ƒç”¨å¤±è´¥: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      this.logger.log(`æˆåŠŸè·å–openid: ${response.data.openid}`);
      return response.data;
    } catch (error) {
      this.logger.error('è°ƒç”¨å¾®ä¿¡APIå¤±è´¥:', error.message);
      throw new HttpException(
        'è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
        HttpStatus.INTERNAL_SERVER_ERROR
      );
    }
  }

  /**
   * è·å–å¾®ä¿¡Access Token
   */
  async getAccessToken(): Promise<string> {
    const url = 'https://api.weixin.qq.com/cgi-bin/token';
    const params = {
      grant_type: 'client_credential',
      appid: this.appId,
      secret: this.appSecret
    };

    try {
      const response = await axios.get<WechatAccessTokenResponse>(url, { params });
      
      if (response.data.errcode) {
        throw new HttpException(
          `è·å–Access Tokenå¤±è´¥: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      return response.data.access_token;
    } catch (error) {
      this.logger.error('è·å–Access Tokenå¤±è´¥:', error.message);
      throw new HttpException(
        'è·å–å¾®ä¿¡Access Tokenå¤±è´¥',
        HttpStatus.INTERNAL_SERVER_ERROR
      );
    }
  }

  /**
   * é€šè¿‡codeè·å–ç”¨æˆ·æ‰‹æœºå·
   */
  async getPhoneNumber(code: string): Promise<string> {
    try {
      // 1. å…ˆè·å–access_token
      const accessToken = await this.getAccessToken();

      // 2. è°ƒç”¨è·å–æ‰‹æœºå·æ¥å£
      const url = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${accessToken}`;
      const data = { code };

      this.logger.log(`è°ƒç”¨å¾®ä¿¡è·å–æ‰‹æœºå·API: ${url}`);
      const response = await axios.post<WechatPhoneResponse>(url, data);

      if (response.data.errcode !== 0) {
        this.logger.error(`è·å–æ‰‹æœºå·å¤±è´¥: ${response.data.errcode} - ${response.data.errmsg}`);
        throw new HttpException(
          `è·å–æ‰‹æœºå·å¤±è´¥: ${response.data.errmsg}`,
          HttpStatus.BAD_REQUEST
        );
      }

      const phoneNumber = response.data.phone_info?.purePhoneNumber;
      if (!phoneNumber) {
        throw new HttpException('æœªèƒ½è·å–åˆ°æ‰‹æœºå·ä¿¡æ¯', HttpStatus.BAD_REQUEST);
      }

      this.logger.log(`æˆåŠŸè·å–æ‰‹æœºå·: ${phoneNumber.substring(0, 3)}****${phoneNumber.substring(7)}`);
      return phoneNumber;
    } catch (error) {
      this.logger.error(`è·å–æ‰‹æœºå·å¤±è´¥: ${error.message}`);
      throw error;
    }
  }
}

// å¾®ä¿¡APIå“åº”æ¥å£
interface WechatSessionResponse {
  openid?: string;
  session_key?: string;
  unionid?: string;
  errcode?: number;
  errmsg?: string;
}

interface WechatAccessTokenResponse {
  access_token?: string;
  expires_in?: number;
  errcode?: number;
  errmsg?: string;
}

interface WechatPhoneResponse {
  errcode: number;
  errmsg: string;
  phone_info?: {
    phoneNumber: string;
    purePhoneNumber: string;
    countryCode: string;
    watermark: {
      timestamp: number;
      appid: string;
    };
  };
}
```

## ğŸ¯ å°ç¨‹åºç”¨æˆ·æœåŠ¡

### å°ç¨‹åºç”¨æˆ·æœåŠ¡ (WxUsersService)
```typescript
@Injectable()
export class WxUsersService {
  private readonly logger = new CustomLogger('WxUsersService');

  constructor(
    @InjectRepository(WxUser)
    private wxUserRepository: Repository<WxUser>,
  ) {}

  /**
   * æ ¹æ®æ‰‹æœºå·æŸ¥æ‰¾ç”¨æˆ·
   */
  async findByPhone(phone: string): Promise<WxUser | null> {
    return this.wxUserRepository.findOne({
      where: { phone, isDeleted: 0 }
    });
  }

  /**
   * æ ¹æ®å¾®ä¿¡IDæŸ¥æ‰¾ç”¨æˆ·
   */
  async findByWechatId(wechatId: string): Promise<WxUser | null> {
    return this.wxUserRepository.findOne({
      where: { wechatId, isDeleted: 0 }
    });
  }

  /**
   * åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·å¾®ä¿¡ç»‘å®š
   */
  async createOrUpdateWechatBinding(
    phone: string,
    wechatId: string,
    deviceId?: string
  ): Promise<WxUser> {
    let user = await this.findByPhone(phone);

    if (user) {
      // æ›´æ–°ç°æœ‰ç”¨æˆ·çš„å¾®ä¿¡IDå’Œè®¾å¤‡ID
      user.wechatId = wechatId;
      if (deviceId) {
        user.deviceId = deviceId;
      }
      user = await this.wxUserRepository.save(user);
      this.logger.log(`æ›´æ–°ç”¨æˆ·å¾®ä¿¡ç»‘å®š - ç”¨æˆ·ID: ${user.id}, æ‰‹æœºå·: ${phone.substring(0, 3)}****${phone.substring(7)}`);
    } else {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥å¾®ä¿¡IDçš„ç”¨æˆ·
      const existingWechatUser = await this.findByWechatId(wechatId);
      if (existingWechatUser) {
        // æ›´æ–°æ‰‹æœºå·
        existingWechatUser.phone = phone;
        if (deviceId) {
          existingWechatUser.deviceId = deviceId;
        }
        user = await this.wxUserRepository.save(existingWechatUser);
        this.logger.log(`æ›´æ–°å¾®ä¿¡ç”¨æˆ·æ‰‹æœºå· - ç”¨æˆ·ID: ${user.id}, æ–°æ‰‹æœºå·: ${phone.substring(0, 3)}****${phone.substring(7)}`);
      } else {
        // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆéœ€è¦ç®¡ç†å‘˜åç»­å®Œå–„ä¿¡æ¯ï¼‰
        user = this.wxUserRepository.create({
          phone,
          wechatId,
          deviceId,
          name: `ç”¨æˆ·${phone.substring(7)}`, // ä¸´æ—¶åç§°
          role: WxUserRole.DRIVER, // é»˜è®¤è§’è‰²
        });
        user = await this.wxUserRepository.save(user);
        this.logger.log(`åˆ›å»ºæ–°å¾®ä¿¡ç”¨æˆ· - ç”¨æˆ·ID: ${user.id}, æ‰‹æœºå·: ${phone.substring(0, 3)}****${phone.substring(7)}`);
      }
    }

    return user;
  }

  /**
   * éªŒè¯è®¾å¤‡æ ‡è¯†
   */
  async validateDeviceId(userId: number, deviceId: string): Promise<boolean> {
    this.logger.log(`ğŸ”’ éªŒè¯è®¾å¤‡æ ‡è¯† - ç”¨æˆ·ID: ${userId}, è¯·æ±‚è®¾å¤‡ID: ${deviceId}`);
    const user = await this.findOne(userId);

    // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è®¾å¤‡æ ‡è¯†ï¼Œå…è®¸ç™»å½•å¹¶æ›´æ–°
    if (!user.deviceId) {
      this.logger.log(`ğŸ“ ç”¨æˆ·æ— è®¾å¤‡æ ‡è¯†è®°å½•ï¼Œæ›´æ–°å¹¶å…è®¸ç™»å½• - ç”¨æˆ·ID: ${userId}, è®¾å¤‡ID: ${deviceId}`);
      await this.wxUserRepository.update(userId, { deviceId });
      return true;
    }

    // å¦‚æœè®¾å¤‡æ ‡è¯†ä¸åŒ¹é…ï¼Œæ‹’ç»ç™»å½•
    const isValid = user.deviceId === deviceId;
    if (isValid) {
      this.logger.log(`âœ… è®¾å¤‡æ ‡è¯†éªŒè¯é€šè¿‡ - ç”¨æˆ·ID: ${userId}`);
    } else {
      this.logger.error(`âŒ è®¾å¤‡æ ‡è¯†ä¸åŒ¹é… - ç”¨æˆ·ID: ${userId}, æ•°æ®åº“è®¾å¤‡ID: ${user.deviceId}, è¯·æ±‚è®¾å¤‡ID: ${deviceId}`);
    }

    return isValid;
  }

  /**
   * æ ¹æ®IDæŸ¥æ‰¾ç”¨æˆ·
   */
  async findOne(id: number): Promise<WxUser> {
    const user = await this.wxUserRepository.findOne({
      where: { id, isDeleted: 0 }
    });

    if (!user) {
      throw new NotFoundException(`å°ç¨‹åºç”¨æˆ·ä¸å­˜åœ¨ (ID: ${id})`);
    }

    return user;
  }

  /**
   * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
   */
  async update(id: number, updateData: Partial<WxUser>): Promise<WxUser> {
    await this.wxUserRepository.update(id, updateData);
    return this.findOne(id);
  }
}
```

## ğŸ”‘ TokenæœåŠ¡å®ç°

### Tokenç®¡ç†æœåŠ¡ (TokenService)
```typescript
@Injectable()
export class TokenService {
  private readonly logger = new CustomLogger('TokenService');

  constructor(private jwtService: JwtService) {}

  /**
   * ç”ŸæˆåŒTokenï¼ˆAccess Token + Refresh Tokenï¼‰
   */
  generateTokens(user: WxUser): TokenPair {
    const payload = {
      sub: user.id,
      username: user.name,
      phone: user.phone,
      role: user.role,
      userType: 'wx-user'
    };

    // Access Token - 2å°æ—¶æœ‰æ•ˆæœŸ
    const accessToken = this.jwtService.sign(payload, {
      expiresIn: '2h'
    });

    // Refresh Token - 7å¤©æœ‰æ•ˆæœŸ
    const refreshToken = this.jwtService.sign(
      { ...payload, tokenType: 'refresh' },
      { expiresIn: '7d' }
    );

    this.logger.log(`ç”ŸæˆTokenæˆåŠŸ - ç”¨æˆ·ID: ${user.id}, Access Tokenæœ‰æ•ˆæœŸ: 2å°æ—¶, Refresh Tokenæœ‰æ•ˆæœŸ: 7å¤©`);

    return {
      accessToken,
      refreshToken,
      expiresIn: 7200, // 2å°æ—¶ï¼Œå•ä½ï¼šç§’
      tokenType: 'Bearer'
    };
  }

  /**
   * åˆ·æ–°Access Token
   */
  async refreshAccessToken(refreshToken: string): Promise<TokenPair> {
    try {
      const payload = this.jwtService.verify(refreshToken);
      
      if (payload.tokenType !== 'refresh') {
        throw new UnauthorizedException('æ— æ•ˆçš„Refresh Token');
      }

      // ç”Ÿæˆæ–°çš„Tokenå¯¹
      const user = {
        id: payload.sub,
        name: payload.username,
        phone: payload.phone,
        role: payload.role
      } as WxUser;

      return this.generateTokens(user);
    } catch (error) {
      this.logger.error(`åˆ·æ–°Tokenå¤±è´¥: ${error.message}`);
      throw new UnauthorizedException('Refresh Tokenå·²è¿‡æœŸæˆ–æ— æ•ˆ');
    }
  }

  /**
   * éªŒè¯Token
   */
  verifyToken(token: string): any {
    try {
      return this.jwtService.verify(token);
    } catch (error) {
      throw new UnauthorizedException('Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ');
    }
  }
}

interface TokenPair {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
  tokenType: string;
}
```

## ğŸ¯ å°ç¨‹åºç™»å½•æ§åˆ¶å™¨

### å°ç¨‹åºç™»å½•å®ç°
```typescript
@Controller('miniprogram')
@UseGuards(JwtAuthGuard)
export class MiniprogramController {
  private readonly logger = new CustomLogger('MiniprogramController');

  constructor(
    private readonly wxUsersService: WxUsersService,
    private readonly wechatApiService: WechatApiService,
    private readonly tokenService: TokenService,
  ) {}

  /**
   * å¾®ä¿¡æˆæƒæ‰‹æœºå·ç™»å½•ï¼ˆæ¨èæ–¹å¼ï¼‰
   */
  @Public()
  @Post('login-with-phone')
  @ApiOperation({ summary: 'å¾®ä¿¡æˆæƒæ‰‹æœºå·ç™»å½•' })
  async loginWithPhone(@Body() loginDto: SimpleLoginDto) {
    const { code, jsCode, macAddress } = loginDto;

    try {
      // 1. é€šè¿‡codeè·å–æ‰‹æœºå·
      this.logger.log(`ğŸ“ è·å–å¾®ä¿¡æ‰‹æœºå· - code: ${code}`);
      const phoneNumber = await this.wechatApiService.getPhoneNumber(code);
      this.logger.log(`âœ… è·å–æ‰‹æœºå·æˆåŠŸ - æ‰‹æœºå·: ${phoneNumber?.substring(0, 3)}****${phoneNumber?.substring(7)}`);

      // 2. æ ¹æ®æ‰‹æœºå·æŸ¥æ‰¾ç”¨æˆ·
      this.logger.log(`ğŸ‘¤ æŸ¥æ‰¾æ‰‹æœºå·ç”¨æˆ· - æ‰‹æœºå·: ${phoneNumber}`);
      const user = await this.wxUsersService.findByPhone(phoneNumber);

      if (!user) {
        this.logger.warn(`âŒ ç”¨æˆ·ä¸å­˜åœ¨ - æ‰‹æœºå·: ${phoneNumber?.substring(0, 3)}****${phoneNumber?.substring(7)}`);
        return {
          code: RESPONSE_CODES.USER_NOT_FOUND,
          message: RESPONSE_MESSAGES.USER_NOT_FOUND,
          data: null
        };
      }

      this.logger.log(`âœ… æ‰¾åˆ°ç”¨æˆ· - ID: ${user.id}, å§“å: ${user.name}, è§’è‰²: ${user.role}`);

      // 3. è·å–å¾®ä¿¡openidï¼ˆå¯é€‰ï¼‰
      let wechatId = user.wechatId;
      if (jsCode && !wechatId) {
        try {
          const sessionInfo = await this.wechatApiService.getSessionInfo(jsCode);
          wechatId = sessionInfo.openid;
          if (wechatId) {
            await this.wxUsersService.update(user.id, { wechatId });
            this.logger.log(`ğŸ”— ç»‘å®šå¾®ä¿¡IDæˆåŠŸ - ç”¨æˆ·ID: ${user.id}`);
          }
        } catch (error) {
          this.logger.warn(`è·å–å¾®ä¿¡openidå¤±è´¥ï¼Œä½†ä¸å½±å“ç™»å½•: ${error.message}`);
        }
      }

      // 4. éªŒè¯è®¾å¤‡æ ‡è¯†
      if (macAddress) {
        const isValidDevice = await this.wxUsersService.validateDeviceId(user.id, macAddress);
        if (!isValidDevice) {
          this.logger.error(`âŒ è®¾å¤‡éªŒè¯å¤±è´¥ - ç”¨æˆ·ID: ${user.id}, MAC: ${macAddress}`);
          return {
            code: RESPONSE_CODES.DEVICE_NOT_MATCH,
            message: RESPONSE_MESSAGES.DEVICE_NOT_MATCH,
            data: null
          };
        }
      }

      // 5. ç”ŸæˆåŒToken
      const tokens = this.tokenService.generateTokens(user);

      this.logger.log(`ğŸ‰ ç™»å½•æˆåŠŸ - ç”¨æˆ·ID: ${user.id}, å§“å: ${user.name}`);

      return {
        code: RESPONSE_CODES.SUCCESS,
        message: 'ç™»å½•æˆåŠŸ',
        data: {
          ...tokens,
          user: {
            id: user.id,
            name: user.name,
            phone: user.phone,
            role: user.role,
            wechatId: user.wechatId
          }
        }
      };
    } catch (error) {
      this.logger.error(`å°ç¨‹åºç™»å½•å¤±è´¥: ${error.message}`, error.stack);
      return {
        code: RESPONSE_CODES.SERVER_ERROR,
        message: error.message || 'ç™»å½•å¤±è´¥',
        data: null
      };
    }
  }

  /**
   * åˆ·æ–°Token
   */
  @Public()
  @Post('refresh-token')
  @ApiOperation({ summary: 'åˆ·æ–°Access Token' })
  async refreshToken(@Body() refreshTokenDto: RefreshTokenDto) {
    try {
      const tokens = await this.tokenService.refreshAccessToken(refreshTokenDto.refreshToken);
      
      return {
        code: RESPONSE_CODES.SUCCESS,
        message: 'Tokenåˆ·æ–°æˆåŠŸ',
        data: tokens
      };
    } catch (error) {
      this.logger.error(`Tokenåˆ·æ–°å¤±è´¥: ${error.message}`);
      return {
        code: RESPONSE_CODES.UNAUTHORIZED,
        message: error.message,
        data: null
      };
    }
  }
}
```

## ğŸ“± å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

### å°ç¨‹åºç™»å½•æµç¨‹
```javascript
// å°ç¨‹åºç™»å½•ç¤ºä¾‹
async function loginWithWechat() {
  try {
    // 1. è·å–å¾®ä¿¡æˆæƒcode
    const { code } = await wx.login();
    
    // 2. è·å–æ‰‹æœºå·æˆæƒ
    wx.getUserProfile({
      desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
      success: async (res) => {
        // 3. è·å–æ‰‹æœºå·code
        wx.getPhoneNumber({
          success: async (phoneRes) => {
            // 4. è·å–è®¾å¤‡ä¿¡æ¯
            const deviceInfo = wx.getSystemInfoSync();
            const macAddress = deviceInfo.deviceId || generateDeviceId();
            
            // 5. è°ƒç”¨ç™»å½•æ¥å£
            const loginResult = await wx.request({
              url: '/api/miniprogram/login-with-phone',
              method: 'POST',
              data: {
                code: phoneRes.code,
                jsCode: code,
                macAddress: macAddress
              }
            });
            
            if (loginResult.data.code === 200) {
              // 6. ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
              wx.setStorageSync('accessToken', loginResult.data.data.accessToken);
              wx.setStorageSync('refreshToken', loginResult.data.data.refreshToken);
              wx.setStorageSync('userInfo', loginResult.data.data.user);
              wx.setStorageSync('deviceId', macAddress);
              
              console.log('ç™»å½•æˆåŠŸ');
            } else {
              console.error('ç™»å½•å¤±è´¥:', loginResult.data.message);
            }
          }
        });
      }
    });
  } catch (error) {
    console.error('ç™»å½•è¿‡ç¨‹å‡ºé”™:', error);
  }
}

// Tokenè‡ªåŠ¨åˆ·æ–°
async function refreshTokenIfNeeded() {
  const refreshToken = wx.getStorageSync('refreshToken');
  if (!refreshToken) return false;
  
  try {
    const result = await wx.request({
      url: '/api/miniprogram/refresh-token',
      method: 'POST',
      data: { refreshToken }
    });
    
    if (result.data.code === 200) {
      wx.setStorageSync('accessToken', result.data.data.accessToken);
      wx.setStorageSync('refreshToken', result.data.data.refreshToken);
      return true;
    }
  } catch (error) {
    console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
  }
  
  return false;
}
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®
```env
# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APPID=your_wechat_appid_here
WECHAT_APP_SECRET=your_wechat_app_secret_here

# JWTé…ç½®
JWT_SECRET=logistics-system-jwt-secret-2024
JWT_EXPIRES_IN=2h
```

---

**ç›¸å…³æ–‡æ¡£**:
- [ç”¨æˆ·è®¤è¯æ¨¡å—å®ç°](./ç”¨æˆ·è®¤è¯æ¨¡å—å®ç°.md)
- [å°ç¨‹åºAPIæ–‡æ¡£](../07-APIæ–‡æ¡£/å°ç¨‹åºAPI.md)
- [å¾®ä¿¡å°ç¨‹åºé…ç½®æŒ‡å—](../08-å°ç¨‹åºå¼€å‘/å¾®ä¿¡å°ç¨‹åºé…ç½®æŒ‡å—.md)
