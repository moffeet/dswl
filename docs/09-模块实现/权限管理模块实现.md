# 🛡️ 权限管理模块实现详解

## 📋 模块概述

权限管理模块基于RBAC（基于角色的访问控制）模型，实现了用户-角色-权限的三层权限控制体系。支持细粒度的页面访问控制和操作权限控制。

## 🏗️ 模块架构

### 目录结构
```
backend-node/src/
├── users/                     # 用户管理
│   ├── users.controller.ts
│   ├── users.service.ts
│   └── entities/user.entity.ts
├── roles/                     # 角色管理
│   ├── roles.controller.ts
│   ├── roles.service.ts
│   └── entities/role.entity.ts
├── permissions/               # 权限管理
│   ├── permissions.controller.ts
│   ├── permissions.service.ts
│   └── entities/permission.entity.ts
└── auth/
    ├── permission-check.service.ts  # 权限检查服务
    └── casl-ability.factory.ts     # CASL权限工厂
```

### 数据模型关系
```
User (用户) ←→ UserRole (用户角色) ←→ Role (角色)
                                        ↓
                                   RolePermission (角色权限)
                                        ↓
                                 Permission (权限)
```

## 🗄️ 数据实体设计

### 1. 用户实体 (User)
```typescript
@Entity('t_users')
export class User {
  @PrimaryGeneratedColumn({ comment: '用户ID' })
  id: number;

  @Column({ length: 50, unique: true, comment: '用户名' })
  username: string;

  @Column({ length: 255, comment: '密码（加密后）' })
  password: string;

  @Column({ length: 100, nullable: false, comment: '昵称' })
  nickname: string;

  @Column({ name: 'is_first_login', type: 'tinyint', width: 1, default: 1 })
  isFirstLogin: number;

  @Column({ name: 'last_login_time', type: 'datetime', nullable: true })
  lastLoginTime?: Date;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  // 多对多关系：用户-角色
  @ManyToMany(() => Role)
  @JoinTable({
    name: 't_user_roles',
    joinColumn: { name: 'user_id', referencedColumnName: 'id' },
    inverseJoinColumn: { name: 'role_id', referencedColumnName: 'id' }
  })
  roles: Role[];
}
```

### 2. 角色实体 (Role)
```typescript
@Entity('t_roles')
export class Role {
  @PrimaryGeneratedColumn({ comment: '角色ID' })
  id: number;

  @Column({ name: 'role_name', length: 50, comment: '角色名称' })
  roleName: string;

  @Column({ name: 'role_code', length: 50, unique: true, comment: '角色代码' })
  roleCode: string;

  @Column({ length: 200, nullable: true, comment: '角色描述' })
  description?: string;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  // 多对多关系：角色-权限
  @ManyToMany(() => Permission)
  @JoinTable({
    name: 't_role_permissions',
    joinColumn: { name: 'role_id', referencedColumnName: 'id' },
    inverseJoinColumn: { name: 'permission_id', referencedColumnName: 'id' }
  })
  permissions: Permission[];
}
```

### 3. 权限实体 (Permission)
```typescript
@Entity('t_permissions')
export class Permission {
  @PrimaryGeneratedColumn({ comment: '权限ID' })
  id: number;

  @Column({ name: 'permission_name', length: 100, comment: '权限名称' })
  permissionName: string;

  @Column({ name: 'permission_code', length: 100, unique: true, comment: '权限代码' })
  permissionCode: string;

  @Column({ name: 'permission_type', type: 'enum', enum: PermissionType, comment: '权限类型' })
  permissionType: PermissionType;

  @Column({ length: 200, nullable: true, comment: '权限描述' })
  description?: string;

  @Column({ type: 'enum', enum: PermissionStatus, default: PermissionStatus.NORMAL })
  status: PermissionStatus;
}

export enum PermissionType {
  MENU = 'menu',     // 菜单权限
  ACTION = 'action'  // 操作权限
}

export enum PermissionStatus {
  NORMAL = 'normal',     // 正常
  DISABLED = 'disabled'  // 禁用
}
```

## 🔍 权限检查服务实现

### 核心权限检查逻辑
```typescript
@Injectable()
export class PermissionCheckService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
    @InjectRepository(Role)
    private roleRepository: Repository<Role>,
    @InjectRepository(Permission)
    private permissionRepository: Repository<Permission>,
  ) {}

  /**
   * 获取用户权限信息
   */
  async getUserPermissionInfo(userId: number): Promise<UserPermissionInfo> {
    // 获取用户信息
    const user = await this.userRepository.findOne({
      where: { id: userId, isDeleted: 0 }
    });

    if (!user) {
      throw new Error('用户不存在');
    }

    // 手动查询用户的角色信息
    const roles = await this.roleRepository
      .createQueryBuilder('role')
      .innerJoin('t_user_roles', 'ur', 'ur.role_id = role.id')
      .where('ur.user_id = :userId', { userId })
      .andWhere('role.is_deleted = 0')
      .getMany();

    // 检查用户是否有角色
    const hasRole = roles && roles.length > 0;

    // 检查是否为超级管理员
    const isAdmin = roles.some(role => role.roleCode === 'admin');

    // 获取用户的所有权限
    let permissions: string[] = [];
    if (hasRole) {
      if (isAdmin) {
        // 超级管理员拥有所有权限
        const { generateAllPermissions } = await import('../common/constants/permissions');
        const allPermissions = generateAllPermissions();
        permissions = allPermissions.map(p => p.code);
      } else {
        // 获取所有角色的权限
        const roleIds = roles.map(role => role.id);
        if (roleIds.length > 0) {
          const rolePermissions = await this.permissionRepository
            .createQueryBuilder('permission')
            .innerJoin('t_role_permissions', 'rp', 'rp.permission_id = permission.id')
            .where('rp.role_id IN (:...roleIds)', { roleIds })
            .andWhere('permission.status = :status', { status: 'normal' })
            .getMany();

          permissions = rolePermissions.map(p => p.permissionCode);
        }
      }
    }

    return {
      hasRole,
      roles,
      permissions,
      canAccessPage: (path: string) => this.canAccessPage(path, permissions, hasRole, isAdmin),
      canPerformAction: (actionCode: string) => isAdmin || permissions.includes(actionCode)
    };
  }

  /**
   * 检查用户是否可以访问指定页面
   */
  private canAccessPage(path: string, permissions: string[], hasRole: boolean, isAdmin: boolean = false): boolean {
    // 超级管理员可以访问所有页面
    if (isAdmin) {
      return true;
    }

    // 如果没有角色，只能访问home页面
    if (!hasRole) {
      return path === '/' || path === '/home' || path === '';
    }

    // home页面所有用户都可以访问
    if (path === '/' || path === '/home' || path === '') {
      return true;
    }

    // 页面路径与权限代码的映射
    const pagePermissionMap: { [key: string]: string } = {
      '/users': 'menu.users',
      '/roles': 'menu.roles',
      '/customer': 'menu.customer',
      '/receipts': 'menu.receipts',
      '/wx-user': 'menu.wxuser',
      '/map': 'menu.map',
      '/permissions': 'menu.permissions'
    };

    // 检查是否有对应页面的权限
    const requiredPermission = pagePermissionMap[path];
    if (requiredPermission) {
      return permissions.includes(requiredPermission);
    }

    // 对于未定义的页面，有角色的用户可以访问
    return hasRole;
  }

  /**
   * 检查用户是否为超级管理员
   */
  async isAdmin(userId: number): Promise<boolean> {
    const roles = await this.roleRepository
      .createQueryBuilder('role')
      .innerJoin('t_user_roles', 'ur', 'ur.role_id = role.id')
      .where('ur.user_id = :userId', { userId })
      .andWhere('role.is_deleted = 0')
      .getMany();

    if (!roles || roles.length === 0) {
      return false;
    }

    return roles.some(role => role.roleCode === 'admin');
  }
}
```

## 🎯 CASL权限工厂

### 动态权限能力定义
```typescript
@Injectable()
export class CaslAbilityFactory {
  createForUser(user: any) {
    const { can, cannot, build } = new AbilityBuilder<
      Ability<[Action, Subjects]>
    >(Ability as AbilityClass<AppAbility>);

    // 根据用户角色定义权限
    if (user.roles?.some(role => role.roleCode === 'admin')) {
      // 超级管理员拥有所有权限
      can(Action.Manage, 'all');
    } else {
      // 普通用户权限
      can(Action.Read, 'User', { id: user.id });
      can(Action.Update, 'User', { id: user.id });
      
      // 根据用户的具体权限设置
      user.permissions?.forEach(permission => {
        switch (permission.permissionCode) {
          case 'user.read':
            can(Action.Read, 'User');
            break;
          case 'user.create':
            can(Action.Create, 'User');
            break;
          case 'user.update':
            can(Action.Update, 'User');
            break;
          case 'user.delete':
            can(Action.Delete, 'User');
            break;
          // 更多权限映射...
        }
      });
    }

    return build({
      detectSubjectType: (item) =>
        item.constructor as ExtractSubjectType<Subjects>,
    });
  }
}

// 权限动作枚举
export enum Action {
  Manage = 'manage',
  Create = 'create',
  Read = 'read',
  Update = 'update',
  Delete = 'delete',
}

// 权限主体类型
type Subjects = InferSubjects<typeof User | typeof Role | typeof Permission> | 'all';
export type AppAbility = Ability<[Action, Subjects]>;
```

## 🔧 权限装饰器

### 权限检查装饰器
```typescript
// 权限检查装饰器
export const CheckPermissions = (...permissions: string[]) =>
  SetMetadata('permissions', permissions);

// 权限守卫
@Injectable()
export class PermissionsGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private caslAbilityFactory: CaslAbilityFactory,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requiredPermissions = this.reflector.get<string[]>(
      'permissions',
      context.getHandler(),
    );

    if (!requiredPermissions) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    const ability = this.caslAbilityFactory.createForUser(user);

    return requiredPermissions.every((permission) =>
      ability.can(Action.Manage, permission),
    );
  }
}
```

## 🎨 前端权限控制

### React权限上下文
```typescript
// 权限上下文
export const PermissionContext = createContext<{
  permissionInfo: UserPermissionInfo | null;
  hasRole: boolean;
  canAccessPage: (path: string) => boolean;
  canPerformAction: (actionCode: string) => boolean;
  isLoading: boolean;
}>({
  permissionInfo: null,
  hasRole: false,
  canAccessPage: () => false,
  canPerformAction: () => false,
  isLoading: true,
});

// 权限提供者组件
export function PermissionProvider({ children }: { children: React.ReactNode }) {
  const [permissionInfo, setPermissionInfo] = useState<UserPermissionInfo | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchPermissions = async () => {
      try {
        const response = await api.get('/auth/permissions');
        setPermissionInfo(response.data);
      } catch (error) {
        console.error('获取权限信息失败:', error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchPermissions();
  }, []);

  const hasRole = permissionInfo?.hasRole || false;
  
  const canAccessPage = useCallback((path: string): boolean => {
    if (!permissionInfo) return false;
    return permissionInfo.canAccessPage(path);
  }, [permissionInfo]);

  const canPerformAction = useCallback((actionCode: string): boolean => {
    if (!permissionInfo) return false;
    return permissionInfo.canPerformAction(actionCode);
  }, [permissionInfo]);

  return (
    <PermissionContext.Provider value={{
      permissionInfo,
      hasRole,
      canAccessPage,
      canPerformAction,
      isLoading,
    }}>
      {children}
    </PermissionContext.Provider>
  );
}
```

### 页面权限守卫组件
```typescript
export function PagePermissionGuard({ children }: { children: React.ReactNode }) {
  const { isLoading, hasRole, canAccessPage } = useContext(PermissionContext);
  const pathname = usePathname();
  const router = useRouter();

  useEffect(() => {
    // 如果正在加载权限信息，不做任何处理
    if (isLoading) {
      return;
    }

    // 如果没有角色且不是首页，跳转到首页
    if (!hasRole && pathname !== '/' && pathname !== '/home') {
      router.push('/');
      return;
    }

    // 如果有角色但没有权限访问当前页面，跳转到首页
    if (hasRole && !canAccessPage(pathname)) {
      router.push('/');
      return;
    }
  }, [isLoading, hasRole, pathname, canAccessPage, router]);

  if (isLoading) {
    return <div>加载中...</div>;
  }

  return <>{children}</>;
}
```

## 🚀 使用示例

### 1. 控制器中使用权限检查
```typescript
@Controller('users')
@UseGuards(JwtAuthGuard, PermissionsGuard)
export class UsersController {
  
  @Get()
  @CheckPermissions('user.read')
  findAll() {
    return this.usersService.findAll();
  }

  @Post()
  @CheckPermissions('user.create')
  create(@Body() createUserDto: CreateUserDto) {
    return this.usersService.create(createUserDto);
  }

  @Delete(':id')
  @CheckPermissions('user.delete')
  @UseGuards(AdminGuard) // 额外的管理员权限检查
  remove(@Param('id') id: string) {
    return this.usersService.remove(+id);
  }
}
```

### 2. 前端组件中使用权限
```typescript
export function UserManagement() {
  const { canPerformAction } = useContext(PermissionContext);

  return (
    <div>
      <h1>用户管理</h1>
      
      {canPerformAction('user.create') && (
        <Button onClick={handleCreate}>新增用户</Button>
      )}
      
      <Table>
        {users.map(user => (
          <tr key={user.id}>
            <td>{user.username}</td>
            <td>
              {canPerformAction('user.update') && (
                <Button onClick={() => handleEdit(user.id)}>编辑</Button>
              )}
              {canPerformAction('user.delete') && (
                <Button onClick={() => handleDelete(user.id)}>删除</Button>
              )}
            </td>
          </tr>
        ))}
      </Table>
    </div>
  );
}
```

## 📊 权限数据初始化

### 默认权限配置
```typescript
export const DEFAULT_PERMISSIONS = [
  // 菜单权限
  { code: 'menu.users', name: '用户管理', type: 'menu' },
  { code: 'menu.roles', name: '角色管理', type: 'menu' },
  { code: 'menu.permissions', name: '权限管理', type: 'menu' },
  { code: 'menu.customer', name: '客户管理', type: 'menu' },
  { code: 'menu.receipts', name: '签收单管理', type: 'menu' },
  { code: 'menu.wxuser', name: '小程序用户', type: 'menu' },
  
  // 操作权限
  { code: 'user.create', name: '创建用户', type: 'action' },
  { code: 'user.read', name: '查看用户', type: 'action' },
  { code: 'user.update', name: '更新用户', type: 'action' },
  { code: 'user.delete', name: '删除用户', type: 'action' },
  
  { code: 'role.create', name: '创建角色', type: 'action' },
  { code: 'role.read', name: '查看角色', type: 'action' },
  { code: 'role.update', name: '更新角色', type: 'action' },
  { code: 'role.delete', name: '删除角色', type: 'action' },
];

export const DEFAULT_ROLES = [
  {
    code: 'admin',
    name: '超级管理员',
    description: '拥有系统所有权限',
    permissions: DEFAULT_PERMISSIONS.map(p => p.code)
  },
  {
    code: 'operator',
    name: '操作员',
    description: '基础操作权限',
    permissions: [
      'menu.customer',
      'menu.receipts',
      'customer.read',
      'receipt.read'
    ]
  }
];
```

---

**相关文档**:
- [用户认证模块实现](./用户认证模块实现.md)
- [数据库设计](../01-架构设计/数据库设计.md)
- [安全认证指南](../03-安全认证/)
