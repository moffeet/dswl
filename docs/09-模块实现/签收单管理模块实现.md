# 📋 签收单管理模块实现详解

## 📋 模块概述

签收单管理模块负责处理物流配送过程中的签收单据管理，包括图片上传、地理位置记录、签收信息管理等功能。支持多种文件格式上传和自动图片压缩处理。

## 🏗️ 模块架构

### 目录结构
```
backend-node/src/receipts/
├── receipts.controller.ts      # 签收单控制器
├── receipts.service.ts         # 签收单服务
├── receipts.module.ts          # 签收单模块
├── entities/
│   └── receipt.entity.ts       # 签收单实体
├── dto/
│   ├── create-receipt.dto.ts   # 创建签收单DTO
│   ├── update-receipt.dto.ts   # 更新签收单DTO
│   └── upload-receipt.dto.ts   # 上传签收单DTO
└── services/
    └── image-compression.service.ts # 图片压缩服务
```

### 前端结构
```
admin-frontend/src/app/receipts/
├── page.tsx                    # 签收单管理页面
├── components/
│   ├── ReceiptTable.tsx        # 签收单表格组件
│   ├── ReceiptDetail.tsx       # 签收单详情组件
│   ├── ImagePreview.tsx        # 图片预览组件
│   └── SearchForm.tsx          # 搜索表单组件
└── hooks/
    └── useReceipts.tsx         # 签收单数据Hook
```

## 🗄️ 数据实体设计

### 签收单实体 (Receipt)
```typescript
@Entity('t_receipts')
export class Receipt {
  @PrimaryGeneratedColumn({ comment: '签收单ID' })
  id: number;

  @Column({ name: 'customer_number', length: 50, comment: '客户编号' })
  customerNumber: string;

  @Column({ name: 'customer_name', length: 100, comment: '客户名称' })
  customerName: string;

  @Column({ name: 'operator_name', length: 50, comment: '操作员姓名' })
  operatorName: string;

  @Column({ name: 'operator_phone', length: 20, nullable: true, comment: '操作员手机号' })
  operatorPhone?: string;

  @Column({ name: 'image_path', length: 500, comment: '图片路径' })
  imagePath: string;

  @Column({ name: 'image_url', length: 500, comment: '图片访问URL' })
  imageUrl: string;

  @Column({ name: 'original_filename', length: 255, comment: '原始文件名' })
  originalFilename: string;

  @Column({ name: 'file_size', type: 'int', comment: '文件大小（字节）' })
  fileSize: number;

  @Column({ name: 'compressed_size', type: 'int', nullable: true, comment: '压缩后大小（字节）' })
  compressedSize?: number;

  @Column({ name: 'upload_longitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  uploadLongitude?: number;

  @Column({ name: 'upload_latitude', type: 'decimal', precision: 10, scale: 7, nullable: true })
  uploadLatitude?: number;

  @Column({ name: 'upload_address', length: 500, nullable: true, comment: '上传地址' })
  uploadAddress?: string;

  @Column({ name: 'upload_time', type: 'datetime', comment: '上传时间' })
  uploadTime: Date;

  @Column({ name: 'remarks', type: 'text', nullable: true, comment: '备注信息' })
  remarks?: string;

  @Column({ name: 'wx_user_id', type: 'int', nullable: true, comment: '小程序用户ID' })
  wxUserId?: number;

  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0 })
  isDeleted: number;

  @CreateDateColumn({ name: 'created_at', comment: '创建时间' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at', comment: '更新时间' })
  updatedAt: Date;
}
```

## 🖼️ 图片压缩服务

### 图片压缩服务 (ImageCompressionService)
```typescript
@Injectable()
export class ImageCompressionService {
  private readonly logger = new CustomLogger('ImageCompressionService');

  /**
   * 压缩图片
   */
  async compressImage(inputPath: string, outputPath: string, options: CompressionOptions = {}): Promise<CompressionResult> {
    const {
      quality = 80,
      maxWidth = 1920,
      maxHeight = 1080,
      format = 'jpeg'
    } = options;

    try {
      // 获取原始文件信息
      const originalStats = await fs.stat(inputPath);
      const originalSize = originalStats.size;

      this.logger.log(`开始压缩图片 - 原始大小: ${this.formatFileSize(originalSize)}, 输入路径: ${inputPath}`);

      // 使用Sharp进行图片压缩
      const sharpInstance = sharp(inputPath);
      
      // 获取图片元数据
      const metadata = await sharpInstance.metadata();
      this.logger.log(`图片信息 - 宽度: ${metadata.width}, 高度: ${metadata.height}, 格式: ${metadata.format}`);

      // 调整图片尺寸和质量
      let processedImage = sharpInstance;

      // 如果图片尺寸超过限制，进行缩放
      if (metadata.width > maxWidth || metadata.height > maxHeight) {
        processedImage = processedImage.resize(maxWidth, maxHeight, {
          fit: 'inside',
          withoutEnlargement: true
        });
        this.logger.log(`图片尺寸调整 - 最大宽度: ${maxWidth}, 最大高度: ${maxHeight}`);
      }

      // 根据格式进行压缩
      switch (format.toLowerCase()) {
        case 'jpeg':
        case 'jpg':
          processedImage = processedImage.jpeg({ quality, progressive: true });
          break;
        case 'png':
          processedImage = processedImage.png({ quality, progressive: true });
          break;
        case 'webp':
          processedImage = processedImage.webp({ quality });
          break;
        default:
          processedImage = processedImage.jpeg({ quality, progressive: true });
      }

      // 保存压缩后的图片
      await processedImage.toFile(outputPath);

      // 获取压缩后文件信息
      const compressedStats = await fs.stat(outputPath);
      const compressedSize = compressedStats.size;
      const compressionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(2);

      this.logger.log(`图片压缩完成 - 压缩后大小: ${this.formatFileSize(compressedSize)}, 压缩率: ${compressionRatio}%`);

      return {
        originalSize,
        compressedSize,
        compressionRatio: parseFloat(compressionRatio),
        outputPath,
        success: true
      };
    } catch (error) {
      this.logger.error(`图片压缩失败: ${error.message}`, error.stack);
      return {
        originalSize: 0,
        compressedSize: 0,
        compressionRatio: 0,
        outputPath: '',
        success: false,
        error: error.message
      };
    }
  }

  /**
   * 格式化文件大小显示
   */
  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  /**
   * 验证图片格式
   */
  isValidImageFormat(filename: string): boolean {
    const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
    const extension = path.extname(filename).toLowerCase();
    return validExtensions.includes(extension);
  }

  /**
   * 获取图片MIME类型
   */
  getImageMimeType(filename: string): string {
    const extension = path.extname(filename).toLowerCase();
    const mimeTypes = {
      '.jpg': 'image/jpeg',
      '.jpeg': 'image/jpeg',
      '.png': 'image/png',
      '.gif': 'image/gif',
      '.webp': 'image/webp'
    };
    return mimeTypes[extension] || 'image/jpeg';
  }
}

// 压缩选项接口
interface CompressionOptions {
  quality?: number;      // 压缩质量 (1-100)
  maxWidth?: number;     // 最大宽度
  maxHeight?: number;    // 最大高度
  format?: string;       // 输出格式
}

// 压缩结果接口
interface CompressionResult {
  originalSize: number;
  compressedSize: number;
  compressionRatio: number;
  outputPath: string;
  success: boolean;
  error?: string;
}
```

## 🔍 签收单服务实现

### 签收单服务 (ReceiptsService)
```typescript
@Injectable()
export class ReceiptsService {
  private readonly logger = new CustomLogger('ReceiptsService');

  constructor(
    @InjectRepository(Receipt)
    private receiptRepository: Repository<Receipt>,
    private imageCompressionService: ImageCompressionService,
  ) {}

  /**
   * 分页查询签收单列表
   */
  async findAll(page: number = 1, limit: number = 10, user?: any): Promise<PaginatedResponse<Receipt>> {
    const skip = (page - 1) * limit;

    const [receipts, total] = await this.receiptRepository.findAndCount({
      where: { isDeleted: 0 },
      skip,
      take: limit,
      order: { uploadTime: 'DESC' },
    });

    this.logger.log(`查询签收单列表 - 页码: ${page}, 每页: ${limit}, 总数: ${total}, 用户: ${user?.id || '未知'}`);

    return {
      data: receipts,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * 搜索签收单
   */
  async search(searchParams: any, user?: any): Promise<PaginatedResponse<Receipt>> {
    const { customerNumber, customerName, operatorName, startDate, endDate, page = 1, limit = 10 } = searchParams;
    const skip = (page - 1) * limit;

    const queryBuilder = this.receiptRepository.createQueryBuilder('receipt')
      .where('receipt.isDeleted = :isDeleted', { isDeleted: 0 });

    // 客户编号搜索
    if (customerNumber) {
      queryBuilder.andWhere('receipt.customerNumber LIKE :customerNumber', { customerNumber: `%${customerNumber}%` });
    }

    // 客户名称搜索
    if (customerName) {
      queryBuilder.andWhere('receipt.customerName LIKE :customerName', { customerName: `%${customerName}%` });
    }

    // 操作员搜索
    if (operatorName) {
      queryBuilder.andWhere('receipt.operatorName LIKE :operatorName', { operatorName: `%${operatorName}%` });
    }

    // 时间范围搜索
    if (startDate) {
      queryBuilder.andWhere('receipt.uploadTime >= :startDate', { startDate });
    }
    if (endDate) {
      queryBuilder.andWhere('receipt.uploadTime <= :endDate', { endDate });
    }

    // 分页和排序
    queryBuilder
      .skip(skip)
      .take(limit)
      .orderBy('receipt.uploadTime', 'DESC');

    const [receipts, total] = await queryBuilder.getManyAndCount();

    this.logger.log(`搜索签收单 - 客户编号: ${customerNumber}, 客户名称: ${customerName}, 结果数: ${receipts.length}, 用户: ${user?.id || '未知'}`);

    return {
      data: receipts,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * 上传签收单
   */
  async uploadReceipt(
    file: Express.Multer.File,
    uploadReceiptDto: UploadReceiptDto,
    user?: any
  ): Promise<Receipt> {
    const {
      customerNumber,
      customerName,
      operatorName,
      operatorPhone,
      uploadLongitude,
      uploadLatitude,
      uploadAddress,
      remarks
    } = uploadReceiptDto;

    try {
      // 验证文件格式
      if (!this.imageCompressionService.isValidImageFormat(file.originalname)) {
        throw new BadRequestException('不支持的图片格式，请上传 JPG、PNG、GIF 或 WebP 格式的图片');
      }

      // 生成文件路径
      const uploadDir = UploadConfig.getUploadPath('receipts');
      const filename = this.generateFilename(file.originalname);
      const originalPath = path.join(uploadDir, filename);
      const compressedFilename = `compressed_${filename}`;
      const compressedPath = path.join(uploadDir, compressedFilename);

      // 确保上传目录存在
      await fs.ensureDir(uploadDir);

      // 保存原始文件
      await fs.writeFile(originalPath, file.buffer);
      this.logger.log(`保存原始文件 - 路径: ${originalPath}, 大小: ${file.size} bytes`);

      // 压缩图片
      const compressionResult = await this.imageCompressionService.compressImage(
        originalPath,
        compressedPath,
        {
          quality: 80,
          maxWidth: 1920,
          maxHeight: 1080,
          format: 'jpeg'
        }
      );

      let finalPath = originalPath;
      let finalSize = file.size;
      let compressedSize = null;

      if (compressionResult.success && compressionResult.compressedSize < file.size) {
        // 如果压缩成功且文件更小，使用压缩后的文件
        finalPath = compressedPath;
        finalSize = compressionResult.compressedSize;
        compressedSize = compressionResult.compressedSize;
        
        // 删除原始文件
        await fs.remove(originalPath);
        this.logger.log(`使用压缩文件 - 压缩率: ${compressionResult.compressionRatio}%`);
      } else {
        // 否则使用原始文件，删除压缩文件
        if (await fs.pathExists(compressedPath)) {
          await fs.remove(compressedPath);
        }
        this.logger.log('使用原始文件 - 压缩效果不佳或失败');
      }

      // 生成访问URL
      const imageUrl = `/receipts/uploads/${path.basename(finalPath)}`;

      // 创建签收单记录
      const receipt = this.receiptRepository.create({
        customerNumber,
        customerName,
        operatorName,
        operatorPhone,
        imagePath: finalPath,
        imageUrl,
        originalFilename: file.originalname,
        fileSize: file.size,
        compressedSize,
        uploadLongitude: uploadLongitude ? parseFloat(uploadLongitude.toString()) : null,
        uploadLatitude: uploadLatitude ? parseFloat(uploadLatitude.toString()) : null,
        uploadAddress,
        uploadTime: new Date(),
        remarks,
        wxUserId: user?.id,
      });

      const savedReceipt = await this.receiptRepository.save(receipt);

      this.logger.log(`签收单上传成功 - ID: ${savedReceipt.id}, 客户: ${customerName}, 操作员: ${operatorName}, 文件大小: ${finalSize} bytes`);

      return savedReceipt;
    } catch (error) {
      this.logger.error(`签收单上传失败: ${error.message}`, error.stack);
      throw error;
    }
  }

  /**
   * 删除签收单
   */
  async remove(id: number, user?: any): Promise<void> {
    const receipt = await this.findOne(id);

    // 软删除
    await this.receiptRepository.update(id, { isDeleted: 1 });

    // 删除文件（可选）
    try {
      if (await fs.pathExists(receipt.imagePath)) {
        await fs.remove(receipt.imagePath);
        this.logger.log(`删除签收单文件 - 路径: ${receipt.imagePath}`);
      }
    } catch (error) {
      this.logger.warn(`删除文件失败: ${error.message}`);
    }

    this.logger.log(`删除签收单成功 - ID: ${id}, 客户: ${receipt.customerName}, 操作人: ${user?.username || '系统'}`);
  }

  /**
   * 批量删除签收单
   */
  async batchRemove(ids: number[], user?: any): Promise<void> {
    const receipts = await this.receiptRepository.findByIds(ids);

    // 批量软删除
    await this.receiptRepository.update(
      { id: In(ids) },
      { isDeleted: 1 }
    );

    // 删除文件
    for (const receipt of receipts) {
      try {
        if (await fs.pathExists(receipt.imagePath)) {
          await fs.remove(receipt.imagePath);
        }
      } catch (error) {
        this.logger.warn(`删除文件失败: ${receipt.imagePath} - ${error.message}`);
      }
    }

    this.logger.log(`批量删除签收单成功 - 数量: ${ids.length}, 操作人: ${user?.username || '系统'}`);
  }

  /**
   * 生成唯一文件名
   */
  private generateFilename(originalname: string): string {
    const timestamp = Date.now();
    const randomString = Math.random().toString(36).substring(2, 15);
    const extension = path.extname(originalname);
    return `${timestamp}_${randomString}${extension}`;
  }

  /**
   * 根据ID查找签收单
   */
  async findOne(id: number): Promise<Receipt> {
    const receipt = await this.receiptRepository.findOne({
      where: { id, isDeleted: 0 },
    });

    if (!receipt) {
      throw new NotFoundException(`签收单不存在 (ID: ${id})`);
    }

    return receipt;
  }
}
```

## 🎯 控制器实现

### 签收单控制器 (ReceiptsController)
```typescript
@ApiTags('签收单管理')
@Controller('receipts')
@UseGuards(JwtAuthGuard)
export class ReceiptsController {
  private readonly logger = new CustomLogger('ReceiptsController');

  constructor(private readonly receiptsService: ReceiptsService) {}

  @Get()
  @ApiOperation({ summary: '获取签收单列表' })
  async findAll(
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 10,
    @Req() req,
  ) {
    return this.receiptsService.findAll(page, limit, req.user);
  }

  @Get('search')
  @ApiOperation({ summary: '搜索签收单' })
  async search(@Query() searchParams: any, @Req() req) {
    return this.receiptsService.search(searchParams, req.user);
  }

  @Get(':id')
  @ApiOperation({ summary: '获取签收单详情' })
  async findOne(@Param('id') id: string) {
    return this.receiptsService.findOne(+id);
  }

  @Post('upload')
  @ApiOperation({ summary: '上传签收单' })
  @UseInterceptors(FileInterceptor('file', {
    limits: {
      fileSize: 10 * 1024 * 1024, // 10MB
    },
    fileFilter: (req, file, callback) => {
      if (!file.mimetype.startsWith('image/')) {
        return callback(new BadRequestException('只能上传图片文件'), false);
      }
      callback(null, true);
    },
  }))
  async uploadReceipt(
    @UploadedFile() file: Express.Multer.File,
    @Body() uploadReceiptDto: UploadReceiptDto,
    @Req() req,
  ) {
    if (!file) {
      throw new BadRequestException('请选择要上传的图片文件');
    }

    return this.receiptsService.uploadReceipt(file, uploadReceiptDto, req.user);
  }

  @Delete(':id')
  @ApiOperation({ summary: '删除签收单' })
  async remove(@Param('id') id: string, @Req() req) {
    return this.receiptsService.remove(+id, req.user);
  }

  @Delete('batch')
  @ApiOperation({ summary: '批量删除签收单' })
  async batchRemove(@Body() { ids }: { ids: number[] }, @Req() req) {
    return this.receiptsService.batchRemove(ids, req.user);
  }
}
```

## 🎨 前端实现

### 签收单管理页面
```typescript
export default function ReceiptsPage() {
  const [receipts, setReceipts] = useState<Receipt[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedReceipt, setSelectedReceipt] = useState<Receipt | null>(null);
  const [showImagePreview, setShowImagePreview] = useState(false);

  const fetchReceipts = async (page = 1, limit = 10, searchParams = {}) => {
    setLoading(true);
    try {
      const response = await api.get('/receipts', {
        params: { page, limit, ...searchParams },
      });
      
      setReceipts(response.data.data);
    } catch (error) {
      console.error('获取签收单列表失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleImagePreview = (receipt: Receipt) => {
    setSelectedReceipt(receipt);
    setShowImagePreview(true);
  };

  const handleDelete = async (id: number) => {
    try {
      await api.delete(`/receipts/${id}`);
      message.success('删除成功');
      fetchReceipts();
    } catch (error) {
      message.error('删除失败');
    }
  };

  return (
    <div className="receipts-management">
      <div className="header">
        <h1>签收单管理</h1>
      </div>

      <SearchForm onSearch={fetchReceipts} />
      
      <ReceiptTable
        receipts={receipts}
        loading={loading}
        onImagePreview={handleImagePreview}
        onDelete={handleDelete}
      />

      <ImagePreview
        visible={showImagePreview}
        receipt={selectedReceipt}
        onClose={() => setShowImagePreview(false)}
      />
    </div>
  );
}
```

---

**相关文档**:
- [文件上传配置](../05-开发指南/文件上传配置.md)
- [图片处理服务](./图片处理模块实现.md)
- [小程序上传功能](./小程序上传模块实现.md)
