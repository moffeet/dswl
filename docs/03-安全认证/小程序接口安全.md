# ğŸ” å°ç¨‹åºæ¥å£å®‰å…¨

## ğŸ“‹ æ¦‚è¿°

å°ç¨‹åºæ¥å£å®‰å…¨æ˜¯æ•´ä¸ªç³»ç»Ÿå®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ä¸ºäº†ä¿è¯å°ç¨‹åºæ¥å£çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚å’Œé‡æ”¾æ”»å‡»ï¼Œç³»ç»Ÿå®ç°äº†åŸºäºHMAC-SHA256çš„ç­¾åæ ¡éªŒæœºåˆ¶å’ŒTokenè®¤è¯æœºåˆ¶ã€‚

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. åŒé‡è®¤è¯ä½“ç³»
- **ç­¾åæ ¡éªŒ**: åŸºäºHMAC-SHA256çš„è¯·æ±‚ç­¾åéªŒè¯
- **Tokenè®¤è¯**: JWT Tokenç”¨äºç”¨æˆ·èº«ä»½éªŒè¯
- **è®¾å¤‡ç»‘å®š**: MACåœ°å€éªŒè¯ï¼Œç¡®ä¿è®¾å¤‡å®‰å…¨

### 2. é˜²æŠ¤æªæ–½
- **æ—¶é—´æˆ³éªŒè¯**: 5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
- **éšæœºæ•°æœºåˆ¶**: nonceé˜²é‡æ”¾ï¼Œæ¯ä¸ªéšæœºæ•°åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- **å‚æ•°å®Œæ•´æ€§**: æ‰€æœ‰å‚æ•°å‚ä¸ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹
- **å¯†é’¥éš”ç¦»**: æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„ç­¾åå¯†é’¥

## ğŸ” ç­¾åæ ¡éªŒæœºåˆ¶

### ç­¾åç®—æ³•
- **ç®—æ³•**: HMAC-SHA256
- **å¯†é’¥**: æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ç­¾åå¯†é’¥
- **å‚æ•°æ’åº**: æŒ‰å­—å…¸åºæ’åˆ—æ‰€æœ‰å‚æ•°
- **æ—¶é—´æˆ³éªŒè¯**: 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
- **é˜²é‡æ”¾**: nonceæœºåˆ¶

### ç­¾åæµç¨‹

#### 1. æ”¶é›†å‚æ•°
æ”¶é›†æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼ˆåŒ…æ‹¬bodyå’Œqueryå‚æ•°ï¼‰

#### 2. æ·»åŠ ç­¾åå‚æ•°
```javascript
const params = {
  // ä¸šåŠ¡å‚æ•°
  customerNumber: 'C001',
  
  // ç­¾åå‚æ•°
  wxUserId: 1,                    // å°ç¨‹åºç”¨æˆ·ID
  timestamp: Date.now().toString(), // å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  nonce: generateNonce(16)        // éšæœºå­—ç¬¦ä¸²ï¼ˆè‡³å°‘8ä½ï¼‰
};
```

#### 3. å‚æ•°æ’åºå’Œæ‹¼æ¥
```javascript
// æŒ‰å‚æ•°åå­—å…¸åºæ’åº
const sortedKeys = Object.keys(params).sort();

// æ‹¼æ¥å­—ç¬¦ä¸²ï¼škey1=value1&key2=value2&...
const queryString = sortedKeys
  .map(key => `${key}=${params[key]}`)
  .join('&');
```

#### 4. ç”Ÿæˆç­¾å
```javascript
const crypto = require('crypto');

function generateSignature(params, secretKey) {
  // æ’åºå‚æ•°
  const sortedKeys = Object.keys(params).sort();
  
  // æ‹¼æ¥æŸ¥è¯¢å­—ç¬¦ä¸²
  const queryString = sortedKeys
    .map(key => `${key}=${params[key]}`)
    .join('&');
  
  // ç”ŸæˆHMAC-SHA256ç­¾å
  return crypto
    .createHmac('sha256', secretKey)
    .update(queryString)
    .digest('hex');
}
```

#### 5. æ·»åŠ åˆ°è¯·æ±‚
```javascript
params.signature = generateSignature(params, secretKey);
```

### ç­¾åå‚æ•°è¯´æ˜

| å‚æ•°å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `wxUserId` | number | å°ç¨‹åºç”¨æˆ·ID | 1 |
| `timestamp` | string | æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | "1704387123456" |
| `nonce` | string | éšæœºæ•°ï¼ˆâ‰¥8ä½ï¼‰ | "abc123def456" |
| `signature` | string | ç­¾åå€¼ | "a1b2c3d4e5f6..." |

## ğŸ›¡ï¸ Tokenè®¤è¯æœºåˆ¶

### JWT Tokenç»“æ„
```javascript
{
  "sub": 1,                    // ç”¨æˆ·ID
  "username": "å¼ ä¸‰",          // ç”¨æˆ·å
  "phone": "13800000001",      // æ‰‹æœºå·
  "role": "driver",            // ç”¨æˆ·è§’è‰²
  "userType": "wx-user",       // ç”¨æˆ·ç±»å‹
  "iat": 1704387123,           // ç­¾å‘æ—¶é—´
  "exp": 1704473523            // è¿‡æœŸæ—¶é—´
}
```

### Tokenè·å–æµç¨‹
```javascript
// 1. å°ç¨‹åºç™»å½•
const loginResponse = await fetch('/api/wx-users/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    wechatId: 'wx_openid_123',
    phone: '13800000001',
    macAddress: 'AA:BB:CC:DD:EE:FF'
  })
});

// 2. è·å–Token
const { accessToken } = loginResponse.data;

// 3. åç»­è¯·æ±‚æºå¸¦Token
const apiResponse = await fetch('/api/miniprogram/customers/search', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  }
});
```

## ğŸ”§ å‰ç«¯å®ç°ç¤ºä¾‹

### å®Œæ•´çš„ç­¾åç”Ÿæˆå‡½æ•°
```javascript
const crypto = require('crypto');

/**
 * ç”Ÿæˆè¯·æ±‚ç­¾å
 * @param {Object} params è¯·æ±‚å‚æ•°
 * @param {string} secretKey ç­¾åå¯†é’¥
 * @returns {string} ç­¾åå€¼
 */
function generateSignature(params, secretKey) {
  // è¿‡æ»¤æ‰signatureå‚æ•°æœ¬èº«
  const filteredParams = Object.keys(params)
    .filter(key => key !== 'signature')
    .reduce((obj, key) => {
      obj[key] = params[key];
      return obj;
    }, {});

  // æŒ‰å‚æ•°åæ’åº
  const sortedKeys = Object.keys(filteredParams).sort();
  
  // æ‹¼æ¥æŸ¥è¯¢å­—ç¬¦ä¸²
  const queryString = sortedKeys
    .map(key => `${key}=${filteredParams[key]}`)
    .join('&');
  
  // ç”Ÿæˆç­¾å
  return crypto
    .createHmac('sha256', secretKey)
    .update(queryString)
    .digest('hex');
}

/**
 * ç”Ÿæˆéšæœºnonce
 * @param {number} length é•¿åº¦
 * @returns {string} éšæœºå­—ç¬¦ä¸²
 */
function generateNonce(length = 16) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

/**
 * å‘é€å¸¦ç­¾åçš„è¯·æ±‚
 * @param {string} url è¯·æ±‚URL
 * @param {Object} params è¯·æ±‚å‚æ•°
 * @param {string} secretKey ç­¾åå¯†é’¥
 * @param {string} method è¯·æ±‚æ–¹æ³•
 */
async function sendSignedRequest(url, params, secretKey, method = 'GET') {
  // æ·»åŠ ç­¾åå‚æ•°
  const signedParams = {
    ...params,
    timestamp: Date.now().toString(),
    nonce: generateNonce(16)
  };
  
  // ç”Ÿæˆç­¾å
  signedParams.signature = generateSignature(signedParams, secretKey);
  
  // å‘é€è¯·æ±‚
  if (method === 'GET') {
    const queryString = new URLSearchParams(signedParams).toString();
    return fetch(`${url}?${queryString}`);
  } else {
    return fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(signedParams)
    });
  }
}
```

### ä½¿ç”¨ç¤ºä¾‹
```javascript
// å®¢æˆ·æœç´¢
const searchParams = {
  wxUserId: 1,
  customerNumber: 'C001'
};

const response = await sendSignedRequest(
  '/api/miniprogram/customers/search',
  searchParams,
  userSecretKey,
  'GET'
);
```

## ğŸš¨ å®‰å…¨æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†
- **ç¯å¢ƒéš”ç¦»**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥
- **æƒé™æ§åˆ¶**: å¯†é’¥è·å–éœ€è¦ç®¡ç†å‘˜æƒé™éªŒè¯
- **å®šæœŸè½®æ¢**: å®šæœŸæ›´æ¢ç­¾åå¯†é’¥ä»¥æé«˜å®‰å…¨æ€§
- **å®‰å…¨å­˜å‚¨**: å¯†é’¥ä¸å¾—åœ¨å®¢æˆ·ç«¯ç¡¬ç¼–ç æˆ–æ˜æ–‡å­˜å‚¨

### 2. å¼€å‘ç¯å¢ƒé…ç½®
```javascript
// ä»…å¼€å‘ç¯å¢ƒå…è®¸è·å–å¯†é’¥
if (process.env.NODE_ENV === 'production') {
  throw new Error('ç”Ÿäº§ç¯å¢ƒç¦æ­¢è·å–ç”¨æˆ·ç­¾åå¯†é’¥');
}
```

### 3. è¯·æ±‚å®‰å…¨
- **HTTPSä¼ è¾“**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
- **æ—¶é—´åŒæ­¥**: ç¡®ä¿å®¢æˆ·ç«¯æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´åŒæ­¥
- **å‚æ•°éªŒè¯**: ä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- **é”™è¯¯å¤„ç†**: ä¸æš´éœ²æ•æ„Ÿçš„é”™è¯¯ä¿¡æ¯

### 4. ç›‘æ§å’Œæ—¥å¿—
```javascript
// è®°å½•ç­¾åéªŒè¯å¤±è´¥çš„è¯·æ±‚
this.logger.warn(`ç­¾åéªŒè¯å¤±è´¥ - IP: ${req.ip}, User: ${wxUserId}, Error: ${error}`);

// ç›‘æ§å¼‚å¸¸è¯·æ±‚
if (failedAttempts > 5) {
  this.logger.error(`å¯èƒ½çš„æ”»å‡»è¡Œä¸º - IP: ${req.ip}, è¿ç»­å¤±è´¥æ¬¡æ•°: ${failedAttempts}`);
}
```

## âš ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|----------|------|----------|
| 401 | ç¼ºå°‘ç­¾åå‚æ•° | ç¼ºå°‘timestampã€nonceæˆ–signatureå‚æ•° | æ£€æŸ¥è¯·æ±‚å‚æ•°å®Œæ•´æ€§ |
| 401 | æ—¶é—´æˆ³æ ¼å¼æ— æ•ˆ | timestampä¸æ˜¯æœ‰æ•ˆçš„æ•°å­— | ä½¿ç”¨æ­£ç¡®çš„æ—¶é—´æˆ³æ ¼å¼ |
| 401 | è¯·æ±‚å·²è¿‡æœŸ | è¯·æ±‚æ—¶é—´è¶…è¿‡5åˆ†é’Ÿ | æ£€æŸ¥å®¢æˆ·ç«¯æ—¶é—´åŒæ­¥ |
| 401 | nonceé•¿åº¦ä¸èƒ½å°‘äº8ä½ | nonceå‚æ•°å¤ªçŸ­ | ä½¿ç”¨è‡³å°‘8ä½çš„éšæœºå­—ç¬¦ä¸² |
| 401 | è¯·æ±‚é‡å¤ï¼Œnonceå·²è¢«ä½¿ç”¨ | é‡æ”¾æ”»å‡»æ£€æµ‹ | ä½¿ç”¨æ–°çš„nonceå€¼ |
| 401 | ç­¾åéªŒè¯å¤±è´¥ | ç­¾åä¸åŒ¹é… | æ£€æŸ¥ç­¾åç®—æ³•å’Œå¯†é’¥ |
| 401 | ç”¨æˆ·ä¸å­˜åœ¨ | wxUserIdå¯¹åº”çš„ç”¨æˆ·ä¸å­˜åœ¨ | æ£€æŸ¥ç”¨æˆ·IDæœ‰æ•ˆæ€§ |

### é”™è¯¯å“åº”ç¤ºä¾‹
```json
{
  "code": 401,
  "message": "ç­¾åæ ¡éªŒå¤±è´¥: è¯·æ±‚å·²è¿‡æœŸï¼Œæ—¶é—´å·®: 320ç§’",
  "data": null
}
```

## ğŸ”§ å¼€å‘è°ƒè¯•

### è·å–ç”¨æˆ·ç­¾åå¯†é’¥
```javascript
// å¼€å‘ç¯å¢ƒAPIï¼ˆä»…å¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰
const response = await fetch('/api/miniprogram/dev/user-signature-key', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ wxUserId: 1 })
});

const { secretKey } = response.data;
```

### è°ƒè¯•å·¥å…·
1. **åœ¨çº¿HMAC-SHA256è®¡ç®—å™¨**: éªŒè¯ç­¾åç®—æ³•
2. **Postman**: æµ‹è¯•APIæ¥å£
3. **æµè§ˆå™¨å¼€å‘è€…å·¥å…·**: è°ƒè¯•å‰ç«¯ç­¾åç”Ÿæˆ

### æµ‹è¯•ç”¨ä¾‹
```javascript
// æµ‹è¯•ç­¾åç”Ÿæˆ
const testParams = {
  wxUserId: 1,
  customerNumber: 'C001',
  timestamp: '1704387123456',
  nonce: 'test123456789'
};

const testSecretKey = 'test-secret-key';
const expectedSignature = generateSignature(testParams, testSecretKey);

console.log('Expected signature:', expectedSignature);
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [å®‰å…¨æœ€ä½³å®è·µ](./security-best-practices.md) äº†è§£æ›´å¤šå®‰å…¨é…ç½®å’Œé˜²æŠ¤æªæ–½ã€‚
