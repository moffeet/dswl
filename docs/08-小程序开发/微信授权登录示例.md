# ğŸ“± å¾®ä¿¡å°ç¨‹åºæˆæƒç™»å½•å®Œæ•´ç¤ºä¾‹

## ğŸ”„ å®Œæ•´æµç¨‹è¯´æ˜

### 1ï¸âƒ£ å°ç¨‹åºç«¯å®ç°

#### ç™»å½•é¡µé¢ (pages/login/login.js)

```javascript
Page({
  data: {
    loading: false
  },

  onLoad() {
    // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
    const token = wx.getStorageSync('access_token');
    if (token) {
      this.redirectToHome();
    }
  },

  /**
   * å¾®ä¿¡æˆæƒç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   */
  async onWechatLogin() {
    if (this.data.loading) return;
    
    this.setData({ loading: true });

    try {
      // 1. è·å–å¾®ä¿¡ç™»å½•code
      const loginRes = await this.wxLogin();
      console.log('å¾®ä¿¡ç™»å½•code:', loginRes.code);

      // 2. è·å–ç”¨æˆ·æ‰‹æœºå·æˆæƒ
      // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘
      wx.showToast({
        title: 'è¯·ç‚¹å‡»æˆæƒæ‰‹æœºå·æŒ‰é’®',
        icon: 'none'
      });

    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error);
      wx.showToast({
        title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  /**
   * è·å–æ‰‹æœºå·æˆæƒå›è°ƒ
   */
  async getPhoneNumber(e) {
    console.log('æ‰‹æœºå·æˆæƒå›è°ƒ:', e.detail);

    if (!e.detail.code) {
      wx.showToast({
        title: 'éœ€è¦æ‰‹æœºå·æˆæƒæ‰èƒ½ç™»å½•',
        icon: 'none'
      });
      return;
    }

    this.setData({ loading: true });

    try {
      // 1. è·å–å¾®ä¿¡ç™»å½•code
      const loginRes = await this.wxLogin();
      
      // 2. è°ƒç”¨åç«¯ç™»å½•æ¥å£
      const response = await this.requestLogin({
        code: e.detail.code,        // æ‰‹æœºå·æˆæƒcode
        jsCode: loginRes.code,      // å¾®ä¿¡ç™»å½•code
        macAddress: await this.getMacAddress() // å¯é€‰ï¼šè®¾å¤‡MACåœ°å€
      });

      if (response.code === 200) {
        // ç™»å½•æˆåŠŸ
        await this.handleLoginSuccess(response.data);
      } else {
        wx.showModal({
          title: 'ç™»å½•å¤±è´¥',
          content: response.message,
          showCancel: false
        });
      }

    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error);
      wx.showModal({
        title: 'ç™»å½•å¤±è´¥',
        content: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•',
        showCancel: false
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  /**
   * å¾®ä¿¡ç™»å½•è·å–code
   */
  wxLogin() {
    return new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      });
    });
  },

  /**
   * è°ƒç”¨åç«¯ç™»å½•æ¥å£
   */
  requestLogin(data) {
    return new Promise((resolve, reject) => {
      wx.request({
        url: 'https://your-domain.com/api/wx-users/login-with-phone',
        method: 'POST',
        data: data,
        header: {
          'Content-Type': 'application/json'
        },
        success: (res) => {
          resolve(res.data);
        },
        fail: reject
      });
    });
  },

  /**
   * å¤„ç†ç™»å½•æˆåŠŸ
   */
  async handleLoginSuccess(data) {
    // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
    wx.setStorageSync('access_token', data.accessToken);
    wx.setStorageSync('user_info', data.user);

    wx.showToast({
      title: 'ç™»å½•æˆåŠŸ',
      icon: 'success'
    });

    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
    setTimeout(() => {
      this.redirectToHome();
    }, 1500);
  },

  /**
   * è·³è½¬åˆ°ä¸»é¡µ
   */
  redirectToHome() {
    wx.switchTab({
      url: '/pages/index/index'
    });
  },

  /**
   * è·å–è®¾å¤‡MACåœ°å€ï¼ˆå¯é€‰ï¼‰
   */
  async getMacAddress() {
    try {
      const systemInfo = await this.getSystemInfo();
      // æ³¨æ„ï¼šå°ç¨‹åºæ— æ³•ç›´æ¥è·å–çœŸå®MACåœ°å€
      // è¿™é‡Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªè®¾å¤‡å”¯ä¸€æ ‡è¯†
      return this.generateDeviceId(systemInfo);
    } catch (error) {
      console.warn('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
      return null;
    }
  },

  /**
   * è·å–ç³»ç»Ÿä¿¡æ¯
   */
  getSystemInfo() {
    return new Promise((resolve, reject) => {
      wx.getSystemInfo({
        success: resolve,
        fail: reject
      });
    });
  },

  /**
   * ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†
   */
  generateDeviceId(systemInfo) {
    const { model, system, platform, version } = systemInfo;
    const deviceString = `${model}-${system}-${platform}-${version}`;
    // ç®€å•çš„hashç®—æ³•ç”Ÿæˆè®¾å¤‡ID
    let hash = 0;
    for (let i = 0; i < deviceString.length; i++) {
      const char = deviceString.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
    }
    return Math.abs(hash).toString(16);
  }
});
```

#### ç™»å½•é¡µé¢æ ·å¼ (pages/login/login.wxml)

```xml
<view class="login-container">
  <view class="logo-section">
    <image class="logo" src="/images/logo.png" mode="aspectFit"></image>
    <text class="app-name">ç‰©æµç®¡ç†ç³»ç»Ÿ</text>
  </view>

  <view class="login-section">
    <view class="welcome-text">
      <text class="title">æ¬¢è¿ä½¿ç”¨</text>
      <text class="subtitle">è¯·ä½¿ç”¨å¾®ä¿¡æˆæƒç™»å½•</text>
    </view>

    <button 
      class="login-btn {{loading ? 'loading' : ''}}"
      open-type="getPhoneNumber" 
      bindgetphonenumber="getPhoneNumber"
      disabled="{{loading}}">
      <text wx:if="{{!loading}}">å¾®ä¿¡æˆæƒç™»å½•</text>
      <text wx:else>ç™»å½•ä¸­...</text>
    </button>

    <view class="tips">
      <text>â€¢ é¦–æ¬¡ä½¿ç”¨éœ€è¦ç®¡ç†å‘˜åˆ›å»ºè´¦æˆ·</text>
      <text>â€¢ ä»…æ”¯æŒå¸æœºå’Œé”€å”®äººå‘˜ç™»å½•</text>
      <text>â€¢ ç™»å½•åå¯è¿›è¡Œç­¾æ”¶å•ä¸Šä¼ ç­‰æ“ä½œ</text>
    </view>
  </view>
</view>
```

#### ç™»å½•é¡µé¢æ ·å¼ (pages/login/login.wxss)

```css
.login-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40rpx;
}

.logo-section {
  text-align: center;
  margin-bottom: 80rpx;
}

.logo {
  width: 120rpx;
  height: 120rpx;
  margin-bottom: 20rpx;
}

.app-name {
  font-size: 36rpx;
  color: white;
  font-weight: bold;
}

.login-section {
  width: 100%;
  max-width: 600rpx;
}

.welcome-text {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  display: block;
  font-size: 48rpx;
  color: white;
  font-weight: bold;
  margin-bottom: 10rpx;
}

.subtitle {
  display: block;
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
}

.login-btn {
  width: 100%;
  height: 88rpx;
  background: white;
  color: #333;
  border-radius: 44rpx;
  font-size: 32rpx;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40rpx;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.15);
}

.login-btn.loading {
  opacity: 0.7;
}

.login-btn::after {
  border: none;
}

.tips {
  padding: 30rpx;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20rpx;
  backdrop-filter: blur(10rpx);
}

.tips text {
  display: block;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.6;
  margin-bottom: 8rpx;
}

.tips text:last-child {
  margin-bottom: 0;
}
```

### 2ï¸âƒ£ APIæ¥å£è°ƒç”¨å·¥å…·

#### åˆ›å»ºAPIå·¥å…·ç±» (utils/api.js)

```javascript
class ApiClient {
  constructor() {
    this.baseURL = 'https://your-domain.com/api';
    this.timeout = 10000;
  }

  /**
   * é€šç”¨è¯·æ±‚æ–¹æ³•
   */
  request(options) {
    return new Promise((resolve, reject) => {
      const token = wx.getStorageSync('access_token');
      
      wx.request({
        url: `${this.baseURL}${options.url}`,
        method: options.method || 'GET',
        data: options.data,
        header: {
          'Content-Type': 'application/json',
          'Authorization': token ? `Bearer ${token}` : '',
          ...options.header
        },
        timeout: this.timeout,
        success: (res) => {
          if (res.statusCode === 200) {
            resolve(res.data);
          } else {
            reject(new Error(`HTTP ${res.statusCode}`));
          }
        },
        fail: reject
      });
    });
  }

  /**
   * å¾®ä¿¡æˆæƒç™»å½•
   */
  loginWithPhone(data) {
    return this.request({
      url: '/wx-users/login-with-phone',
      method: 'POST',
      data
    });
  }

  /**
   * è·å–å®¢æˆ·åˆ—è¡¨
   */
  getCustomers(params) {
    return this.request({
      url: '/miniprogram/customers',
      method: 'GET',
      data: params
    });
  }

  /**
   * ä¸Šä¼ ç­¾æ”¶å•
   */
  uploadReceipt(data) {
    return this.request({
      url: '/miniprogram/receipts',
      method: 'POST',
      data
    });
  }
}

// å¯¼å‡ºå•ä¾‹
const apiClient = new ApiClient();
export default apiClient;
```

### 3ï¸âƒ£ åç«¯ç¯å¢ƒé…ç½®

åœ¨ `backend-node/.env` æ–‡ä»¶ä¸­æ·»åŠ å¾®ä¿¡å°ç¨‹åºé…ç½®ï¼š

```bash
# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APPID=wx1234567890abcdef  # æ›¿æ¢ä¸ºä½ çš„å°ç¨‹åºAppID
WECHAT_APP_SECRET=your_app_secret_here  # æ›¿æ¢ä¸ºä½ çš„å°ç¨‹åºAppSecret
```

### 4ï¸âƒ£ æµ‹è¯•æµç¨‹

1. **é…ç½®å¾®ä¿¡å°ç¨‹åº**ï¼š
   - åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸå
   - è·å–AppIDå’ŒAppSecret

2. **æµ‹è¯•ç™»å½•æµç¨‹**ï¼š
   - å°ç¨‹åºç«¯ç‚¹å‡»æˆæƒæŒ‰é’®
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤codeè·å–æˆåŠŸ
   - åç«¯æ—¥å¿—ç¡®è®¤APIè°ƒç”¨æˆåŠŸ
   - éªŒè¯JWT tokenç”Ÿæˆå’Œè¿”å›

3. **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼š
   - æµ‹è¯•ç”¨æˆ·æ‹’ç»æˆæƒçš„æƒ…å†µ
   - æµ‹è¯•ç½‘ç»œé”™è¯¯çš„å¤„ç†
   - æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨çš„æƒ…å†µ

### 5ï¸âƒ£ æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. **å¾®ä¿¡å°ç¨‹åºé…ç½®**ï¼šéœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æ­£ç¡®çš„æœåŠ¡å™¨åŸŸå
2. **HTTPSè¦æ±‚**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
3. **ç”¨æˆ·åˆ›å»º**ï¼šç”¨æˆ·éœ€è¦å…ˆåœ¨ç®¡ç†åå°åˆ›å»ºï¼Œå°ç¨‹åºåªèƒ½ç™»å½•ä¸èƒ½æ³¨å†Œ
4. **æƒé™æ§åˆ¶**ï¼šå°ç¨‹åºç”¨æˆ·åªèƒ½æ˜¯å¸æœºæˆ–é”€å”®è§’è‰²
5. **è®¾å¤‡ç»‘å®š**ï¼šMACåœ°å€éªŒè¯å¯ä»¥å¢å¼ºå®‰å…¨æ€§ï¼Œä½†ä¸æ˜¯å¿…éœ€çš„

è¿™æ ·å°±å®Œæˆäº†å®Œæ•´çš„å¾®ä¿¡å°ç¨‹åºæˆæƒç™»å½•æµç¨‹ï¼
