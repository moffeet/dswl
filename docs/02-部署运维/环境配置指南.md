# âš™ï¸ ç¯å¢ƒé…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†ç‰©æµé…é€ç®¡ç†ç³»ç»Ÿåœ¨ä¸åŒç¯å¢ƒä¸‹çš„é…ç½®æ–¹æ³•ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„æ­å»ºå’Œé…ç½®ã€‚

## ğŸ› ï¸ åŸºç¡€ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux/macOS/Windows
- **Node.js**: >= 18.18.0 (æ¨è v20.x)
- **npm**: >= 8.0.0
- **MySQL**: >= 5.7 æˆ– 8.0+
- **Git**: >= 2.0

### ç¡¬ä»¶è¦æ±‚

#### å¼€å‘ç¯å¢ƒ
- **CPU**: 2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Š
- **ç£ç›˜**: 20GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥

#### ç”Ÿäº§ç¯å¢ƒ
- **CPU**: 4æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 8GBä»¥ä¸Š
- **ç£ç›˜**: 100GBå¯ç”¨ç©ºé—´ï¼ˆåŒ…å«æ—¥å¿—å’Œä¸Šä¼ æ–‡ä»¶å­˜å‚¨ï¼‰
- **ç½‘ç»œ**: é«˜é€Ÿç¨³å®šçš„ç½‘ç»œè¿æ¥

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### 1. Node.js ç¯å¢ƒé…ç½®

#### å®‰è£… Node.js
```bash
# ä½¿ç”¨ nvm å®‰è£…ï¼ˆæ¨èï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# å®‰è£…å¹¶ä½¿ç”¨ Node.js 20
nvm install 20
nvm use 20
nvm alias default 20

# éªŒè¯å®‰è£…
node --version  # åº”è¯¥æ˜¾ç¤º v20.x.x
npm --version   # åº”è¯¥æ˜¾ç¤º 10.x.x
```

#### é…ç½® npm é•œåƒï¼ˆå¯é€‰ï¼‰
```bash
# ä½¿ç”¨æ·˜å®é•œåƒåŠ é€Ÿ
npm config set registry https://registry.npmmirror.com/

# éªŒè¯é…ç½®
npm config get registry
```

### 2. MySQL æ•°æ®åº“é…ç½®

#### å®‰è£… MySQL
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# macOS (ä½¿ç”¨ Homebrew)
brew install mysql

# å¯åŠ¨ MySQL æœåŠ¡
sudo systemctl start mysql  # Linux
brew services start mysql   # macOS
```

#### é…ç½® MySQL
```bash
# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# ç™»å½• MySQL
mysql -u root -p

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE logistics_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'logistics_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON logistics_db.* TO 'logistics_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### MySQL é…ç½®ä¼˜åŒ–
ç¼–è¾‘ MySQL é…ç½®æ–‡ä»¶ `/etc/mysql/mysql.conf.d/mysqld.cnf`ï¼š
```ini
[mysqld]
# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# æ—¶åŒºé…ç½®
default-time-zone = '+08:00'

# æ€§èƒ½é…ç½®
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M

# æ—¥å¿—é…ç½®
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

### 3. é¡¹ç›®ç¯å¢ƒé…ç½®

#### å…‹éš†é¡¹ç›®
```bash
git clone <é¡¹ç›®ä»“åº“åœ°å€>
cd dswl1
```

#### åç«¯ç¯å¢ƒé…ç½®
```bash
cd backend-node

# å®‰è£…ä¾èµ–
npm install

# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env
```

ç¼–è¾‘ `backend-node/.env` æ–‡ä»¶ï¼š
```env
# æ•°æ®åº“é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USERNAME=root
DATABASE_PASSWORD=123456
DATABASE_NAME=logistics_db

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-here-dev
JWT_EXPIRES_IN=24h

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=development

# å°ç¨‹åºç­¾åå¯†é’¥
MINIPROGRAM_SIGNATURE_KEY=miniprogram-signature-key-dev-2024

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif

# æ—¥å¿—é…ç½®
LOG_LEVEL=debug
LOG_FILE_PATH=./logs/backend.log
```

#### å‰ç«¯ç¯å¢ƒé…ç½®
```bash
# ç®¡ç†åå°
cd admin-frontend
npm install
cp .env.example .env.local
```

ç¼–è¾‘ `admin-frontend/.env.local` æ–‡ä»¶ï¼š
```env
# APIé…ç½®
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000
NEXT_PUBLIC_APP_NAME=ç‰©æµé…é€ç®¡ç†ç³»ç»Ÿ

# å¼€å‘é…ç½®
NODE_ENV=development
```

```bash
# å°ç¨‹åºå‰ç«¯
cd ../frontend
npm install
cp .env.example .env.local
```

ç¼–è¾‘ `frontend/.env.local` æ–‡ä»¶ï¼š
```env
# APIé…ç½®
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000
NEXT_PUBLIC_APP_NAME=ç‰©æµé…é€å°ç¨‹åº

# åœ°å›¾é…ç½®
NEXT_PUBLIC_MAP_API_KEY=your_amap_api_key

# å¼€å‘é…ç½®
NODE_ENV=development
```

### 4. æ•°æ®åº“åˆå§‹åŒ–
```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# å¯¼å…¥æ•°æ®åº“ç»“æ„å’Œåˆå§‹æ•°æ®
mysql -u root -p logistics_db < init.sql
```

### 5. å¯åŠ¨å¼€å‘æœåŠ¡
```bash
# ä½¿ç”¨æœåŠ¡ç®¡ç†è„šæœ¬å¯åŠ¨æ‰€æœ‰æœåŠ¡
./ser.sh start all

# æˆ–è€…åˆ†åˆ«å¯åŠ¨å„ä¸ªæœåŠ¡
./ser.sh start backend   # å¯åŠ¨åç«¯æœåŠ¡
./ser.sh start admin     # å¯åŠ¨ç®¡ç†åå°
./ser.sh start frontend  # å¯åŠ¨å°ç¨‹åºå‰ç«¯

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./ser.sh status
```

## ğŸ§ª æµ‹è¯•ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®
æµ‹è¯•ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š

```bash
# åç«¯æµ‹è¯•ç¯å¢ƒé…ç½®
cp backend-node/.env backend-node/.env.test
```

ç¼–è¾‘ `.env.test` æ–‡ä»¶ï¼š
```env
NODE_ENV=test
DATABASE_NAME=logistics_db_test
JWT_SECRET=test-jwt-secret-key
MINIPROGRAM_SIGNATURE_KEY=test-signature-key
LOG_LEVEL=info
```

### 2. æµ‹è¯•æ•°æ®åº“é…ç½®
```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®åº“
CREATE DATABASE logistics_db_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON logistics_db_test.* TO 'logistics_user'@'localhost';
```

### 3. è¿è¡Œæµ‹è¯•
```bash
# åç«¯å•å…ƒæµ‹è¯•
cd backend-node
npm run test

# å‰ç«¯æµ‹è¯•
cd ../admin-frontend
npm run test

cd ../frontend
npm run test
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½®

### 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

#### ç³»ç»Ÿé…ç½®
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…å¿…è¦å·¥å…·
sudo apt install -y curl wget git vim htop

# é…ç½®é˜²ç«å¢™
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw allow 3000  # åç«¯API
sudo ufw allow 3001  # ç®¡ç†åå°
sudo ufw allow 3002  # å°ç¨‹åºå‰ç«¯
sudo ufw enable
```

#### åˆ›å»ºåº”ç”¨ç”¨æˆ·
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash logistics
sudo usermod -aG sudo logistics

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - logistics
```

### 2. ç”Ÿäº§ç¯å¢ƒå˜é‡é…ç½®

#### åç«¯ç”Ÿäº§é…ç½®
```env
# æ•°æ®åº“é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USERNAME=logistics_user
DATABASE_PASSWORD=your_strong_password
DATABASE_NAME=logistics_db

# JWTé…ç½®
JWT_SECRET=your-super-strong-jwt-secret-for-production
JWT_EXPIRES_IN=24h

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=production

# å°ç¨‹åºç­¾åå¯†é’¥
MINIPROGRAM_SIGNATURE_KEY=production-signature-key-2024

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FILE_PATH=/var/log/logistics/backend.log

# å®‰å…¨é…ç½®
CORS_ORIGIN=https://yourdomain.com
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW=900000
```

#### å‰ç«¯ç”Ÿäº§é…ç½®
```env
# ç®¡ç†åå°
NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com
NEXT_PUBLIC_APP_NAME=ç‰©æµé…é€ç®¡ç†ç³»ç»Ÿ
NODE_ENV=production

# å°ç¨‹åºå‰ç«¯
NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com
NEXT_PUBLIC_APP_NAME=ç‰©æµé…é€å°ç¨‹åº
NEXT_PUBLIC_MAP_API_KEY=your_production_map_api_key
NODE_ENV=production
```

### 3. è¿›ç¨‹ç®¡ç†é…ç½®

#### ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹
```bash
# å®‰è£… PM2
npm install -g pm2

# åˆ›å»º PM2 é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [
    {
      name: 'logistics-backend',
      script: 'dist/main.js',
      cwd: './backend-node',
      instances: 2,
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      }
    },
    {
      name: 'logistics-admin',
      script: 'npm',
      args: 'start',
      cwd: './admin-frontend',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      }
    },
    {
      name: 'logistics-frontend',
      script: 'npm',
      args: 'start',
      cwd: './frontend',
      env: {
        NODE_ENV: 'production',
        PORT: 3002
      }
    }
  ]
};
EOF

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜ PM2 é…ç½®
pm2 save
pm2 startup
```

### 4. Nginx åå‘ä»£ç†é…ç½®
```nginx
# /etc/nginx/sites-available/logistics
server {
    listen 80;
    server_name yourdomain.com;
    
    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    
    # SSL é…ç½®
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # åç«¯ API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # ç®¡ç†åå°
    location /admin {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # å°ç¨‹åºå‰ç«¯
    location / {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # é™æ€æ–‡ä»¶
    location /uploads {
        alias /path/to/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5. æ—¥å¿—ç®¡ç†é…ç½®
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/logistics
sudo chown logistics:logistics /var/log/logistics

# é…ç½® logrotate
sudo cat > /etc/logrotate.d/logistics << EOF
/var/log/logistics/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 logistics logistics
    postrotate
        pm2 reload all
    endscript
}
EOF
```

## ğŸ” ç¯å¢ƒéªŒè¯

### 1. æœåŠ¡å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./ser.sh status

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep :3000
netstat -tlnp | grep :3001
netstat -tlnp | grep :3002

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node
```

### 2. API æ¥å£æµ‹è¯•
```bash
# æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# æµ‹è¯• API æ–‡æ¡£
curl http://localhost:3000/api

# æµ‹è¯•å‰ç«¯é¡µé¢
curl http://localhost:3001
curl http://localhost:3002
```

### 3. æ•°æ®åº“è¿æ¥æµ‹è¯•
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u logistics_user -p -h localhost logistics_db -e "SELECT 1;"
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **ç«¯å£è¢«å ç”¨**: ä½¿ç”¨ `lsof -i :ç«¯å£å·` æŸ¥æ‰¾å ç”¨è¿›ç¨‹
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€å’Œé…ç½®
3. **æƒé™é—®é¢˜**: æ£€æŸ¥æ–‡ä»¶å’Œç›®å½•æƒé™
4. **ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ**: é‡å¯æœåŠ¡æˆ–é‡æ–°åŠ è½½é…ç½®

### æ—¥å¿—æŸ¥çœ‹
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/backend.log
tail -f logs/admin.log
tail -f logs/frontend.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u mysql
sudo journalctl -u nginx
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [éƒ¨ç½²å¯åŠ¨æŒ‡å—](./éƒ¨ç½²å¯åŠ¨æŒ‡å—.md) äº†è§£è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤å’Œé…ç½®ã€‚
