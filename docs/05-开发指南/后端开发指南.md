# ğŸ› ï¸ åç«¯å¼€å‘æŒ‡å—

## ğŸ“‹ æŠ€æœ¯æ ˆæ¦‚è¿°

### æ ¸å¿ƒæ¡†æ¶
- **NestJS 10.x**: ä¼ä¸šçº§Node.jsæ¡†æ¶ï¼ŒåŸºäºTypeScript
- **TypeScript 5.x**: å¼ºç±»å‹è¯­è¨€ï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒ
- **TypeORM 0.3.x**: å¼ºå¤§çš„ORMæ¡†æ¶ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“
- **MySQL 8.0**: å…³ç³»å‹æ•°æ®åº“ï¼Œç¨³å®šå¯é 

### ä¸»è¦ä¾èµ–
- **@nestjs/jwt**: JWTè®¤è¯æ”¯æŒ
- **@nestjs/swagger**: APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- **@nestjs/typeorm**: TypeORMé›†æˆ
- **bcrypt**: å¯†ç åŠ å¯†
- **multer**: æ–‡ä»¶ä¸Šä¼ å¤„ç†
- **class-validator**: æ•°æ®éªŒè¯
- **class-transformer**: æ•°æ®è½¬æ¢

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
backend-node/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.module.ts              # åº”ç”¨ä¸»æ¨¡å—
â”‚   â”œâ”€â”€ main.ts                    # åº”ç”¨å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ auth/                      # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”œâ”€â”€ signature.service.ts   # ç­¾åéªŒè¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ guards/               # è®¤è¯å®ˆå«
â”‚   â”œâ”€â”€ users/                     # ç”¨æˆ·ç®¡ç†æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”‚   â”œâ”€â”€ users.service.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”œâ”€â”€ customers/                 # å®¢æˆ·ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ wx-users/                  # å°ç¨‹åºç”¨æˆ·æ¨¡å—
â”‚   â”œâ”€â”€ receipts/                  # ç­¾æ”¶å•æ¨¡å—
â”‚   â”œâ”€â”€ miniprogram/               # å°ç¨‹åºæ¥å£æ¨¡å—
â”‚   â”œâ”€â”€ common/                    # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ decorators/           # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ filters/              # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ interceptors/         # æ‹¦æˆªå™¨
â”‚   â”‚   â”œâ”€â”€ pipes/                # ç®¡é“
â”‚   â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”œâ”€â”€ uploads/                       # æ–‡ä»¶ä¸Šä¼ ç›®å½•
â”œâ”€â”€ logs/                          # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®
åˆ›å»º `.env` æ–‡ä»¶ï¼š
```env
# æ•°æ®åº“é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USERNAME=root
DATABASE_PASSWORD=123456
DATABASE_NAME=logistics_db

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-here
JWT_EXPIRES_IN=24h

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=development

# å°ç¨‹åºç­¾åå¯†é’¥
MINIPROGRAM_SIGNATURE_KEY=miniprogram-signature-key-2024

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif
```

### 2. æ•°æ®åº“é…ç½®
```typescript
// src/config/database.config.ts
import { TypeOrmModuleOptions } from '@nestjs/typeorm';

export const databaseConfig: TypeOrmModuleOptions = {
  type: 'mysql',
  host: process.env.DATABASE_HOST || 'localhost',
  port: parseInt(process.env.DATABASE_PORT) || 3306,
  username: process.env.DATABASE_USERNAME || 'root',
  password: process.env.DATABASE_PASSWORD || '123456',
  database: process.env.DATABASE_NAME || 'logistics_db',
  entities: [__dirname + '/../**/*.entity{.ts,.js}'],
  synchronize: false, // ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºfalse
  logging: ['query', 'error', 'warn'],
  timezone: '+08:00',
  charset: 'utf8mb4',
};
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:dev

# å¯åŠ¨è°ƒè¯•æ¨¡å¼
npm run start:debug
```

## ğŸ“ æ¨¡å—å¼€å‘è§„èŒƒ

### 1. æ¨¡å—ç»“æ„
æ¯ä¸ªåŠŸèƒ½æ¨¡å—åº”åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š
```
module-name/
â”œâ”€â”€ module-name.module.ts          # æ¨¡å—å®šä¹‰
â”œâ”€â”€ module-name.controller.ts      # æ§åˆ¶å™¨
â”œâ”€â”€ module-name.service.ts         # æœåŠ¡å±‚
â”œâ”€â”€ entities/                      # å®ä½“å®šä¹‰
â”‚   â””â”€â”€ module-name.entity.ts
â”œâ”€â”€ dto/                          # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ create-module-name.dto.ts
â”‚   â”œâ”€â”€ update-module-name.dto.ts
â”‚   â””â”€â”€ query-module-name.dto.ts
â””â”€â”€ interfaces/                   # æ¥å£å®šä¹‰
    â””â”€â”€ module-name.interface.ts
```

### 2. å®ä½“å®šä¹‰è§„èŒƒ
```typescript
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';

@Entity('t_example')
export class Example {
  @ApiProperty({ description: 'ID', example: 1 })
  @PrimaryGeneratedColumn({ comment: 'ID' })
  id: number;

  @ApiProperty({ description: 'åç§°', example: 'ç¤ºä¾‹åç§°' })
  @Column({ length: 100, comment: 'åç§°' })
  name: string;

  @ApiProperty({ description: 'æ˜¯å¦åˆ é™¤', example: 0 })
  @Column({ name: 'is_deleted', type: 'tinyint', width: 1, default: 0, comment: 'æ˜¯å¦åˆ é™¤ï¼š0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤' })
  isDeleted: number;

  @ApiProperty({ description: 'åˆ›å»ºæ—¶é—´' })
  @CreateDateColumn({ name: 'create_time', comment: 'åˆ›å»ºæ—¶é—´' })
  createTime: Date;

  @ApiProperty({ description: 'æ›´æ–°æ—¶é—´' })
  @UpdateDateColumn({ name: 'update_time', comment: 'æ›´æ–°æ—¶é—´' })
  updateTime: Date;
}
```

### 3. DTOå®šä¹‰è§„èŒƒ
```typescript
import { ApiProperty } from '@nestjs/swagger';
import { IsString, IsNotEmpty, IsOptional, MaxLength } from 'class-validator';

export class CreateExampleDto {
  @ApiProperty({ description: 'åç§°', example: 'ç¤ºä¾‹åç§°' })
  @IsString()
  @IsNotEmpty()
  @MaxLength(100)
  name: string;

  @ApiProperty({ description: 'æè¿°', example: 'ç¤ºä¾‹æè¿°', required: false })
  @IsString()
  @IsOptional()
  @MaxLength(500)
  description?: string;
}
```

### 4. æ§åˆ¶å™¨è§„èŒƒ
```typescript
import { Controller, Get, Post, Body, Patch, Param, Delete, Query, UseGuards } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';

@ApiTags('ç¤ºä¾‹æ¨¡å—')
@Controller('examples')
@UseGuards(JwtAuthGuard)
@ApiBearerAuth()
export class ExampleController {
  constructor(private readonly exampleService: ExampleService) {}

  @Post()
  @ApiOperation({ summary: 'åˆ›å»ºç¤ºä¾‹' })
  @ApiResponse({ status: 201, description: 'åˆ›å»ºæˆåŠŸ' })
  @ApiResponse({ status: 400, description: 'å‚æ•°é”™è¯¯' })
  async create(@Body() createExampleDto: CreateExampleDto) {
    try {
      const result = await this.exampleService.create(createExampleDto);
      return {
        code: 200,
        message: 'åˆ›å»ºæˆåŠŸ',
        data: result
      };
    } catch (error) {
      return {
        code: 500,
        message: error.message || 'åˆ›å»ºå¤±è´¥',
        data: null
      };
    }
  }
}
```

### 5. æœåŠ¡å±‚è§„èŒƒ
```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CustomLogger } from '../common/logger/custom-logger';

@Injectable()
export class ExampleService {
  private readonly logger = new CustomLogger('ExampleService');

  constructor(
    @InjectRepository(Example)
    private exampleRepository: Repository<Example>,
  ) {}

  async create(createExampleDto: CreateExampleDto): Promise<Example> {
    try {
      this.logger.log(`åˆ›å»ºç¤ºä¾‹ - æ•°æ®: ${JSON.stringify(createExampleDto)}`);
      
      const example = this.exampleRepository.create(createExampleDto);
      const result = await this.exampleRepository.save(example);
      
      this.logger.log(`åˆ›å»ºç¤ºä¾‹æˆåŠŸ - ID: ${result.id}`);
      return result;
    } catch (error) {
      this.logger.error(`åˆ›å»ºç¤ºä¾‹å¤±è´¥: ${error.message}`, error.stack);
      throw error;
    }
  }

  async findOne(id: number): Promise<Example> {
    const example = await this.exampleRepository.findOne({
      where: { id, isDeleted: 0 }
    });

    if (!example) {
      throw new NotFoundException('ç¤ºä¾‹ä¸å­˜åœ¨');
    }

    return example;
  }
}
```

## ğŸ” è®¤è¯å’Œæˆæƒ

### 1. JWTè®¤è¯ç­–ç•¥
```typescript
// src/auth/jwt.strategy.ts
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: process.env.JWT_SECRET,
    });
  }

  async validate(payload: any) {
    return {
      userId: payload.sub,
      username: payload.username,
      role: payload.role,
    };
  }
}
```

### 2. æƒé™å®ˆå«
```typescript
// src/auth/guards/permissions.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class PermissionsGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredPermissions = this.reflector.getAllAndOverride<string[]>('permissions', [
      context.getHandler(),
      context.getClass(),
    ]);

    if (!requiredPermissions) {
      return true;
    }

    const { user } = context.switchToHttp().getRequest();
    return requiredPermissions.some((permission) => user.permissions?.includes(permission));
  }
}
```

### 3. ç­¾åéªŒè¯å®ˆå«
```typescript
// src/auth/guards/signature.guard.ts
import { Injectable, CanActivate, ExecutionContext, UnauthorizedException } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { SignatureService } from '../signature.service';

@Injectable()
export class SignatureGuard implements CanActivate {
  constructor(
    private signatureService: SignatureService,
    private reflector: Reflector,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requireSignature = this.reflector.getAllAndOverride<boolean>('requireSignature', [
      context.getHandler(),
      context.getClass(),
    ]);

    if (!requireSignature) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const params = { ...request.query, ...request.body };

    // éªŒè¯ç­¾å
    const isValid = await this.signatureService.validateRequest(params);
    if (!isValid) {
      throw new UnauthorizedException('ç­¾åéªŒè¯å¤±è´¥');
    }

    return true;
  }
}
```

## ğŸ“Š æ•°æ®åº“æ“ä½œ

### 1. åŸºç¡€CRUDæ“ä½œ
```typescript
// æŸ¥è¯¢åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
async findAll(queryDto: QueryDto) {
  const { page = 1, limit = 10, search } = queryDto;
  
  const queryBuilder = this.repository
    .createQueryBuilder('entity')
    .where('entity.isDeleted = :isDeleted', { isDeleted: 0 });

  if (search) {
    queryBuilder.andWhere('entity.name LIKE :search', { search: `%${search}%` });
  }

  const [list, total] = await queryBuilder
    .orderBy('entity.updateTime', 'DESC')
    .skip((page - 1) * limit)
    .take(limit)
    .getManyAndCount();

  return { list, total, page, limit };
}

// è½¯åˆ é™¤
async remove(id: number): Promise<void> {
  await this.repository.update(id, { isDeleted: 1 });
}

// æ‰¹é‡åˆ é™¤
async batchRemove(ids: number[]): Promise<void> {
  await this.repository.update(ids, { isDeleted: 1 });
}
```

### 2. å¤æ‚æŸ¥è¯¢
```typescript
// å…³è”æŸ¥è¯¢
async findWithRelations(id: number) {
  return this.repository.findOne({
    where: { id, isDeleted: 0 },
    relations: ['user', 'customer'],
  });
}

// ç»Ÿè®¡æŸ¥è¯¢
async getStats() {
  const result = await this.repository
    .createQueryBuilder('entity')
    .select([
      'COUNT(*) as total',
      'COUNT(CASE WHEN DATE(entity.createTime) = CURDATE() THEN 1 END) as today',
      'COUNT(CASE WHEN YEAR(entity.createTime) = YEAR(NOW()) AND MONTH(entity.createTime) = MONTH(NOW()) THEN 1 END) as thisMonth'
    ])
    .where('entity.isDeleted = :isDeleted', { isDeleted: 0 })
    .getRawOne();

  return {
    total: parseInt(result.total),
    today: parseInt(result.today),
    thisMonth: parseInt(result.thisMonth),
  };
}
```

## ğŸ“ æ–‡ä»¶ä¸Šä¼ å¤„ç†

### 1. æ–‡ä»¶ä¸Šä¼ é…ç½®
```typescript
// src/common/config/upload.config.ts
import { MulterOptions } from '@nestjs/platform-express/multer/interfaces/multer-options.interface';
import { diskStorage } from 'multer';
import { extname, join } from 'path';

export const uploadConfig: MulterOptions = {
  storage: diskStorage({
    destination: (req, file, cb) => {
      const uploadPath = join(process.cwd(), 'uploads', 'receipts');
      cb(null, uploadPath);
    },
    filename: (req, file, cb) => {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
      cb(null, `${file.fieldname}-${uniqueSuffix}${extname(file.originalname)}`);
    },
  }),
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
  },
  fileFilter: (req, file, cb) => {
    if (!file.mimetype.match(/\/(jpg|jpeg|png|gif)$/)) {
      cb(new Error('åªæ”¯æŒå›¾ç‰‡æ ¼å¼'), false);
    } else {
      cb(null, true);
    }
  },
};
```

### 2. æ–‡ä»¶ä¸Šä¼ å¤„ç†
```typescript
@Post('upload')
@UseInterceptors(FileInterceptor('file', uploadConfig))
async uploadFile(
  @UploadedFile() file: Express.Multer.File,
  @Body() uploadDto: UploadDto,
) {
  if (!file) {
    throw new BadRequestException('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
  }

  // ç”Ÿæˆæ–‡ä»¶URL
  const fileUrl = `${req.protocol}://${req.get('host')}/uploads/${file.filename}`;
  
  // ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“
  const result = await this.service.saveFileInfo({
    ...uploadDto,
    filePath: file.path,
    fileUrl: fileUrl,
    fileName: file.originalname,
    fileSize: file.size,
  });

  return {
    code: 200,
    message: 'ä¸Šä¼ æˆåŠŸ',
    data: result,
  };
}
```

## ğŸ” æ—¥å¿—å’Œç›‘æ§

### 1. è‡ªå®šä¹‰æ—¥å¿—æœåŠ¡
```typescript
// src/common/logger/custom-logger.ts
import { Injectable, LoggerService } from '@nestjs/common';

@Injectable()
export class CustomLogger implements LoggerService {
  constructor(private context?: string) {}

  log(message: string, context?: string) {
    const timestamp = new Date().toISOString();
    const ctx = context || this.context || 'Application';
    console.log(`${timestamp} [LOG] [${ctx}] ${message}`);
  }

  error(message: string, trace?: string, context?: string) {
    const timestamp = new Date().toISOString();
    const ctx = context || this.context || 'Application';
    console.error(`${timestamp} [ERROR] [${ctx}] ${message}`);
    if (trace) {
      console.error(trace);
    }
  }

  warn(message: string, context?: string) {
    const timestamp = new Date().toISOString();
    const ctx = context || this.context || 'Application';
    console.warn(`${timestamp} [WARN] [${ctx}] ${message}`);
  }

  debug(message: string, context?: string) {
    const timestamp = new Date().toISOString();
    const ctx = context || this.context || 'Application';
    console.debug(`${timestamp} [DEBUG] [${ctx}] ${message}`);
  }
}
```

### 2. å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
```typescript
// src/common/filters/http-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus } from '@nestjs/common';
import { CustomLogger } from '../logger/custom-logger';

@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  private readonly logger = new CustomLogger('ExceptionFilter');

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    const status = exception instanceof HttpException 
      ? exception.getStatus() 
      : HttpStatus.INTERNAL_SERVER_ERROR;

    const message = exception instanceof HttpException 
      ? exception.getResponse() 
      : 'Internal server error';

    this.logger.error(
      `HTTP ${status} Error: ${JSON.stringify(message)}`,
      exception instanceof Error ? exception.stack : undefined,
    );

    response.status(status).json({
      code: status,
      message: typeof message === 'string' ? message : (message as any).message,
      data: null,
      timestamp: new Date().toISOString(),
      path: request.url,
    });
  }
}
```

## ğŸ§ª æµ‹è¯•

### 1. å•å…ƒæµ‹è¯•
```typescript
// src/users/users.service.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { UsersService } from './users.service';
import { User } from './entities/user.entity';

describe('UsersService', () => {
  let service: UsersService;
  let repository: Repository<User>;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        UsersService,
        {
          provide: getRepositoryToken(User),
          useValue: {
            create: jest.fn(),
            save: jest.fn(),
            findOne: jest.fn(),
            find: jest.fn(),
          },
        },
      ],
    }).compile();

    service = module.get<UsersService>(UsersService);
    repository = module.get<Repository<User>>(getRepositoryToken(User));
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('should create a user', async () => {
    const createUserDto = { username: 'test', password: 'password' };
    const user = { id: 1, ...createUserDto };

    jest.spyOn(repository, 'create').mockReturnValue(user as User);
    jest.spyOn(repository, 'save').mockResolvedValue(user as User);

    expect(await service.create(createUserDto)).toEqual(user);
  });
});
```

### 2. é›†æˆæµ‹è¯•
```typescript
// test/app.e2e-spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/health (GET)', () => {
    return request(app.getHttpServer())
      .get('/health')
      .expect(200)
      .expect('OK');
  });
});
```

## ğŸ“¦ éƒ¨ç½²å’Œæ„å»º

### 1. æ„å»ºå‘½ä»¤
```bash
# å¼€å‘ç¯å¢ƒ
npm run start:dev

# ç”Ÿäº§ç¯å¢ƒæ„å»º
npm run build

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
npm run start:prod
```

### 2. Dockeréƒ¨ç½²
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY dist ./dist
COPY uploads ./uploads

EXPOSE 3000

CMD ["node", "dist/main"]
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [å‰ç«¯å¼€å‘æŒ‡å—](./frontend-guide.md) äº†è§£å‰ç«¯å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µã€‚
