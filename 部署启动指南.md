# 物流配送管理系统 - 部署启动指南

## 项目概述

本项目是基于微信小程序 + 管理后台的物流配送管理系统，包含：
- **后端服务**：NestJS + MySQL + Redis
- **管理后台**：Next.js + React + Arco Design + TailwindCSS  
- **小程序前端**：Next.js + React + TailwindCSS

## 环境要求

### 必需软件
- **Node.js**: 18.18.0 或更高版本（推荐 20.x）
- **npm**: 8.0.0 或更高版本
- **MySQL**: 5.7+ 或 8.0+
- **Git**: 用于代码管理

### 可选工具
- **nvm**: Node.js 版本管理工具（推荐）
- **Redis**: 缓存服务（可选）

## 环境配置

### 1. Node.js 环境配置

#### 使用 nvm 安装 Node.js（推荐）
```bash
# 安装 nvm（如果未安装）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载 shell 配置
source ~/.zshrc

# 安装 Node.js 20
nvm install 20

# 设置为默认版本
nvm alias default 20

# 使用 Node.js 20
nvm use 20

# 验证版本
node --version  # 应显示 v20.x.x
npm --version   # 应显示 10.x.x
```

### 2. 数据库配置

#### 创建数据库用户和数据库
```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库（如果不存在）
CREATE DATABASE IF NOT EXISTS delivery_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选，也可使用 root）
CREATE USER 'delivery_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON delivery_system.* TO 'delivery_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 初始化数据库结构
```bash
# 执行数据库初始化脚本
mysql -u root -p delivery_system < init.sql
```

### 3. 环境变量配置（可选）

在 `backend-node` 目录下创建 `.env` 文件：
```bash
# 数据库配置
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USERNAME=root
DATABASE_PASSWORD=123456
DATABASE_NAME=delivery_system

# 应用端口
PORT=3000

# JWT 密钥（生产环境请修改）
JWT_SECRET=your_jwt_secret_key
```

## 项目部署步骤

### 1. 克隆项目代码
```bash
git clone <项目仓库地址>
cd wlxt
```

### 2. 安装后端依赖
```bash
cd backend-node
npm install
```

### 3. 安装前端依赖
```bash
# 安装管理后台依赖
cd ../admin-frontend
npm install

# 安装小程序前端依赖
cd ../frontend
npm install
```

### 4. 编译后端代码
```bash
cd ../backend-node
npm run build
```

## 启动方式

### 方式一：使用启动脚本（推荐）

#### 开发环境启动
```bash
# 在项目根目录执行
./start-dev.sh
```

#### 生产环境启动
```bash
# 在项目根目录执行
./start-prod.sh
```

### 方式二：手动启动

#### 开发环境
```bash
# 终端1：启动后端服务
cd backend-node
npm run start:dev

# 终端2：启动管理后台
cd admin-frontend  
npm run dev -- --port 3001

# 终端3：启动小程序前端
cd frontend
npm run dev -- --port 3002
```

#### 生产环境
```bash
# 终端1：启动后端服务
cd backend-node
npm run build
npm start

# 终端2：启动管理后台
cd admin-frontend
npm run build
npm start -- --port 3001

# 终端3：启动小程序前端  
cd frontend
npm run build
npm start -- --port 3002
```

## 服务地址

启动成功后，可通过以下地址访问：

| 服务 | 地址 | 说明 |
|------|------|------|
| **后端API** | http://localhost:3000 | 后端服务主地址 |
| **API文档** | http://localhost:3000/api | Swagger API文档 |
| **健康检查** | http://localhost:3000/health | 服务健康状态 |
| **管理后台** | http://localhost:3001 | 管理员操作界面 |
| **小程序前端** | http://localhost:3002 | 小程序开发预览 |

## 默认账号

### 管理后台登录
- **用户名**: `admin`
- **密码**: `admin123`

### 测试司机账号
系统预置了3个测试司机账号：
- 张三：13800000001
- 李四：13800000002  
- 王五：13800000003

## 常见问题解决

### 1. Node.js 版本错误
```bash
# 错误信息：You are using Node.js 16.x.x. For Next.js, Node.js version "^18.18.0 || ^19.8.0 || >= 20.0.0" is required.

# 解决方案：使用nvm升级
nvm install 20
nvm use 20
nvm alias default 20

# 验证版本
node --version  # 应显示 v20.x.x
```

### 2. 端口被占用问题
```bash
# 查看端口占用详情
lsof -i :3000 -i :3001 -i :3002

# 批量清理所有相关端口
lsof -ti :3000 | xargs kill -9 2>/dev/null || true
lsof -ti :3001 | xargs kill -9 2>/dev/null || true  
lsof -ti :3002 | xargs kill -9 2>/dev/null || true

# 清理Node.js相关进程
pkill -f "npm run dev" 2>/dev/null || true
pkill -f "npm run start:dev" 2>/dev/null || true
pkill -f "next dev" 2>/dev/null || true
pkill -f "ts-node" 2>/dev/null || true
```

### 3. 数据库连接失败
```bash
# 检查 MySQL 服务状态
brew services list | grep mysql

# 启动 MySQL 服务  
brew services start mysql

# 测试数据库连接
mysql -u root -p123456 -e "SELECT 1;" 2>/dev/null && echo "数据库连接正常" || echo "数据库连接失败"

# 执行初始化脚本
mysql -u root -p123456 delivery_system < init.sql
```

### 4. 依赖安装失败
```bash
# 方案1：清理缓存重新安装
rm -rf node_modules package-lock.json
npm cache clean --force
npm install

# 方案2：使用国内镜像
npm config set registry https://registry.npmmirror.com
npm install

# 方案3：跳过可选依赖
npm install --no-optional
```

### 5. 代理设置问题
```bash
# 临时取消代理（推荐）
unset http_proxy
unset https_proxy
unset all_proxy

# 永久取消代理（添加到 ~/.zshrc）
echo 'unset http_proxy https_proxy all_proxy' >> ~/.zshrc
source ~/.zshrc

# 使用国内镜像
npm config set registry https://registry.npmmirror.com
```

### 6. 前端服务启动失败
```bash
# 错误：sh: next: command not found
cd admin-frontend
rm -rf node_modules package-lock.json  
npm install
npm run dev -- --port 3001

# 错误：Failed to start server EADDRINUSE
# 使用端口清理命令后重试
./stop-dev.sh
./start-dev.sh
```

### 7. 后端服务启动失败
```bash
# 错误：Cannot find module '../lib/cli'
cd backend-node
rm -rf node_modules package-lock.json
npm install
npm run build
npm start

# 错误：nodemon相关问题
# 使用编译后的代码直接启动
npm run build
PORT=3000 node dist/main.js
```

## 生产环境部署建议

### 1. 使用 PM2 管理进程
```bash
# 安装 PM2
npm install -g pm2

# 使用 PM2 启动后端
cd backend-node
pm2 start npm --name "wlxt-backend" -- start

# 使用 PM2 启动前端
cd admin-frontend
pm2 start npm --name "wlxt-admin" -- start -- --port 3001

cd frontend  
pm2 start npm --name "wlxt-frontend" -- start -- --port 3002
```

### 2. 配置 Nginx 反向代理
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 后端 API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 管理后台
    location /admin {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 小程序前端
    location / {
        proxy_pass http://localhost:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 环境变量配置
生产环境建议使用环境变量管理配置：
```bash
export NODE_ENV=production
export DATABASE_PASSWORD=your_secure_password
export JWT_SECRET=your_secure_jwt_secret
```

## 监控和日志

### 查看应用日志
```bash
# PM2 日志
pm2 logs

# 实时查看特定应用日志
pm2 logs wlxt-backend --lines 100
```

### 性能监控
```bash
# PM2 监控面板
pm2 monit

# 查看应用状态
pm2 status
```

## 故障排除流程

### 完整重置流程

如果遇到无法解决的问题，可以按以下步骤完整重置：

```bash
# 1. 完全停止所有服务
./stop-dev.sh

# 2. 清理所有Node.js进程
pkill -f node 2>/dev/null || true

# 3. 清理所有依赖和缓存
rm -rf backend-node/node_modules backend-node/package-lock.json
rm -rf admin-frontend/node_modules admin-frontend/package-lock.json  
rm -rf frontend/node_modules frontend/package-lock.json
npm cache clean --force

# 4. 重新设置Node.js版本
nvm install 20
nvm use 20
nvm alias default 20

# 5. 取消所有代理设置
unset http_proxy https_proxy all_proxy

# 6. 重新启动
./start-dev.sh
```

### 逐步检查清单

当遇到启动问题时，请按以下清单逐项检查：

- [ ] Node.js 版本 >= 20.0.0
- [ ] MySQL 服务已启动
- [ ] 数据库 delivery_system 已创建
- [ ] 端口 3000, 3001, 3002 未被占用
- [ ] 网络代理已关闭
- [ ] npm 缓存已清理
- [ ] 所有 node_modules 已重新安装

### 日志查看

启动失败时，请查看相应日志：

```bash
# 查看后端启动日志
cat logs/backend.log

# 查看管理后台启动日志  
cat logs/admin.log

# 查看小程序前端启动日志
cat logs/frontend.log

# 实时监控日志
tail -f logs/*.log
```

### 启动脚本功能详解

系统提供的启动脚本具有以下功能：

**start-dev.sh**:
- 自动检查Node.js版本和环境依赖
- 清理端口和进程冲突
- 智能安装项目依赖（跳过已安装）
- 按顺序启动所有服务
- 生成详细的启动日志

**stop-dev.sh**:
- 停止所有开发服务
- 清理端口占用和残留进程
- 最终状态检查和清理

---

**注意**：首次部署前请确保已正确配置数据库连接参数，并执行了数据库初始化脚本。 