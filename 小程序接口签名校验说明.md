# 小程序接口签名校验说明

## 📋 概述

为了保证小程序接口的安全性，防止恶意请求和重放攻击，所有小程序接口都需要进行签名校验。

## 🔐 签名算法

### 签名方式
- **算法**: HMAC-SHA256
- **密钥**: 每个用户有独立的签名密钥
- **参数排序**: 按字典序排列所有参数
- **时间戳验证**: 5分钟有效期
- **防重放**: nonce机制

### 签名流程

1. **收集参数**: 收集所有请求参数（包括body和query参数）
2. **添加签名参数**:
   - `timestamp`: 当前时间戳（毫秒）
   - `nonce`: 随机字符串（至少8位）
   - `wxUserId`: 小程序用户ID
3. **参数排序**: 按参数名字典序排序
4. **拼接字符串**: 格式为 `key1=value1&key2=value2&...`
5. **生成签名**: 使用HMAC-SHA256算法生成签名
6. **添加到请求**: 将签名添加到请求参数中

## 📝 签名参数说明

### 必需参数

| 参数名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `wxUserId` | number | 小程序用户ID | 1 |
| `timestamp` | string | 时间戳（毫秒） | "1704387123456" |
| `nonce` | string | 随机数（≥8位） | "abc123def456" |
| `signature` | string | 签名值 | "a1b2c3d4e5f6..." |

### 参数说明

- **wxUserId**: 用于获取用户的签名密钥
- **timestamp**: 用于防止请求过期（5分钟有效期）
- **nonce**: 用于防止重放攻击（每个nonce只能使用一次）
- **signature**: 使用HMAC-SHA256算法生成的签名

## 🛠️ 前端实现示例

### JavaScript 签名生成

```javascript
const crypto = require('crypto');

/**
 * 生成签名
 * @param {Object} params 请求参数
 * @param {string} secretKey 签名密钥
 * @returns {string} 签名值
 */
function generateSignature(params, secretKey) {
  // 1. 过滤掉signature参数
  const filteredParams = { ...params };
  delete filteredParams.signature;

  // 2. 按参数名字典序排序
  const sortedKeys = Object.keys(filteredParams).sort();
  
  // 3. 拼接参数字符串
  const paramString = sortedKeys
    .map(key => {
      const value = filteredParams[key];
      if (value === null || value === undefined) {
        return `${key}=`;
      }
      if (typeof value === 'object') {
        return `${key}=${JSON.stringify(value)}`;
      }
      return `${key}=${value}`;
    })
    .join('&');

  // 4. 生成签名
  return crypto
    .createHmac('sha256', secretKey)
    .update(paramString)
    .digest('hex');
}

/**
 * 生成随机nonce
 * @param {number} length 长度
 * @returns {string} 随机字符串
 */
function generateNonce(length = 16) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// 使用示例
const params = {
  wxUserId: 1,
  customerNumber: 'C001',
  timestamp: Date.now().toString(),
  nonce: generateNonce()
};

// 假设从服务器获取的用户签名密钥
const secretKey = 'user_signature_key_here';

// 生成签名
params.signature = generateSignature(params, secretKey);

// 发送请求
fetch('/api/miniprogram/customers/search', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  },
  body: new URLSearchParams(params)
});
```

## 📱 接口使用示例

### 1. 客户搜索接口

```http
GET /api/miniprogram/customers/search?customerNumber=C001&wxUserId=1&timestamp=1704387123456&nonce=abc123def456&signature=a1b2c3d4e5f6...
```

### 2. 签收单上传接口

```http
POST /api/miniprogram/receipts/upload
Content-Type: multipart/form-data

wxUserId=1
timestamp=1704387123456
nonce=abc123def456
signature=a1b2c3d4e5f6...
wxUserName=张三
customerName=深圳科技有限公司
file=[图片文件]
```

### 3. 打卡上传接口

```http
POST /api/miniprogram/checkins/upload
Content-Type: multipart/form-data

wxUserId=1
timestamp=1704387123456
nonce=abc123def456
signature=a1b2c3d4e5f6...
wxUserName=张三
customerName=深圳科技有限公司
file=[图片文件]
```

### 4. 客户信息更新接口

```http
PATCH /api/miniprogram/customers/update
Content-Type: application/json

{
  "wxUserId": 1,
  "timestamp": "1704387123456",
  "nonce": "abc123def456",
  "signature": "a1b2c3d4e5f6...",
  "operatorName": "张三",
  "customerNumber": "C001",
  "storeAddress": "深圳市南山区科技园南区A座",
  "warehouseAddress": "深圳市南山区科技园南区B座"
}
```

## ⚠️ 错误处理

### 常见错误码

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 401 | 缺少签名参数 | 缺少timestamp、nonce或signature参数 |
| 401 | 时间戳格式无效 | timestamp不是有效的数字 |
| 401 | 请求已过期 | 请求时间超过5分钟 |
| 401 | nonce长度不能少于8位 | nonce参数太短 |
| 401 | 请求重复，nonce已被使用 | 重放攻击检测 |
| 401 | 签名验证失败 | 签名不匹配 |
| 401 | 用户不存在 | wxUserId对应的用户不存在 |

### 错误响应示例

```json
{
  "code": 401,
  "message": "签名校验失败: 请求已过期，时间差: 320秒",
  "data": null
}
```

## 🔧 开发调试

### 获取用户签名密钥

用户的签名密钥由系统自动生成，规则为：
```
HMAC-SHA256(基础密钥, "user_" + 用户ID)
```

基础密钥可通过环境变量 `MINIPROGRAM_SIGNATURE_KEY` 配置，默认为 `miniprogram-signature-key-2024`。

### 调试工具

可以使用以下工具验证签名：
1. 在线HMAC-SHA256计算器
2. Node.js crypto模块
3. 浏览器开发者工具

## 📚 安全建议

1. **密钥管理**: 签名密钥应妥善保管，不要在客户端硬编码
2. **时间同步**: 确保客户端时间与服务器时间同步
3. **HTTPS**: 生产环境必须使用HTTPS传输
4. **日志监控**: 监控签名验证失败的请求，及时发现异常
5. **密钥轮换**: 定期更换签名密钥以提高安全性
