# å°ç¨‹åºæ¥å£ç­¾åæ ¡éªŒè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

ä¸ºäº†ä¿è¯å°ç¨‹åºæ¥å£çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚å’Œé‡æ”¾æ”»å‡»ï¼Œæ‰€æœ‰å°ç¨‹åºæ¥å£éƒ½éœ€è¦è¿›è¡Œç­¾åæ ¡éªŒã€‚

## ğŸ” ç­¾åç®—æ³•

### ç­¾åæ–¹å¼
- **ç®—æ³•**: HMAC-SHA256
- **å¯†é’¥**: æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ç­¾åå¯†é’¥
- **å‚æ•°æ’åº**: æŒ‰å­—å…¸åºæ’åˆ—æ‰€æœ‰å‚æ•°
- **æ—¶é—´æˆ³éªŒè¯**: 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
- **é˜²é‡æ”¾**: nonceæœºåˆ¶

### ç­¾åæµç¨‹

1. **æ”¶é›†å‚æ•°**: æ”¶é›†æ‰€æœ‰è¯·æ±‚å‚æ•°ï¼ˆåŒ…æ‹¬bodyå’Œqueryå‚æ•°ï¼‰
2. **æ·»åŠ ç­¾åå‚æ•°**:
   - `timestamp`: å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
   - `nonce`: éšæœºå­—ç¬¦ä¸²ï¼ˆè‡³å°‘8ä½ï¼‰
   - `wxUserId`: å°ç¨‹åºç”¨æˆ·ID
3. **å‚æ•°æ’åº**: æŒ‰å‚æ•°åå­—å…¸åºæ’åº
4. **æ‹¼æ¥å­—ç¬¦ä¸²**: æ ¼å¼ä¸º `key1=value1&key2=value2&...`
5. **ç”Ÿæˆç­¾å**: ä½¿ç”¨HMAC-SHA256ç®—æ³•ç”Ÿæˆç­¾å
6. **æ·»åŠ åˆ°è¯·æ±‚**: å°†ç­¾åæ·»åŠ åˆ°è¯·æ±‚å‚æ•°ä¸­

## ğŸ“ ç­¾åå‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°

| å‚æ•°å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `wxUserId` | number | å°ç¨‹åºç”¨æˆ·ID | 1 |
| `timestamp` | string | æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | "1704387123456" |
| `nonce` | string | éšæœºæ•°ï¼ˆâ‰¥8ä½ï¼‰ | "abc123def456" |
| `signature` | string | ç­¾åå€¼ | "a1b2c3d4e5f6..." |

### å‚æ•°è¯´æ˜

- **wxUserId**: ç”¨äºè·å–ç”¨æˆ·çš„ç­¾åå¯†é’¥
- **timestamp**: ç”¨äºé˜²æ­¢è¯·æ±‚è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- **nonce**: ç”¨äºé˜²æ­¢é‡æ”¾æ”»å‡»ï¼ˆæ¯ä¸ªnonceåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼‰
- **signature**: ä½¿ç”¨HMAC-SHA256ç®—æ³•ç”Ÿæˆçš„ç­¾å

## ğŸ› ï¸ å‰ç«¯å®ç°ç¤ºä¾‹

### JavaScript ç­¾åç”Ÿæˆ

```javascript
const crypto = require('crypto');

/**
 * ç”Ÿæˆç­¾å
 * @param {Object} params è¯·æ±‚å‚æ•°
 * @param {string} secretKey ç­¾åå¯†é’¥
 * @returns {string} ç­¾åå€¼
 */
function generateSignature(params, secretKey) {
  // 1. è¿‡æ»¤æ‰signatureå‚æ•°
  const filteredParams = { ...params };
  delete filteredParams.signature;

  // 2. æŒ‰å‚æ•°åå­—å…¸åºæ’åº
  const sortedKeys = Object.keys(filteredParams).sort();
  
  // 3. æ‹¼æ¥å‚æ•°å­—ç¬¦ä¸²
  const paramString = sortedKeys
    .map(key => {
      const value = filteredParams[key];
      if (value === null || value === undefined) {
        return `${key}=`;
      }
      if (typeof value === 'object') {
        return `${key}=${JSON.stringify(value)}`;
      }
      return `${key}=${value}`;
    })
    .join('&');

  // 4. ç”Ÿæˆç­¾å
  return crypto
    .createHmac('sha256', secretKey)
    .update(paramString)
    .digest('hex');
}

/**
 * ç”Ÿæˆéšæœºnonce
 * @param {number} length é•¿åº¦
 * @returns {string} éšæœºå­—ç¬¦ä¸²
 */
function generateNonce(length = 16) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// ä½¿ç”¨ç¤ºä¾‹
const params = {
  wxUserId: 1,
  customerNumber: 'C001',
  timestamp: Date.now().toString(),
  nonce: generateNonce()
};

// å‡è®¾ä»æœåŠ¡å™¨è·å–çš„ç”¨æˆ·ç­¾åå¯†é’¥
const secretKey = 'user_signature_key_here';

// ç”Ÿæˆç­¾å
params.signature = generateSignature(params, secretKey);

// å‘é€è¯·æ±‚
fetch('/api/miniprogram/customers/search', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  },
  body: new URLSearchParams(params)
});
```

## ğŸ“± æ¥å£ä½¿ç”¨ç¤ºä¾‹

### 1. å®¢æˆ·æœç´¢æ¥å£

```http
GET /api/miniprogram/customers/search?customerNumber=C001&wxUserId=1&timestamp=1704387123456&nonce=abc123def456&signature=a1b2c3d4e5f6...
```

### 2. ç­¾æ”¶å•ä¸Šä¼ æ¥å£

```http
POST /api/miniprogram/receipts/upload
Content-Type: multipart/form-data

wxUserId=1
timestamp=1704387123456
nonce=abc123def456
signature=a1b2c3d4e5f6...
wxUserName=å¼ ä¸‰
customerName=æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸
file=[å›¾ç‰‡æ–‡ä»¶]
```

### 3. æ‰“å¡ä¸Šä¼ æ¥å£

```http
POST /api/miniprogram/checkins/upload
Content-Type: multipart/form-data

wxUserId=1
timestamp=1704387123456
nonce=abc123def456
signature=a1b2c3d4e5f6...
wxUserName=å¼ ä¸‰
customerName=æ·±åœ³ç§‘æŠ€æœ‰é™å…¬å¸
file=[å›¾ç‰‡æ–‡ä»¶]
```

### 4. å®¢æˆ·ä¿¡æ¯æ›´æ–°æ¥å£

```http
PATCH /api/miniprogram/customers/update
Content-Type: application/json

{
  "wxUserId": 1,
  "timestamp": "1704387123456",
  "nonce": "abc123def456",
  "signature": "a1b2c3d4e5f6...",
  "operatorName": "å¼ ä¸‰",
  "customerNumber": "C001",
  "storeAddress": "æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºAåº§",
  "warehouseAddress": "æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—åŒºBåº§"
}
```

## âš ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | è¯´æ˜ |
|--------|----------|------|
| 401 | ç¼ºå°‘ç­¾åå‚æ•° | ç¼ºå°‘timestampã€nonceæˆ–signatureå‚æ•° |
| 401 | æ—¶é—´æˆ³æ ¼å¼æ— æ•ˆ | timestampä¸æ˜¯æœ‰æ•ˆçš„æ•°å­— |
| 401 | è¯·æ±‚å·²è¿‡æœŸ | è¯·æ±‚æ—¶é—´è¶…è¿‡5åˆ†é’Ÿ |
| 401 | nonceé•¿åº¦ä¸èƒ½å°‘äº8ä½ | nonceå‚æ•°å¤ªçŸ­ |
| 401 | è¯·æ±‚é‡å¤ï¼Œnonceå·²è¢«ä½¿ç”¨ | é‡æ”¾æ”»å‡»æ£€æµ‹ |
| 401 | ç­¾åéªŒè¯å¤±è´¥ | ç­¾åä¸åŒ¹é… |
| 401 | ç”¨æˆ·ä¸å­˜åœ¨ | wxUserIdå¯¹åº”çš„ç”¨æˆ·ä¸å­˜åœ¨ |

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
  "code": 401,
  "message": "ç­¾åæ ¡éªŒå¤±è´¥: è¯·æ±‚å·²è¿‡æœŸï¼Œæ—¶é—´å·®: 320ç§’",
  "data": null
}
```

## ğŸ”§ å¼€å‘è°ƒè¯•

### è·å–ç”¨æˆ·ç­¾åå¯†é’¥

ç”¨æˆ·çš„ç­¾åå¯†é’¥ç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œè§„åˆ™ä¸ºï¼š
```
HMAC-SHA256(åŸºç¡€å¯†é’¥, "user_" + ç”¨æˆ·ID)
```

åŸºç¡€å¯†é’¥å¯é€šè¿‡ç¯å¢ƒå˜é‡ `MINIPROGRAM_SIGNATURE_KEY` é…ç½®ï¼Œé»˜è®¤ä¸º `miniprogram-signature-key-2024`ã€‚

### è°ƒè¯•å·¥å…·

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·éªŒè¯ç­¾åï¼š
1. åœ¨çº¿HMAC-SHA256è®¡ç®—å™¨
2. Node.js cryptoæ¨¡å—
3. æµè§ˆå™¨å¼€å‘è€…å·¥å…·

## ğŸ“š å®‰å…¨å»ºè®®

1. **å¯†é’¥ç®¡ç†**: ç­¾åå¯†é’¥åº”å¦¥å–„ä¿ç®¡ï¼Œä¸è¦åœ¨å®¢æˆ·ç«¯ç¡¬ç¼–ç 
2. **æ—¶é—´åŒæ­¥**: ç¡®ä¿å®¢æˆ·ç«¯æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´åŒæ­¥
3. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPSä¼ è¾“
4. **æ—¥å¿—ç›‘æ§**: ç›‘æ§ç­¾åéªŒè¯å¤±è´¥çš„è¯·æ±‚ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸
5. **å¯†é’¥è½®æ¢**: å®šæœŸæ›´æ¢ç­¾åå¯†é’¥ä»¥æé«˜å®‰å…¨æ€§
