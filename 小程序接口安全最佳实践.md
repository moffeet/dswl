# 小程序接口安全最佳实践

## 🚨 安全风险与防护

### 1. 签名密钥管理

#### ❌ 不安全的做法
- 通过HTTP接口直接返回完整密钥
- 在前端代码中硬编码密钥
- 将密钥存储在客户端本地存储
- 在日志中记录完整密钥
- 在版本控制系统中提交密钥文件

#### ✅ 安全的做法
- **环境隔离**：开发/测试/生产环境使用不同的密钥
- **权限控制**：密钥获取需要管理员权限验证
- **环境检查**：生产环境禁用密钥获取接口
- **密钥掩码**：返回部分隐藏的密钥用于验证
- **访问日志**：记录所有密钥访问行为
- **定期轮换**：定期更换签名密钥

### 2. 开发环境安全配置

#### 当前实现的安全措施

1. **环境检查**
   ```javascript
   // 仅开发环境允许获取密钥
   if (environment === 'production') {
     return { code: 403, message: '生产环境禁止获取用户签名密钥' };
   }
   ```

2. **动态密钥管理**
   - **动态生成**：基于用户ID和基础密钥动态生成，无需维护配置文件
   - **自动获取**：测试工具自动调用API获取密钥，支持任意用户ID
   - **手动获取**：带安全警告的手动获取方式，用于特殊情况

3. **用户体验优化**
   - **静默获取**：选择用户时自动获取密钥，无需手动操作
   - **消息提示**：使用页面提示替代弹窗，提升用户体验
   - **错误处理**：完善的错误提示和日志记录

### 3. 生产环境部署建议

#### 环境变量配置
```bash
# 生产环境
NODE_ENV=production
MINIPROGRAM_SIGNATURE_KEY=your-production-base-key

# 开发环境
NODE_ENV=development
MINIPROGRAM_SIGNATURE_KEY=your-development-base-key
```

#### 服务器配置
```nginx
# Nginx配置 - 禁止访问敏感文件
location ~ \.(key|secret|json)$ {
    deny all;
    return 404;
}

# 禁止访问开发工具
location ~ ^/(miniprogram-test\.html|dev-keys\.json|api-test\.html)$ {
    deny all;
    return 404;
}
```

### 4. 密钥生成与轮换

#### 密钥生成算法
```javascript
// 当前实现
function getUserSignatureKey(userId) {
  const baseKey = process.env.MINIPROGRAM_SIGNATURE_KEY;
  return createHmac('sha256', baseKey).update(`user_${userId}`).digest('hex');
}
```

#### 密钥轮换策略
1. **定期轮换**：建议每3-6个月轮换一次基础密钥
2. **紧急轮换**：发现密钥泄露时立即轮换
3. **版本管理**：支持多版本密钥并存，平滑过渡

### 5. 监控与审计

#### 访问日志
```javascript
console.log(`[SECURITY] 开发环境密钥访问 - 用户ID: ${userId}, 时间: ${new Date().toISOString()}`);
```

#### 异常监控
- 监控生产环境的密钥获取尝试
- 记录签名验证失败的请求
- 检测异常的nonce重复使用

### 6. 客户端安全

#### 小程序端建议
```javascript
// 不要在小程序中存储密钥
// 密钥应该从安全的后端服务获取
async function getSignatureKey() {
  // 通过安全的认证接口获取
  const response = await wx.request({
    url: 'https://your-secure-api/get-signature-key',
    header: {
      'Authorization': 'Bearer ' + userToken
    }
  });
  return response.data.key;
}
```

## 🔧 开发工具安全使用指南

### 1. 测试工具使用
- ✅ 仅在开发环境使用
- ✅ 不要在生产数据库上测试
- ✅ 测试完成后清理敏感数据
- ❌ 不要截图包含完整密钥的界面
- ❌ 不要在公共网络上使用

### 2. 配置文件管理
```json
// dev-keys.json - 已加入.gitignore
{
  "warning": "此文件包含敏感信息，仅供开发环境使用",
  "users": {
    "1": { "secretKey": "..." }
  }
}
```

### 3. 团队协作
- 每个开发者使用独立的开发环境
- 不要共享个人的密钥配置文件
- 使用统一的开发环境配置模板

## 📋 安全检查清单

### 部署前检查
- [ ] 生产环境禁用密钥获取接口
- [ ] 移除或禁用开发测试工具
- [ ] 验证环境变量配置正确
- [ ] 检查.gitignore包含敏感文件
- [ ] 确认日志不包含敏感信息

### 定期安全审计
- [ ] 检查密钥访问日志
- [ ] 验证签名验证成功率
- [ ] 监控异常请求模式
- [ ] 评估密钥轮换需求

## 🚀 最佳实践总结

1. **分层防护**：多种密钥获取方式，适应不同场景
2. **环境隔离**：严格区分开发和生产环境
3. **权限最小化**：仅必要的人员可访问敏感信息
4. **监控审计**：完整的访问日志和异常监控
5. **定期维护**：密钥轮换和安全配置更新

通过这些安全措施，我们可以在保证开发效率的同时，最大程度地保护系统安全。
